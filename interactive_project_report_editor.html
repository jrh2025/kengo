<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式報告編輯器 (v7.9 - 新增還原功能)</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Core Styles -->
    <style id="core-styles">
        /* --- THEME DEFINITIONS --- */
        :root, [data-theme="default"] {
            --font-main: 'Noto Sans TC', sans-serif; --bg-color: #f4f4f5; --card-bg-color: #ffffff; --text-color-primary: #18181b; --text-color-secondary: #52525b; --accent-color: #0ea5e9; --accent-color-dark: #0284c7; --accent-color-subtle: #e0f2fe; --border-color: #e4e4e7;
        }
        [data-theme="dark"] {
            --font-main: 'Noto Sans TC', sans-serif; --bg-color: #18181b; --card-bg-color: #27272a; --text-color-primary: #f4f4f5; --text-color-secondary: #a1a1aa; --accent-color: #60a5fa; --accent-color-dark: #3b82f6; --accent-color-subtle: #1e293b; --border-color: #3f3f46;
        }
        [data-theme="academic"] {
            --font-main: 'Noto Serif TC', serif; --bg-color: #fdfdfe; --card-bg-color: #ffffff; --text-color-primary: #111827; --text-color-secondary: #4b5563; --accent-color: #4f46e5; --accent-color-dark: #4338ca; --accent-color-subtle: #eef2ff; --border-color: #d1d5db;
        }

        /* --- BASE ELEMENT STYLES --- */
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color-secondary); transition: background-color 0.3s, color 0.3s; }
        h1, h2, h3, h4, h5, h6 { color: var(--text-color-primary); }
        .accent-text { color: var(--accent-color-dark); }
        .card { background-color: var(--card-bg-color); border-color: var(--border-color); }
        .button-primary { background-color: var(--accent-color); color: white; }
        .button-primary:hover { background-color: var(--accent-color-dark); }
        .chart-container { position: relative; width: 100%; max-width: 400px; margin: auto; height: auto; max-height: 400px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .input-error { border-color: #ef4444; }

        /* --- EDITING UI STYLES --- */
        [contenteditable="true"] { outline: 2px dashed var(--accent-color); outline-offset: 2px; cursor: text; }
        [contenteditable="true"]:hover, [contenteditable="true"]:focus { background-color: var(--accent-color-subtle); }
        .edit-controls { display: none; }
        .edit-mode .edit-controls { display: flex; }
    </style>
    
    <!-- Layout Styles: This tag will be dynamically populated by JavaScript -->
    <style id="layout-styles"></style>
</head>
<body data-theme="default">

    <!-- Main Toolbar -->
    <div id="toolbar" class="fixed top-4 right-4 z-50 bg-white/80 backdrop-blur-sm p-3 rounded-lg shadow-xl border flex flex-col gap-3">
        <button id="editModeBtn" class="w-full px-4 py-2 text-sm font-semibold bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition">進入編輯模式</button>
        
        <div class="relative">
            <select id="layoutSwitcher" class="w-full appearance-none px-4 py-2 text-sm font-semibold bg-gray-100 text-gray-800 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500">
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
            </div>
        </div>

        <button id="exportBtn" class="w-full px-4 py-2 text-sm font-semibold bg-zinc-600 text-white rounded-md hover:bg-zinc-700 transition">匯出 HTML 報告</button>
        
        <button id="insert-code-btn" class="edit-controls w-full px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">插入程式碼</button>
        
        <a id="helpBtn" href="#" class="w-full text-center px-4 py-2 text-sm font-semibold bg-green-600 text-white rounded-md hover:bg-green-700 transition">使用教學</a>
        
        <!-- NEW: Reset Button -->
        <button id="resetBtn" class="w-full px-4 py-2 text-sm font-semibold bg-red-600 text-white rounded-md hover:bg-red-700 transition">還原預設內容</button>
    </div>

    <!-- Chart Edit Modal -->
    <div id="chartModal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <h3 class="text-2xl font-bold mb-6">編輯圖表資料</h3>
            <div id="chartForm" class="space-y-4 max-h-80 overflow-y-auto pr-2"></div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancelChartEdit" class="px-4 py-2 text-sm font-semibold bg-zinc-200 rounded-md hover:bg-zinc-300 transition">取消</button>
                <button id="saveChartEdit" class="button-primary px-4 py-2 text-sm font-semibold rounded-md transition">儲存變更</button>
            </div>
        </div>
    </div>
    
    <!-- Main Report Container -->
    <div id="report-container">
        <header class="text-center">
            <h1 data-editable data-state-key="mainTitle" class="text-3xl md:text-5xl font-bold mb-2">智慧影片裁切工具的演進歷程</h1>
            <p data-editable data-state-key="mainSubtitle" class="text-lg md:text-xl">從一個想法到一個實用工具的完整開發之旅</p>
        </header>
        
        <section id="intro">
            <div class="grid md:grid-cols-5 gap-8 md:gap-12 items-center">
                <div class="md:col-span-3 text-base md:text-lg">
                    <h2 data-editable data-state-key="introTitle" class="text-2xl font-bold mb-4 accent-text">創作理念</h2>
                    <p data-editable data-state-key="introP1" class="mb-4">本專案的起點源於一個明確且實際的需求：將帶有黑邊的垂直影片，自動轉換為符合社群媒體標準的 9:16 格式。我們的創作理念是：<b>不僅僅是完成任務，而是要打造一個穩健、智慧且易於使用的工具</b>。一個真正實用的解決方案，必須能應對真實世界中各種不可預期的影片瑕疵，並且最終能讓非技術背景的使用者也能無礙使用。</p>
                    <p data-editable data-state-key="introP2">這份報告將帶您回顧這段充滿挑戰與突破的開發旅程。</p>
                </div>
                <div class="md:col-span-2">
                    <div class="chart-container relative">
                        <canvas id="complexityChart"></canvas>
                        <div class="edit-controls absolute inset-0 flex items-center justify-center">
                             <button id="editChartBtn" class="px-4 py-2 bg-black bg-opacity-50 text-white text-sm rounded-md hover:bg-opacity-70 transition">編輯圖表</button>
                        </div>
                    </div>
                    <p data-editable data-state-key="chartCaption" class="text-center text-sm mt-2">圖表：各開發階段複雜度與投入心力分佈</p>
                </div>
            </div>
        </section>
        
        <section id="journey">
            <h2 data-editable data-state-key="journeyTitle" class="text-3xl font-bold text-center">開發之旅：四個關鍵階段</h2>
            <div id="journey-content-container">
            </div>
            <div class="flex justify-center mt-8">
                <button id="addPhaseBtn" class="edit-controls button-primary px-4 py-2 rounded-md transition text-sm font-semibold">＋ 新增階段</button>
            </div>
        </section>
        
        <section id="conclusion" class="text-center">
            <h2 data-editable data-state-key="conclusionTitle" class="text-3xl font-bold mb-8">總結與展望</h2>
            <div class="max-w-3xl mx-auto text-lg space-y-4">
                <p data-editable data-state-key="conclusionP1">本專案的歷程，是從一個具體的自動化需求出發，透過嚴謹的工程方法、診斷導向的迭代開發，以及對使用者體驗的持續關注，最終將一個簡單的腳本，昇華為一個穩健、通用且易於分發的桌面應用程式的典範。</p>
                <p data-editable data-state-key="conclusionP2">這次合作充分展現了現代軟體開發的精髓：快速驗證、持續迭代、人機協作。這個工具不僅解決了最初的問題，其模組化的程式碼與穩健的演算法，也為未來擴充更多影片處理功能（如自動上字幕、濾鏡批次處理等）奠定了堅實的基礎。</p>
            </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- CONSTANTS AND DEFINITIONS ---
        const STORAGE_KEY = 'interactiveReportState_v7.9';

        const LAYOUTS = {
            'timeline': {
                name: '經典時間軸',
                css: `
                    #report-container { max-width: 56rem; margin: auto; padding: 3rem 2rem; }
                    #report-container > * { margin-bottom: 5rem; }
                    .timeline-container { position: relative; max-width: 40rem; margin: auto; }
                    .timeline-line { position: absolute; left: 1rem; top: 0; bottom: 0; width: 2px; background-color: var(--border-color); }
                    @media (min-width: 768px) { .timeline-line { left: 50%; transform: translateX(-50%); } }
                    .timeline-item { position: relative; margin-bottom: 3rem; }
                    .timeline-item-content-wrapper { margin-left: 3rem; }
                    .timeline-dot { position: absolute; left: 1rem; top: 0.5rem; transform: translateX(-50%); width: 1.75rem; height: 1.75rem; background-color: var(--card-bg-color); border: 3px solid var(--accent-color); border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--accent-color); transition: transform 0.2s; cursor: pointer; }
                    .timeline-item:hover .timeline-dot { transform: translateX(-50%) scale(1.1); }
                    .timeline-item-content { max-height: 0; overflow: hidden; opacity: 0; transition: all 0.5s ease-in-out; }
                    .timeline-item.active .timeline-item-content { max-height: 2000px; opacity: 1; margin-top: 1rem; }
                    @media (min-width: 768px) {
                        .timeline-item-content-wrapper { width: 50%; padding-left: 2.5rem; }
                        .timeline-item:nth-child(even) .timeline-item-content-wrapper { margin-left: 50%; padding-left: 0; padding-right: 2.5rem; text-align: right; }
                        .timeline-dot { left: 50%; }
                    }
                `
            },
            'grid': {
                name: '現代網格卡片',
                css: `
                    #report-container { max-width: 80rem; margin: auto; padding: 3rem 2rem; }
                    #report-container > * { margin-bottom: 5rem; }
                    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
                    .grid-item .card { height: 100%; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; border-radius: 0.75rem; border: 1px solid var(--border-color); }
                    .grid-item .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
                    .grid-item-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
                    .grid-item-content { padding: 1.5rem; flex-grow: 1; }
                `
            },
            'split': {
                name: '極簡左右分欄',
                css: `
                    #report-container { max-width: 80rem; margin: auto; padding: 3rem 2rem; }
                    #report-container > * { margin-bottom: 5rem; }
                    .split-container { display: flex; flex-direction: column; gap: 2rem; }
                    .split-nav { border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; background-color: var(--card-bg-color); }
                    .split-nav-list { list-style: none; padding: 0; margin: 0; }
                    .split-nav-item button { width: 100%; text-align: left; padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
                    .split-nav-item button.active { background-color: var(--accent-color-subtle); color: var(--accent-color-dark); }
                    .split-nav-item button:not(.active):hover { background-color: var(--bg-color); }
                    .split-content { scroll-margin-top: 8rem; }
                    .split-content-item { display: none; }
                    .split-content-item.active { display: block; }
                    @media (min-width: 768px) {
                        .split-container { flex-direction: row; align-items: flex-start; }
                        .split-nav { position: sticky; top: 6rem; width: 250px; flex-shrink: 0; }
                        .split-content { flex-grow: 1; }
                    }
                `
            },
            'magazine': {
                name: '雜誌風格',
                css: `
                    #report-container { max-width: 80rem; margin: auto; padding: 3rem 2rem; }
                    #report-container > * { margin-bottom: 5rem; }
                    .magazine-container { display: grid; grid-template-columns: repeat(6, 1fr); grid-auto-rows: minmax(150px, auto); gap: 1.5rem; }
                    .magazine-item .card { height: 100%; border-radius: 0.5rem; border: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; transition: all 0.3s ease; }
                    .magazine-item .card:hover { transform: scale(1.02); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
                    .magazine-item:nth-child(5n+1) { grid-column: span 3; grid-row: span 2; }
                    .magazine-item:nth-child(5n+2) { grid-column: span 3; }
                    .magazine-item:nth-child(5n+3) { grid-column: span 2; }
                    .magazine-item:nth-child(5n+4) { grid-column: span 2; }
                    .magazine-item:nth-child(5n+5) { grid-column: span 2; }
                    @media (max-width: 768px) {
                        .magazine-item:nth-child(n) { grid-column: span 6; grid-row: span 1; }
                    }
                `
            }
        };
        const THEMES = {
            'default': { name: '預設主題', palette: [ { bg: 'rgba(20, 184, 166, 0.7)', border: '#14b8a6' }, { bg: 'rgba(219, 39, 119, 0.7)', border: '#db2777' }, { bg: 'rgba(14, 165, 233, 0.7)', border: '#0ea5e9' }, { bg: 'rgba(99, 102, 241, 0.7)', border: '#6366f1' }, { bg: 'rgba(249, 115, 22, 0.7)', border: '#f97316' } ] },
            'dark': { name: '專業暗色', palette: [ { bg: 'rgba(59, 130, 246, 0.7)', border: '#3B82F6' }, { bg: 'rgba(168, 85, 247, 0.7)', border: '#A855F7' }, { bg: 'rgba(34, 197, 94, 0.7)', border: '#22C55E' }, { bg: 'rgba(239, 68, 68, 0.7)', border: '#EF4444' }, { bg: 'rgba(245, 158, 11, 0.7)', border: '#F59E0B' } ] },
            'academic': { name: '學術論文', palette: [ { bg: 'rgba(79, 70, 229, 0.7)', border: '#4F46E5' }, { bg: 'rgba(21, 128, 61, 0.7)', border: '#15803D' }, { bg: 'rgba(190, 24, 93, 0.7)', border: '#BE185D' }, { bg: 'rgba(217, 119, 6, 0.7)', border: '#D97706' }, { bg: 'rgba(0, 0, 0, 0.6)', border: '#000000' } ] }
        };
        const SANITIZE_CONFIG = {
            ALLOWED_TAGS: ['b', 'i', 'u', 'em', 'strong', 'a', 'p', 'br', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'div', 'span', 'pre', 'code'],
            ALLOWED_ATTR: ['href', 'target', 'rel', 'class', 'style']
        };

        // --- STATE MANAGEMENT ---
        const state = {
            editMode: false, activeLayout: 'timeline', activeTheme: 'default',
            chartInstance: null, mainContent: {}, chartData: { datasets: [{}] },
            timelineData: [], activePhaseId: null
        };

        // --- UI ELEMENT REFERENCES ---
        const ui = {
            editModeBtn: document.getElementById('editModeBtn'),
            layoutSwitcher: document.getElementById('layoutSwitcher'),
            exportBtn: document.getElementById('exportBtn'),
            reportContainer: document.getElementById('report-container'),
            journeyContentContainer: document.getElementById('journey-content-container'),
            addPhaseBtn: document.getElementById('addPhaseBtn'),
            chartModal: document.getElementById('chartModal'),
            chartForm: document.getElementById('chartForm'),
            saveChartEditBtn: document.getElementById('saveChartEdit'),
            cancelChartEditBtn: document.getElementById('cancelChartEdit'),
            insertCodeBtn: document.getElementById('insert-code-btn'),
            helpBtn: document.getElementById('helpBtn'),
            resetBtn: document.getElementById('resetBtn'),
            layoutStylesTag: document.getElementById('layout-styles'),
            editChartBtn: document.getElementById('editChartBtn'),
        };

        // --- CORE FUNCTIONS ---

        function saveState() {
            try {
                const stateToSave = {
                    activeLayout: state.activeLayout, activeTheme: state.activeTheme,
                    mainContent: state.mainContent,
                    chartData: { labels: state.chartData.labels, datasets: [{ data: state.chartData.datasets[0].data }] },
                    timelineData: state.timelineData, activePhaseId: state.activePhaseId
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (e) { console.error("無法儲存狀態:", e); }
        }

        function loadState() {
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (savedState) {
                try {
                    const parsed = JSON.parse(savedState);
                    state.activeLayout = parsed.activeLayout || 'timeline';
                    state.activeTheme = parsed.activeTheme || 'default';
                    state.mainContent = parsed.mainContent || {};
                    if (parsed.chartData && parsed.chartData.labels && parsed.chartData.datasets[0].data) {
                        state.chartData.labels = parsed.chartData.labels;
                        state.chartData.datasets[0].data = parsed.chartData.datasets[0].data;
                    } else {
                        setDefaultState(); return;
                    }
                    state.timelineData = parsed.timelineData || [];
                    state.activePhaseId = parsed.activePhaseId;
                } catch (e) {
                    console.error("無法載入狀態, 將重置為預設值:", e);
                    localStorage.removeItem(STORAGE_KEY);
                    setDefaultState();
                }
            } else { setDefaultState(); }
        }

        function setDefaultState() {
            state.activeLayout = 'timeline';
            state.activeTheme = 'default';
            state.mainContent = {
                mainTitle: '智慧影片裁切工具的演進歷程',
                mainSubtitle: '從一個想法到一個實用工具的完整開發之旅',
                introTitle: '創作理念',
                introP1: '本專案的起點源於一個明確且實際的需求：將帶有黑邊的垂直影片，自動轉換為符合社群媒體標準的 9:16 格式。我們的創作理念是：<b>不僅僅是完成任務，而是要打造一個穩健、智慧且易於使用的工具</b>。一個真正實用的解決方案，必須能應對真實世界中各種不可預期的影片瑕疵，並且最終能讓非技術背景的使用者也能無礙使用。',
                introP2: '這份報告將帶您回顧這段充滿挑戰與突破的開發旅程。',
                chartCaption: '圖表：各開發階段複雜度與投入心力分佈',
                journeyTitle: '開發之旅：四個關鍵階段',
                conclusionTitle: '總結與展望',
                conclusionP1: '本專案的歷程，是從一個具體的自動化需求出發，透過嚴謹的工程方法、診斷導向的迭代開發，以及對使用者體驗的持續關注，最終將一個簡單的腳本，昇華為一個穩健、通用且易於分發的桌面應用程式的典範。',
                conclusionP2: '這次合作充分展現了現代軟體開發的精髓：快速驗證、持續迭代、人機協作。這個工具不僅解決了最初的問題，其模組化的程式碼與穩健的演算法，也為未來擴充更多影片處理功能（如自動上字幕、濾鏡批次處理等）奠定了堅實的基礎。',
            };
            state.chartData = {
                labels: ['階段一: PoC', '階段二: 演算法精煉', '階段三: GUI 開發', '階段四: 部署'],
                datasets: [{ label: '投入心力與複雜度 (%)', data: [10, 50, 30, 10], borderWidth: 1, hoverOffset: 8 }]
            };
            state.timelineData = [
                { id: `phase-${Date.now() + 1}`, title: '階段一：概念驗證 (PoC)', subtitle: '初版腳本的誕生，驗證技術可行性。', content: '<ul><li><strong>目標：</strong>快速驗證使用 Python 自動裁切影片的可行性。</li><li><strong>方法：</strong>採用 `OpenCV` 與 `MoviePy`，使用 `cv2.boundingRect` 函式進行初步的黑邊偵測。</li><li><strong>成果：</strong>成功產出第一版命令列腳本，證明技術路徑有效。</li><li><strong>挑戰：</strong>偵測邏輯相對脆弱，為後續的挑戰埋下伏筆。</li></ul>' },
                { id: `phase-${Date.now() + 2}`, title: '階段二：演算法精煉', subtitle: '邁向穩健的核心，應對真實世界的挑戰。', content: '<p>這是專案中最具挑戰性的階段。初步演算法在面對帶有浮水印與壓縮雜訊的真實影片時失效，促使我們進行了一系列診斷與演進。</p>' },
                { id: `phase-${Date.now() + 3}`, title: '階段三：使用者中心轉型', subtitle: '從命令列腳本到圖形化應用程式 (GUI)。', content: '<p>在核心演算法穩定後，我們將重心轉向易用性，目標是讓非開發者也能輕鬆使用。</p>' },
                { id: `phase-${Date.now() + 4}`, title: '階段四：部署與分發', subtitle: '讓工具觸手可及，打包成 .exe 執行檔。', content: '<p>最後一步是打破軟體執行的壁壘，讓任何人都能使用我們的創作。</p>' }
            ];
            state.activePhaseId = state.timelineData.length > 0 ? state.timelineData[0].id : null;
        }

        function applyTheme(themeName) {
            if (!THEMES[themeName]) themeName = 'default';
            state.activeTheme = themeName;
            document.body.dataset.theme = themeName;
            if (state.chartInstance) { renderChart(); }
            saveState();
        }

        function applyLayout(layoutName) {
            if (!LAYOUTS[layoutName]) return;
            state.activeLayout = layoutName;
            ui.layoutStylesTag.innerHTML = LAYOUTS[layoutName].css;
            renderJourneyContent();
            saveState();
        }
        
        function toggleEditableState() {
            document.body.classList.toggle('edit-mode', state.editMode);
            document.querySelectorAll('[data-editable], [data-editable-html]').forEach(el => {
                el.setAttribute('contenteditable', state.editMode);
            });
            ui.editModeBtn.textContent = state.editMode ? '預覽報告' : '進入編輯模式';
        }

        // --- RENDER FUNCTIONS ---
        
        function renderAll() {
            document.querySelectorAll('[data-editable][data-state-key]').forEach(el => {
                const key = el.getAttribute('data-state-key');
                if (state.mainContent[key]) {
                    el.innerHTML = DOMPurify.sanitize(state.mainContent[key]);
                }
            });
            renderJourneyContent();
            renderChart();
        }

        function renderJourneyContent() {
            const renderer = window.app.layoutRenderers[state.activeLayout];
            if (renderer) {
                renderer();
            }
            toggleEditableState();
        }

        function renderChart() {
            if (!document.getElementById('complexityChart')) return;
            const syncChartColors = () => {
                if (!state.chartData.labels) return;
                const palette = THEMES[state.activeTheme].palette;
                const colors = state.chartData.labels.map((_, index) => palette[index % palette.length]);
                state.chartData.datasets[0].backgroundColor = colors.map(c => c.bg);
                state.chartData.datasets[0].borderColor = colors.map(c => c.border);
            };
            syncChartColors();
            if (state.chartInstance) state.chartInstance.destroy();
            const ctx = document.getElementById('complexityChart').getContext('2d');
            state.chartInstance = new Chart(ctx, {
                type: 'doughnut', data: state.chartData,
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-color-secondary'), font: { family: getComputedStyle(document.body).getPropertyValue('--font-main') } } },
                        tooltip: { callbacks: { label: (c) => `${c.label || ''}: ${c.parsed || 0}%` } }
                    },
                    onClick: (e, el) => { if (el.length > 0 && !state.editMode) window.app.togglePhase(state.timelineData[el[0].index]?.id, true); }
                }
            });
        }
        
        // --- EVENT HANDLERS & APP LOGIC ---
        
        window.app = {
            layoutRenderers: {
                timeline: renderTimelineLayout,
                grid: renderGridLayout,
                split: renderSplitLayout,
                magazine: renderMagazineLayout,
            },
            togglePhase: (phaseId, shouldScroll = true) => {
                const oldActiveId = state.activePhaseId;
                state.activePhaseId = (oldActiveId === phaseId && state.activeLayout !== 'split') ? null : phaseId;
                if (state.activeLayout === 'split' && !state.activePhaseId) {
                    state.activePhaseId = oldActiveId;
                }
                document.querySelectorAll('.timeline-item, .split-content-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.phaseId === state.activePhaseId);
                });
                if(state.activeLayout === 'split') {
                    document.querySelectorAll('.split-nav-item button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.phaseId === state.activePhaseId);
                    });
                }
                if (shouldScroll && state.activePhaseId) {
                    const newActiveItem = document.querySelector(`.content-item[data-phase-id="${state.activePhaseId}"]`);
                    if (newActiveItem) {
                        setTimeout(() => newActiveItem.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                    }
                }
                saveState();
            }
        };

        // --- LAYOUT-SPECIFIC RENDERERS ---

        function renderTimelineLayout() {
            ui.journeyContentContainer.innerHTML = `
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${state.timelineData.map((phase, index) => `
                        <div class="timeline-item ${phase.id === state.activePhaseId ? 'active' : ''}" data-phase-id="${phase.id}">
                            <div class="timeline-dot" onclick="window.app.togglePhase('${phase.id}')">${index + 1}</div>
                            <div class="timeline-item-content-wrapper">
                                <div class="card p-6 rounded-lg shadow-md border">
                                    <h3 data-editable class="text-xl font-bold">${phase.title}</h3>
                                    <p data-editable class="mt-1">${phase.subtitle}</p>
                                    <div class="timeline-item-content content-item" data-phase-id="${phase.id}">
                                        <div data-editable-html class="prose max-w-none">${phase.content}</div>
                                    </div>
                                    <div class="edit-controls mt-4 justify-end gap-2">
                                        <button class="remove-phase-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" data-id="${phase.id}">移除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderGridLayout() {
            ui.journeyContentContainer.innerHTML = `
                <div class="grid-container">
                    ${state.timelineData.map(phase => `
                        <div class="grid-item content-item" data-phase-id="${phase.id}">
                             <div class="card rounded-lg shadow-md border">
                                <div class="grid-item-header">
                                    <h3 data-editable class="text-xl font-bold">${phase.title}</h3>
                                    <p data-editable class="mt-1">${phase.subtitle}</p>
                                </div>
                                <div class="grid-item-content">
                                    <div data-editable-html class="prose max-w-none">${phase.content}</div>
                                </div>
                                <div class="edit-controls p-4 mt-auto justify-end gap-2 border-t">
                                    <button class="remove-phase-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" data-id="${phase.id}">移除</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderSplitLayout() {
            if (!state.activePhaseId && state.timelineData.length > 0) {
                state.activePhaseId = state.timelineData[0].id;
            }
            ui.journeyContentContainer.innerHTML = `
                <div class="split-container">
                    <aside class="split-nav">
                        <ul class="split-nav-list">
                            ${state.timelineData.map(phase => `
                                <li class="split-nav-item">
                                    <button class="${phase.id === state.activePhaseId ? 'active' : ''}" data-phase-id="${phase.id}" onclick="window.app.togglePhase('${phase.id}')">
                                        ${phase.title}
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </aside>
                    <main class="split-content">
                        ${state.timelineData.map(phase => `
                            <div class="split-content-item content-item ${phase.id === state.activePhaseId ? 'active' : ''}" data-phase-id="${phase.id}">
                                <div class="card p-6 rounded-lg shadow-md border">
                                    <h3 data-editable class="text-2xl font-bold">${phase.title}</h3>
                                    <p data-editable class="mt-1 text-lg mb-6">${phase.subtitle}</p>
                                    <div data-editable-html class="prose max-w-none">${phase.content}</div>
                                    <div class="edit-controls mt-4 justify-end gap-2 border-t pt-4">
                                        <button class="remove-phase-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" data-id="${phase.id}">移除</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </main>
                </div>
            `;
        }

        function renderMagazineLayout() {
            ui.journeyContentContainer.innerHTML = `
                <div class="magazine-container">
                    ${state.timelineData.map(phase => `
                        <div class="magazine-item content-item" data-phase-id="${phase.id}">
                             <div class="card">
                                <div>
                                    <h3 data-editable class="text-xl font-bold">${phase.title}</h3>
                                    <p data-editable class="mt-1 text-sm">${phase.subtitle}</p>
                                </div>
                                <div class="mt-4 pt-4 border-t border-dashed border-gray-300">
                                    <div data-editable-html class="prose prose-sm max-w-none">${phase.content}</div>
                                </div>
                                <div class="edit-controls mt-auto justify-end gap-2 pt-4">
                                    <button class="remove-phase-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" data-id="${phase.id}">移除</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- TOOLBAR AND EDITING LOGIC ---
        let currentEditingElement = null;

        // FIX: Re-implemented the entire function to correctly save all content types
        function sanitizeAndSaveChanges(element) {
            if (!element) return;

            const cleanHTML = DOMPurify.sanitize(element.innerHTML, SANITIZE_CONFIG);
            if (element.innerHTML !== cleanHTML) {
                element.innerHTML = cleanHTML;
            }

            const stateKey = element.dataset.stateKey;
            if (stateKey) {
                state.mainContent[stateKey] = element.innerHTML;
            } else {
                const phaseItem = element.closest('[data-phase-id]');
                if (phaseItem) {
                    const phaseId = phaseItem.dataset.phaseId;
                    const phase = state.timelineData.find(p => p.id === phaseId);
                    if (!phase) return;

                    if (element.matches('h3')) {
                        phase.title = element.textContent;
                    } else if (element.matches('p')) {
                        phase.subtitle = element.textContent;
                    } else if (element.hasAttribute('data-editable-html')) {
                        phase.content = element.innerHTML;
                    }
                }
            }
            saveState();
            Prism.highlightAll();
        }
        
        function addPhase() {
            const newId = `phase-${Date.now()}`;
            state.timelineData.push({ id: newId, title: '新階段標題', subtitle: '新階段副標題', content: '<p>點此編輯新階段的詳細內容...</p>' });
            state.chartData.labels.push('新階段');
            state.chartData.datasets[0].data.push(10);
            state.activePhaseId = newId;
            renderJourneyContent();
            renderChart();
            saveState();
            setTimeout(() => {
                const newPhaseEl = document.querySelector(`[data-phase-id="${newId}"] [data-editable]`);
                if (newPhaseEl) {
                    newPhaseEl.focus();
                }
            }, 300);
        }

        function removePhase(idToRemove) {
            const indexToRemove = state.timelineData.findIndex(p => p.id === idToRemove);
            if (indexToRemove > -1) {
                state.timelineData.splice(indexToRemove, 1);
                state.chartData.labels.splice(indexToRemove, 1);
                state.chartData.datasets[0].data.splice(indexToRemove, 1);
            }
            renderJourneyContent();
            renderChart();
            saveState();
        }

        // FIX: Re-implemented chart editing functions
        function openChartModal() {
            ui.chartForm.innerHTML = '';
            state.chartData.labels.forEach((label, index) => {
                const data = state.chartData.datasets[0].data[index];
                const group = document.createElement('div');
                group.className = 'grid grid-cols-3 gap-2 items-center';
                group.innerHTML = `
                    <input type="text" value="${label}" class="chart-label col-span-2 p-2 border rounded-md" placeholder="標籤">
                    <input type="text" value="${data}" class="chart-data p-2 border rounded-md" placeholder="數值 (%)">`;
                ui.chartForm.appendChild(group);
            });
            ui.chartModal.classList.remove('hidden');
        }

        function saveChartChanges() {
            const dataInputs = ui.chartForm.querySelectorAll('.chart-data');
            let isValid = true;
            dataInputs.forEach(input => {
                if (isNaN(parseFloat(input.value)) || !isFinite(input.value)) {
                    input.classList.add('input-error');
                    isValid = false;
                } else {
                    input.classList.remove('input-error');
                }
            });
            if (!isValid) return;

            const newLabels = Array.from(ui.chartForm.querySelectorAll('.chart-label')).map(i => i.value);
            const newData = Array.from(dataInputs).map(i => parseFloat(i.value) || 0);

            state.chartData.labels = newLabels;
            state.chartData.datasets[0].data = newData;

            renderChart();
            ui.chartModal.classList.add('hidden');
            saveState();
        }
        
        function exportHTML() {
            const clone = document.createElement('div');
            clone.innerHTML = ui.reportContainer.innerHTML;
            clone.id = 'report-container-exported';

            clone.querySelectorAll('.edit-controls, #toolbar').forEach(el => el.remove());
            clone.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));
            clone.querySelectorAll('.timeline-item.active').forEach(el => el.classList.remove('active'));

            const exportChartData = JSON.parse(JSON.stringify(state.chartData));
            const coreStyles = document.getElementById('core-styles').innerHTML;
            const layoutStyles = LAYOUTS[state.activeLayout].css;
            
            const themeSwitcherHTML = `
                <div id="exported-theme-switcher" class="fixed bottom-4 right-4 z-50 bg-white/80 backdrop-blur-sm p-2 rounded-lg shadow-lg border flex items-center gap-2">
                    <button data-theme="default" class="theme-btn p-2 rounded-full bg-stone-200 hover:bg-stone-300" title="預設主題"><svg width="16" height="16" viewBox="0 0 24 24" fill="#52525b"><path d="M12 2.25a.75.75 0 01.75.75v18a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM2.25 12a.75.75 0 000 1.5h19.5a.75.75 0 000-1.5H2.25z"/></svg></button>
                    <button data-theme="dark" class="theme-btn p-2 rounded-full bg-zinc-800 hover:bg-zinc-700" title="專業暗色"><svg width="16" height="16" viewBox="0 0 24 24" fill="#f4f4f5"><path d="M12 2.25a.75.75 0 01.75.75v18a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM2.25 12a.75.75 0 000 1.5h19.5a.75.75 0 000-1.5H2.25z"/></svg></button>
                    <button data-theme="academic" class="theme-btn p-2 rounded-full bg-indigo-100 hover:bg-indigo-200" title="學術論文"><svg width="16" height="16" viewBox="0 0 24 24" fill="#4f46e5"><path d="M12 2.25a.75.75 0 01.75.75v18a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM2.25 12a.75.75 0 000 1.5h19.5a.75.75 0 000-1.5H2.25z"/></svg></button>
                </div>
            `;

            const exportedScript = `
                const THEMES = ${JSON.stringify(THEMES)};
                let chartInstance = null;
                let chartData = ${JSON.stringify(exportChartData)};
                let activePhaseId = null;
                const activeLayout = "${state.activeLayout}";

                function applyTheme(themeName) {
                    if (!THEMES[themeName]) themeName = 'default';
                    document.body.dataset.theme = themeName;
                    
                    if (chartInstance) {
                         const palette = THEMES[themeName].palette;
                         const colors = chartData.labels.map((_, index) => palette[index % palette.length]);
                         chartInstance.data.datasets[0].backgroundColor = colors.map(c => c.bg);
                         chartInstance.data.datasets[0].borderColor = colors.map(c => c.border);
                         chartInstance.options.plugins.legend.labels.color = getComputedStyle(document.body).getPropertyValue('--text-color-secondary');
                         chartInstance.options.plugins.legend.labels.font.family = getComputedStyle(document.body).getPropertyValue('--font-main');
                         chartInstance.update();
                    }
                }

                function togglePhase(phaseId) {
                    const oldActiveId = activePhaseId;
                    activePhaseId = (oldActiveId === phaseId && activeLayout !== 'split') ? null : phaseId;
                    if (activeLayout === 'split' && !activePhaseId) {
                        activePhaseId = oldActiveId;
                    }
                    
                    document.querySelectorAll('.timeline-item, .split-content-item').forEach(el => {
                        el.classList.toggle('active', el.dataset.phaseId === activePhaseId);
                    });
                    if(activeLayout === 'split') {
                        document.querySelectorAll('.split-nav-item button').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.phaseId === activePhaseId);
                        });
                    }
                }

                document.addEventListener('DOMContentLoaded', function() {
                    Prism.highlightAll();
                    const ctx = document.getElementById('complexityChart')?.getContext('2d');
                    if (ctx) {
                        chartInstance = new Chart(ctx, {
                            type: 'doughnut', data: chartData,
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { position: 'bottom' } }
                            }
                        });
                    }
                    
                    document.querySelectorAll('.timeline-dot, .split-nav-item button').forEach(el => {
                        el.addEventListener('click', () => {
                            const phaseId = el.dataset.phaseId || el.closest('[data-phase-id]').dataset.phaseId;
                            togglePhase(phaseId);
                        });
                    });
                    
                    document.getElementById('exported-theme-switcher').addEventListener('click', (e) => {
                        const button = e.target.closest('.theme-btn');
                        if (button) { applyTheme(button.dataset.theme); }
                    });

                    applyTheme("${state.activeTheme}");
                });
            `;
            
            const finalHTML = `
                <!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${state.mainContent.mainTitle}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
                <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"><\/script>
                <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"><\/script>
                <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
                <style>${coreStyles}<\/style>
                <style>${layoutStyles.replace(/#report-container/g, '#report-container-exported')}<\/style>
                </head>
                <body data-theme="${state.activeTheme}" data-layout="${state.activeLayout}">
                    ${clone.outerHTML}
                    ${themeSwitcherHTML}
                    <script>${exportedScript}<\/script>
                </body></html>`;

            const blob = new Blob([finalHTML], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${state.mainContent.mainTitle.replace(/[\s/]/g, '-')}.html`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // --- INITIALIZATION ---
        function initialize() {
            Object.keys(LAYOUTS).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = LAYOUTS[key].name;
                ui.layoutSwitcher.appendChild(option);
            });
            
            loadState();

            ui.layoutSwitcher.value = state.activeLayout;
            applyLayout(state.activeLayout);
            applyTheme(state.activeTheme);
            renderAll();
            Prism.highlightAll();

            // --- EVENT LISTENERS SETUP ---
            ui.editModeBtn.addEventListener('click', () => {
                state.editMode = !state.editMode;
                toggleEditableState();
            });
            ui.layoutSwitcher.addEventListener('change', (e) => applyLayout(e.target.value));
            ui.exportBtn.addEventListener('click', exportHTML);
            ui.addPhaseBtn.addEventListener('click', addPhase);

            ui.journeyContentContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-phase-btn')) {
                    const idToRemove = e.target.dataset.id;
                    if (confirm('您確定要移除這個階段嗎？')) {
                        removePhase(idToRemove);
                    }
                }
            });
            
            ui.reportContainer.addEventListener('focusin', (e) => {
                if (e.target.hasAttribute('data-editable') || e.target.hasAttribute('data-editable-html')) {
                    currentEditingElement = e.target;
                }
            });

            ui.reportContainer.addEventListener('focusout', (e) => {
                if (state.editMode && (e.target.hasAttribute('data-editable') || e.target.hasAttribute('data-editable-html'))) {
                    sanitizeAndSaveChanges(e.target);
                }
            });

            ui.insertCodeBtn.addEventListener('click', () => {
                if (!currentEditingElement) {
                    alert("請先點擊一個可編輯的區域，再插入程式碼。");
                    return;
                }
                currentEditingElement.focus();
                const codeSnippet = `<pre><code class="language-javascript"><span style="color: #999;">// 在此貼上您的程式碼</span>\nfunction greet() {\n  console.log("Hello, World!");\n}</code></pre><p>繼續編輯...</p>`;
                document.execCommand('insertHTML', false, codeSnippet);
                Prism.highlightAll();
            });

            ui.editChartBtn.addEventListener('click', openChartModal);
            ui.saveChartEditBtn.addEventListener('click', saveChartChanges);
            ui.cancelChartEditBtn.addEventListener('click', () => ui.chartModal.classList.add('hidden'));
            
            ui.helpBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const manualContent = `
                    <!DOCTYPE html>
                    <html lang="zh-Hant">
                    <head>
                        <meta charset="UTF-8">
                        <title>互動式報告編輯器使用手冊</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; padding: 2rem 3rem; }
                            h1 { border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
                            h2 { border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; }
                            code { background-color: #edf2f7; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.9em; }
                            kbd { background-color: #2d3748; color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.9em; border-bottom: 2px solid #4a5568;}
                        </style>
                    </head>
                    <body class="prose max-w-4xl mx-auto">
                        <h1>互動式網頁報告編輯器使用手冊 (v7.9)</h1>
                        <p>歡迎使用互動式報告編輯器！這是一套功能強大且靈活的工具，旨在協助您輕鬆創建具備專業視覺與互動功能的專案報告。本手冊將引導您熟悉所有核心功能。</p>
                        <hr class="my-8">
                        <h2>第一章：基礎操作</h2>
                        <h3>1.1 進入與離開編輯模式</h3>
                        <ul>
                            <li><strong>進入編輯</strong>：點擊畫面右上角工具列的藍色 <strong>「進入編輯模式」</strong> 按鈕。</li>
                            <li><strong>特徵</strong>：進入編輯模式後，所有可編輯的文字區塊周圍會出現<strong>藍色虛線外框</strong>，且工具列會顯示額外的編輯按鈕。</li>
                            <li><strong>離開編輯</strong>：再次點擊同一位置的 <strong>「預覽報告」</strong> 按鈕即可退出，回到預覽狀態。</li>
                        </ul>
                        <h3>1.2 編輯文字內容</h3>
                        <ol>
                            <li>確認您已處於<strong>編輯模式</strong>。</li>
                            <li>直接點擊任何有藍色虛線外框的區域（如主標題、段落內文等）。</li>
                            <li>當文字游標出現後，即可像在一般文書處理軟體中一樣，自由地輸入、刪除或修改文字。</li>
                        </ol>
                        <h4>1.2.1 支援的富文本格式</h4>
                        <p>本編輯器支援多種標準的富文本格式，讓您的內容更具層次感。您可以透過以下兩種方式來應用格式：</p>
                        <ul>
                            <li><strong>方法一：使用鍵盤快捷鍵</strong>（最推薦）。</li>
                            <li><strong>方法二：從其他編輯器（如 Word、Google Docs）複製已設定好格式的文字</strong>，然後直接貼上。編輯器會自動保留支援的格式，並過濾掉不安全的程式碼。</li>
                        </ul>
                        <p><strong>支援格式列表：</strong></p>
                        <ul>
                            <li><strong>粗體</strong>: <code>&lt;b&gt;</code>, <code>&lt;strong&gt;</code> (快捷鍵: <kbd>Ctrl</kbd> + <kbd>B</kbd>)</li>
                            <li><strong>斜體</strong>: <code>&lt;i&gt;</code>, <code>&lt;em&gt;</code> (快捷鍵: <kbd>Ctrl</kbd> + <kbd>I</kbd>)</li>
                            <li><strong>底線</strong>: <code>&lt;u&gt;</code> (快捷鍵: <kbd>Ctrl</kbd> + <kbd>U</kbd>)</li>
                            <li><strong>清單</strong>:
                                <ul>
                                    <li>無序清單 (項目符號): <code>&lt;ul&gt;</code> 搭配 <code>&lt;li&gt;</code></li>
                                    <li>有序清單 (編號): <code>&lt;ol&gt;</code> 搭配 <code>&lt;li&gt;</code></li>
                                </ul>
                            </li>
                            <li><strong>連結</strong>: <code>&lt;a&gt;</code> (建議直接貼上帶有連結的文字)</li>
                            <li><strong>標題</strong>: <code>&lt;h1&gt;</code> 至 <code>&lt;h6&gt;</code></li>
                            <li><strong>段落與換行</strong>: <code>&lt;p&gt;</code>, <code>&lt;br&gt;</code></li>
                            <li><strong>程式碼區塊</strong>: <code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code> (請使用右上角的「插入程式碼」功能)</li>
                        </ul>
                        <h3>1.3 儲存進度</h3>
                        <p>您的所有變更（包含文字、圖表數據、所選樣板等）都會<strong>自動儲存</strong>在您瀏覽器的本機儲存空間 (<code>localStorage</code>) 中。即使您關閉或重新整理分頁，下次開啟時仍會載入上次的進度。</p>
                        
                        <hr class="my-8">
                        <h2>第二章：核心功能</h2>
                        <h3>2.1 還原預設內容</h3>
                        <p>如果您希望清除所有自訂內容，回到最初的範本狀態，可以使用此功能。</p>
                        <ol>
                            <li>點擊右上角工具列最下方的紅色 <strong>「還原預設內容」</strong> 按鈕。</li>
                            <li>在跳出的確認視窗中點擊「確定」。</li>
                            <li>頁面將會重新整理，並載入最原始的報告內容。<strong>請注意：此操作無法復原。</strong></li>
                        </ol>
                        <h3>2.2 切換排版樣板</h3>
                        <p>本編輯器最大的特色之一就是能一鍵切換多種專業排版。</p>
                        <ol>
                            <li>點擊右上角工具列中的<strong>下拉式選單</strong>（預設顯示「經典時間軸」）。</li>
                            <li>從選單中選擇您偏好的樣板，例如「現代網格卡片」或「雜誌風格」。</li>
                            <li>報告的「開發之旅」區塊將會立即重新渲染，呈現全新的視覺佈局。</li>
                        </ol>
                        <h3>2.3 新增與移除階段</h3>
                        <ol>
                            <li><strong>新增階段</strong>：
                                <ul>
                                    <li>進入<strong>編輯模式</strong>。</li>
                                    <li>捲動至「開發之旅」區塊的底部，點擊藍色的 <strong>「＋ 新增階段」</strong> 按鈕。</li>
                                    <li>系統會自動在結尾新增一個新的階段卡片，並同時更新上方的圓餅圖數據。</li>
                                </ul>
                            </li>
                            <li><strong>移除階段</strong>：
                                <ul>
                                    <li>進入<strong>編輯模式</strong>。</li>
                                    <li>將滑鼠移至您想刪除的階段卡片上，卡片角落會出現一個紅色的 <strong>「移除」</strong> 按鈕。</li>
                                    <li>點擊「移除」並在跳出的確認視窗中選擇「確定」，即可刪除該階段。</li>
                                </ul>
                            </li>
                        </ol>
                        <h3>2.4 插入程式碼區塊</h3>
                        <ol>
                            <li>進入<strong>編輯模式</strong>。</li>
                            <li><strong>先用滑鼠點擊</strong>您希望插入程式碼的段落，確保文字游標在該處閃爍。</li>
                            <li>點擊右上角工具列的紫色 <strong>「插入程式碼」</strong> 按鈕。</li>
                            <li>一個預設格式的 JavaScript 程式碼區塊將會被插入到您的游標位置。您可以直接修改或貼上您自己的程式碼。語法高亮將會自動處理。</li>
                        </ol>
                        <h3>2.5 匯出 HTML 報告</h3>
                        <p>當您完成報告編輯後，可以將其匯出為一個獨立、完整的 HTML 檔案。</p>
                        <ol>
                            <li>點擊右上角工具列的灰色 <strong>「匯出 HTML 報告」</strong> 按鈕。</li>
                            <li>瀏覽器將會自動下載一個 <code>.html</code> 檔案。</li>
                            <li>這個檔案是<strong>完全獨立的</strong>，您可以將它傳送給任何人，或部署到任何網頁伺服器上。它包含了所有必要的樣式、腳本與互動功能，包含右下角的主題切換器。</li>
                        </ol>
                        
                        <hr class="my-8">
                        <h2>第三章：樣板介紹</h2>
                        <ul>
                            <li><strong>經典時間軸 (Classic Timeline)</strong>
                                <p><strong>特色</strong>：以垂直時間軸貫穿，左右交錯呈現各個開發階段。<br><strong>適用情境</strong>：適合展現具有明確時間順序或流程演進的專案。</p>
                            </li>
                            <li><strong>現代網格卡片 (Modern Grid)</strong>
                                <p><strong>特色</strong>：將所有階段以大小一致的卡片形式整齊排列。<br><strong>適用情境</strong>：適合快速概覽所有階段的重點，便於比較與查閱。</p>
                            </li>
                            <li><strong>極簡左右分欄 (Minimal Split-Column)</strong>
                                <p><strong>特色</strong>：左側為固定的階段導覽清單，右側顯示對應的詳細內容。<br><strong>適用情境</strong>：適合內容較多、結構嚴謹的技術文件或詳細報告。</p>
                            </li>
                            <li><strong>雜誌風格 (Magazine)</strong>
                                <p><strong>特色</strong>：採用大小錯落不一的卡片佈局，創造豐富的視覺層次感。<br><strong>適用情境</strong>：適合用於需要強烈設計感、希望以說故事方式呈現的專案報告。</p>
                            </li>
                        </ul>
                    </body>
                    </html>
                `;
                const newTab = window.open();
                newTab.document.write(manualContent);
                newTab.document.close();
            });

            // NEW: Event listener for the reset button
            ui.resetBtn.addEventListener('click', () => {
                if (confirm('您確定要還原所有內容至預設狀態嗎？此操作將會清除所有您輸入的資料且無法復原。')) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            });
        }

        initialize();
    });
    </script>
</body>
</html>
