<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡ä¸‰å¤§æ³•äººç±Œç¢¼åˆ†æ (å–®ä½ï¼šå¼µ)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: è§£æ±ºæ¨¡çµ„è¼‰å…¥å•é¡Œ -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.7?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.303.0?external=react,react-dom",
            "idb-keyval": "https://esm.sh/idb-keyval@6.2.1"
        }
    }
    </script>

    <style>
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        /* å¹³æ»‘éæ¸¡æ•ˆæœ */
        .theme-transition {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }

        /* Markdown æ¨£å¼æ¨¡æ“¬ */
        .markdown-body h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .markdown-body h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .markdown-body p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .markdown-body li {
            margin-bottom: 0.25rem;
        }

        .markdown-body strong {
            font-weight: 600;
        }

        /* Slider è‡ªå®šç¾©æ¨£å¼ */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #6366f1;
            /* Indigo-500 */
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #475569;
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';

        import {
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, Cell
        } from 'recharts';

        import {
            Upload, FileText, RefreshCw, AlertCircle, Database, TrendingUp, TrendingDown,
            ArrowUp, ArrowDown, Users, Briefcase, Globe, Landmark, Layers, Calendar, Settings, Trash2,
            Sun, Moon, Coffee, ExternalLink, Download, CheckSquare, Square, X, Maximize2, Minimize2, FileJson,
            BookOpen, Info, DollarSign, BarChart2, AlignLeft
        } from 'lucide-react';

        // å¼•å…¥ IndexedDB å°è£åº«
        import { get, set, del } from 'idb-keyval';

        // --- å·¥å…·å‡½æ•¸ ---
        const formatDateToTWSE = (dateStr) => dateStr.replace(/-/g, ''); // 2023-10-01 -> 20231001
        const formatDateToDisplay = (dateStr) => {
            if (!dateStr || dateStr.length !== 8) return dateStr;
            return `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
        };
        const formatMoney = (num) => {
            if (!num) return '0';
            const absNum = Math.abs(num);
            if (absNum >= 100000000) return (num / 100000000).toFixed(2) + ' å„„';
            if (absNum >= 10000) return (num / 10000).toFixed(0) + ' è¬';
            return num.toLocaleString();
        };

        // å‚™æ´ Proxy æ¸…å–®
        const PROXY_CANDIDATES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://thingproxy.freeboard.io/fetch/'
        ];

        // ä¸»é¡Œè¨­å®š
        const THEMES = {
            light: {
                name: 'ç™½',
                bg: 'bg-slate-50',
                text: 'text-slate-800',
                textMuted: 'text-slate-500',
                card: 'bg-white',
                border: 'border-slate-200',
                header: 'bg-slate-900',
                grid: '#e2e8f0',
                tooltipBg: '#ffffff',
                tooltipText: '#1e293b',
                chartText: '#64748b',
                infoBg: 'bg-slate-100',
                infoText: 'text-slate-500',
                zeroLine: '#0f172a'
            },
            warm: {
                name: 'æš–',
                bg: 'bg-[#f5f5f0]',
                text: 'text-[#44403c]',
                textMuted: 'text-[#78716c]',
                card: 'bg-[#fdfbf7]',
                border: 'border-[#e7e5e4]',
                header: 'bg-[#57534e]',
                grid: '#d6d3d1',
                tooltipBg: '#fafaf9',
                tooltipText: '#44403c',
                chartText: '#78716c',
                infoBg: 'bg-[#e7e5e4]',
                infoText: 'text-[#78716c]',
                zeroLine: '#292524'
            },
            dark: {
                name: 'æš—',
                bg: 'bg-[#0f172a]',
                text: 'text-slate-200',
                textMuted: 'text-slate-400',
                card: 'bg-[#1e293b]',
                border: 'border-slate-700',
                header: 'bg-[#020617]',
                grid: '#334155',
                tooltipBg: '#1e293b',
                tooltipText: '#f8fafc',
                chartText: '#cbd5e1',
                infoBg: 'bg-slate-700',
                infoText: 'text-slate-200',
                zeroLine: '#f8fafc'
            }
        };

        // ä½¿ç”¨æ‰‹å†Šå…ƒä»¶
        const ManualModal = ({ onClose, theme }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onClick={onClose}>
                <div className={`w-full max-w-3xl max-h-[85vh] overflow-y-auto custom-scrollbar rounded-xl shadow-2xl ${theme.card} ${theme.text}`} onClick={e => e.stopPropagation()}>
                    <div className={`flex justify-between items-center p-5 border-b sticky top-0 ${theme.card} z-10`} style={{ borderColor: theme.border }}>
                        <h2 className="text-xl font-bold flex items-center gap-2">
                            <BookOpen className="w-6 h-6 text-indigo-500" />
                            å°è‚¡ä¸‰å¤§æ³•äººç±Œç¢¼åˆ†æ - ä½¿ç”¨æ‰‹å†Š
                        </h2>
                        <button onClick={onClose} className="p-2 hover:bg-black/5 rounded-full transition-colors">
                            <X className="w-5 h-5" />
                        </button>
                    </div>
                    <div className="p-6 markdown-body text-sm md:text-base">
                        <h3>ğŸš€ ç°¡ä»‹</h3>
                        <p>ã€Œå°è‚¡ä¸‰å¤§æ³•äººç±Œç¢¼åˆ†æã€æ˜¯ä¸€æ¬¾åŸºæ–¼ç€è¦½å™¨çš„å°ˆæ¥­ç´šé‡‘èåˆ†æå·¥å…·ã€‚æ•´åˆè­‰äº¤æ‰€ T86 (å€‹è‚¡è²·è³£è¶…) èˆ‡ BFI82U (å¸‚å ´ç¸½é‡‘é¡) è³‡è¨Šï¼Œå”åŠ©æ‚¨å…¨æ–¹ä½æŒæ¡å¤–è³‡ã€æŠ•ä¿¡ã€è‡ªç‡Ÿå•†çš„è³‡é‡‘æµå‘ã€‚</p>

                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4">
                            <p className="font-bold">âš ï¸ ç‰ˆæœ¬ v4.0 æœ€çµ‚ä¿®æ­£ (é¡¯ç¤ºç‚ºå¼µæ•¸)ï¼š</p>
                            <p>æœ¬ç³»çµ±å·²è¨­å®šç‚ºï¼š<strong>è®€å–åŸå§‹è‚¡æ•¸ -> è‡ªå‹•é™¤ä»¥ 1000 -> é¡¯ç¤ºç‚ºå¼µæ•¸</strong>ã€‚</p>
                            <p><strong>è«‹æ³¨æ„ï¼š</strong> ç”±æ–¼ v3 ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯ã€Œè‚¡æ•¸ã€å–®ä½ï¼Œè‹¥æ‚¨çš„è³‡æ–™åº«ä¸­æœ‰æ··åˆ v3 èˆ‡ v4 çš„è³‡æ–™ï¼Œæ•¸å€¼å°‡æœƒç›¸å·® 1000 å€ã€‚å¼·çƒˆå»ºè­°æ‚¨é»æ“Šã€Œè¨­å®šã€ä¸­çš„ <strong>ã€Œæ¸…é™¤æ‰€æœ‰è³‡æ–™ã€</strong> å¾Œé‡æ–°æŠ“å–ã€‚</p>
                        </div>

                        <h3>âœ¨ æ ¸å¿ƒäº®é»</h3>
                        <ul>
                            <li><strong>è‡ªå‹•æ›ç®—</strong>ï¼šæŠ“å–è­‰äº¤æ‰€åŸå§‹è‚¡æ•¸è³‡æ–™å¾Œï¼Œç³»çµ±è‡ªå‹•æ›ç®—ç‚ºã€Œå¼µæ•¸ã€å‘ˆç¾ã€‚</li>
                            <li><strong>é›™è»Œæ•¸æ“šæ•´åˆ</strong>ï¼šåŒæ™‚æ”¯æ´ã€Œå€‹è‚¡å¼µæ•¸ã€èˆ‡ã€Œåˆ†é¡é‡‘é¡ã€åˆ†æã€‚</li>
                            <li><strong>ä¼æ¥­ç´šå¤§å®¹é‡å„²å­˜</strong>ï¼šæ¡ç”¨ IndexedDB æŠ€è¡“ï¼Œå¯å„²å­˜æ•¸æœˆç”šè‡³æ•¸å¹´çš„æ­·å²è³‡æ–™ã€‚</li>
                            <li><strong>å°ˆæ¥­è¦–è¦ºåŒ–åˆ†æ</strong>ï¼šæä¾›è²·è³£è¶…æ’è¡Œã€å¤šæ—¥ç´¯è¨ˆè¶¨å‹¢ã€åœŸæ´‹åˆä½œåµæ¸¬ã€‚</li>
                        </ul>

                        <h3>ğŸ“– ä½¿ç”¨æ•™å­¸</h3>
                        <p><strong>1. å»ºç«‹è³‡æ–™åº«</strong></p>
                        <ul>
                            <li><strong>æ–¹æ³• Aï¼šé›²ç«¯æŠ“å– (æ¨è–¦)</strong>ï¼šé¸æ“‡æ—¥æœŸ -> é»æ“Šã€ŒæŠ“å– T86ã€ã€‚ç³»çµ±æœƒè‡ªå‹•å°‡æŠ“åˆ°çš„è‚¡æ•¸è½‰ç‚ºå¼µæ•¸ã€‚</li>
                            <li><strong>æ–¹æ³• Bï¼šCSV åŒ¯å…¥ (æ‰‹å‹•å‚™æ´)</strong>ï¼š
                                <ul>
                                    <li>é»æ“Šä¸‹è¼‰åœ–ç¤º <span className="inline-block px-1 bg-gray-200 text-black text-xs rounded">è‚¡</span> å‰å¾€ä¸‹è¼‰ <strong>T86</strong> å ±è¡¨ (è­‰äº¤æ‰€æª”æ¡ˆç‚ºè‚¡æ•¸) -> é»æ“Šã€ŒåŒ¯å…¥ã€è¼‰å…¥ (ç³»çµ±æœƒè‡ªå‹•è½‰ç‚ºå¼µæ•¸)ã€‚</li>
                                    <li>é»æ“Šä¸‹è¼‰åœ–ç¤º <span className="inline-block px-1 bg-gray-200 text-black text-xs rounded">é‡‘</span> å‰å¾€ä¸‹è¼‰ <strong>BFI82U</strong> å ±è¡¨ -> é»æ“Šã€ŒåŒ¯å…¥ã€è¼‰å…¥ã€‚</li>
                                </ul>
                            </li>
                        </ul>

                        <p><strong>2. è¦–è¦ºåŒ–æ“ä½œ</strong></p>
                        <ul>
                            <li><strong>åœ–è¡¨æ¨¡å¼åˆ‡æ›</strong>ï¼šé»æ“Šåœ–è¡¨å³ä¸Šè§’çš„åˆ‡æ›æŒ‰éˆ•ã€‚
                                <ul>
                                    <li><strong>ğŸ“Š æ·¨å€¼ (Net)</strong>ï¼šåªé¡¯ç¤ºå–®ä¸€é¡è‰²çš„æ·¨è²·è³£è¶…ï¼Œç°¡å–®ç›´è§€ã€‚</li>
                                    <li><strong>ğŸ“‘ å †ç–Š (Stacked)</strong>ï¼šé¡¯ç¤ºå¤–è³‡/æŠ•ä¿¡/è‡ªç‡Ÿçš„çµæ§‹ï¼Œå¯çœ‹å‡ºåœŸæ´‹å°ä½œã€‚</li>
                                </ul>
                            </li>
                            <li><strong>åœ–è¡¨æ”¾å¤§</strong>ï¼šé»æ“Šåœ–è¡¨å³ä¸Šè§’çš„æ”¾å¤§åœ–ç¤ºï¼Œå¯é€²å…¥å…¨è¢å¹•æ¨¡å¼ã€‚</li>
                        </ul>
                    </div>
                    <div className={`p-4 border-t text-center text-xs ${theme.textMuted}`} style={{ borderColor: theme.border }}>
                        Version: 6.0 (Input: Shares / Display: Sheets)
                    </div>
                </div>
            </div>
        );

        const App = () => {
            // --- State ---
            const [historicalData, setHistoricalData] = useState({});
            const [historicalSummary, setHistoricalSummary] = useState({});
            const [isDbInitialized, setIsDbInitialized] = useState(false);

            const [currentDate, setCurrentDate] = useState(() => new Date().toISOString().split('T')[0]);
            const [dateRange, setDateRange] = useState(1);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('overview');
            const [showSettings, setShowSettings] = useState(false);
            const [showManual, setShowManual] = useState(false);
            const [retryCount, setRetryCount] = useState(0);

            const [selectedDates, setSelectedDates] = useState(new Set());
            const [currentTheme, setCurrentTheme] = useState(() => localStorage.getItem('t86_theme') || 'light');
            const theme = THEMES[currentTheme];

            // åœ–è¡¨æ¨¡å¼ state: 'net' (æ·¨å€¼) æˆ– 'stacked' (å †ç–Š)
            const [chartMode, setChartMode] = useState('net');

            const [proxyUrl, setProxyUrl] = useState(() => {
                const saved = localStorage.getItem('t86_proxy_url');
                if (saved === 'https://corsproxy.io/?') return PROXY_CANDIDATES[0];
                return saved || PROXY_CANDIDATES[0];
            });

            // --- Persistence ---
            useEffect(() => {
                const initDatabase = async () => {
                    setLoading(true);
                    try {
                        const dbData = await get('t86_historical_data') || {};
                        const dbSummary = await get('t86_historical_summary') || {};

                        // é·ç§»èˆŠç‰ˆ
                        const legacyDataStr = localStorage.getItem('t86_historical_data');
                        if (legacyDataStr) {
                            try {
                                const legacyData = JSON.parse(legacyDataStr);
                                Object.assign(dbData, legacyData);
                                localStorage.removeItem('t86_historical_data');
                            } catch (e) { }
                        }

                        setHistoricalData(dbData);
                        setHistoricalSummary(dbSummary);
                    } catch (err) {
                        setError("è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—ã€‚");
                    } finally {
                        setIsDbInitialized(true);
                        setLoading(false);
                    }
                };
                initDatabase();
            }, []);

            useEffect(() => {
                if (!isDbInitialized) return;
                const saveData = async () => {
                    try {
                        await set('t86_historical_data', historicalData);
                        await set('t86_historical_summary', historicalSummary);
                        if (error && error.includes("å„²å­˜ç©ºé–“ä¸è¶³")) setError(null);
                    } catch (err) {
                        setError("å¯«å…¥è³‡æ–™åº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¡¬ç¢Ÿç©ºé–“ã€‚");
                    }
                };
                saveData();
            }, [historicalData, historicalSummary, isDbInitialized]);

            useEffect(() => { localStorage.setItem('t86_proxy_url', proxyUrl); }, [proxyUrl]);
            useEffect(() => { localStorage.setItem('t86_theme', currentTheme); }, [currentTheme]);

            // --- è³‡æ–™ç®¡ç† ---
            const storedDatesList = useMemo(() => Object.keys(historicalData).sort().reverse(), [historicalData]);

            // è¨ˆç®—æ»‘æ¡¿ä¸Šé™ï¼šæœ€å° 1ï¼Œæœ€å¤§ 60ï¼Œä½†ä¸è¶…éå¯¦éš›æ“æœ‰çš„å¤©æ•¸
            const maxDateRange = useMemo(() => {
                const count = storedDatesList.length;
                return Math.min(Math.max(count, 1), 60);
            }, [storedDatesList]);

            const toggleDateSelection = (date) => {
                const newSet = new Set(selectedDates);
                if (newSet.has(date)) newSet.delete(date); else newSet.add(date);
                setSelectedDates(newSet);
            };

            const toggleAllDates = () => {
                setSelectedDates(selectedDates.size === storedDatesList.length ? new Set() : new Set(storedDatesList));
            };

            const deleteSelectedData = () => {
                if (selectedDates.size === 0) return;
                if (!window.confirm(`ç¢ºå®šåˆªé™¤ ${selectedDates.size} ç­†è³‡æ–™ï¼Ÿ`)) return;
                const newData = { ...historicalData };
                const newSummary = { ...historicalSummary };
                selectedDates.forEach(date => { delete newData[date]; delete newSummary[date]; });
                setHistoricalData(newData);
                setHistoricalSummary(newSummary);
                setSelectedDates(new Set());
            };

            const deleteSingleDate = (date) => {
                if (!window.confirm(`åˆªé™¤ ${formatDateToDisplay(date)} è³‡æ–™ï¼Ÿ`)) return;
                const newData = { ...historicalData };
                const newSummary = { ...historicalSummary };
                delete newData[date];
                delete newSummary[date];
                setHistoricalData(newData);
                setHistoricalSummary(newSummary);
            };

            const clearAllData = () => {
                if (window.confirm("æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿè‹¥æ‚¨çš„è³‡æ–™ç‚º v3(è‚¡æ•¸ç‰ˆ)ï¼Œå¿…é ˆæ¸…é™¤ä»¥é¿å…èˆ‡ v4(å¼µæ•¸ç‰ˆ) æ··æ·†ã€‚")) {
                    setHistoricalData({});
                    setHistoricalSummary({});
                    del('t86_historical_data');
                    del('t86_historical_summary');
                    setSelectedDates(new Set());
                    setError(null);
                }
            };

            const downloadBackup = () => {
                const backup = { data: historicalData, summary: historicalSummary };
                const dataStr = JSON.stringify(backup);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `T86_Backup_${new Date().toISOString().slice(0, 10)}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            // --- API Logic ---
            const fetchRealData = async () => {
                setLoading(true);
                setError(null);
                setRetryCount(0);
                const targetDateStr = formatDateToTWSE(currentDate);
                const proxiesToTry = [proxyUrl, ...PROXY_CANDIDATES.filter(p => p !== proxyUrl)];
                const uniqueProxies = [...new Set(proxiesToTry)].filter(Boolean);

                let success = false;
                let lastErrorMsg = '';

                for (let i = 0; i < uniqueProxies.length; i++) {
                    const currentProxy = uniqueProxies[i];
                    setRetryCount(i + 1);
                    try {
                        const t86Url = `${currentProxy}${encodeURIComponent(`https://www.twse.com.tw/rwd/zh/fund/T86?date=${targetDateStr}&selectType=ALL&response=json`)}`;
                        const res = await fetch(t86Url);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const json = await res.json();
                        if (json.stat !== 'OK') throw new Error(`TWSE_LOGIC_ERROR:${json.stat}`);
                        processFetchedData(json, targetDateStr);

                        try {
                            const summaryUrl = `${currentProxy}${encodeURIComponent(`https://www.twse.com.tw/rwd/zh/fund/BFI82U?date=${targetDateStr}&response=json`)}`;
                            const resSum = await fetch(summaryUrl);
                            if (resSum.ok) {
                                const jsonSum = await resSum.json();
                                if (jsonSum.stat === 'OK') processSummaryData(jsonSum, targetDateStr);
                            }
                        } catch (e) {
                            console.warn("Summary fetch failed:", e);
                        }

                        success = true;
                        if (currentProxy !== proxyUrl) setProxyUrl(currentProxy);
                        break;
                    } catch (err) {
                        if (err.message.startsWith('TWSE_LOGIC_ERROR:')) { lastErrorMsg = err.message.split(':')[1]; break; }
                        lastErrorMsg = err.message;
                    }
                }

                if (!success) setError(`æŠ“å–å¤±æ•—: ${lastErrorMsg}`);
                setLoading(false);
                setRetryCount(0);
            };

            // v4.0 Update: æ¢å¾©æ›ç®—é‚è¼¯ -> é™¤ä»¥ 1000 = å¼µ
            const processFetchedData = (json, dateStr) => {
                try {
                    const fields = json.fields;
                    const getIdx = (name) => fields.findIndex(f => f.includes(name));
                    const idxId = 0; const idxName = 1;
                    const idxForeign = getIdx('å¤–é™¸è³‡è²·è³£è¶…è‚¡æ•¸');
                    const idxTrust = getIdx('æŠ•ä¿¡è²·è³£è¶…è‚¡æ•¸');
                    const idxDealer = getIdx('è‡ªç‡Ÿå•†è²·è³£è¶…è‚¡æ•¸');
                    const idxTotal = getIdx('ä¸‰å¤§æ³•äººè²·è³£è¶…è‚¡æ•¸');

                    if (idxForeign === -1) throw new Error("API æ ¼å¼è®Šæ›´");

                    // è¼”åŠ©å‡½å¼ï¼šè§£æåŸå§‹è‚¡æ•¸ä¸¦è½‰ç‚ºå¼µæ•¸
                    const parseToSheets = (val) => {
                        const rawShares = parseInt(val.replace(/,/g, ''), 10) || 0;
                        return Math.round(rawShares / 1000); // è‚¡ -> å¼µ
                    };

                    const parsedRows = json.data.map(row => {
                        return {
                            id: row[idxId],
                            name: row[idxName].trim(),
                            foreign: parseToSheets(row[idxForeign]),
                            trust: idxTrust !== -1 ? parseToSheets(row[idxTrust]) : 0,
                            dealer: idxDealer !== -1 ? parseToSheets(row[idxDealer]) : 0,
                            total: parseToSheets(row[idxTotal])
                        };
                    }).filter(r => r.id.length <= 6 && !isNaN(parseInt(r.id[0])));

                    setHistoricalData(prev => ({ ...prev, [dateStr]: parsedRows }));
                } catch (e) { throw new Error("è³‡æ–™è§£æéŒ¯èª¤"); }
            };

            const processSummaryData = (json, dateStr) => {
                try {
                    const data = json.data;
                    const parseMoney = (rowIdx) => parseInt(data[rowIdx][3].replace(/,/g, ''), 10);
                    const dealerNet = parseMoney(0) + parseMoney(1);
                    const trustNet = parseMoney(2);
                    const foreignNet = parseMoney(3);

                    setHistoricalSummary(prev => ({
                        ...prev,
                        [dateStr]: { foreign: foreignNet, trust: trustNet, dealer: dealerNet }
                    }));
                } catch (e) { console.error("Summary parse error", e); }
            };

            // --- CSV & JSON åŒ¯å…¥é‚è¼¯ ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setLoading(true); setError(null);
                const reader = new FileReader();

                if (file.type === "application/json" || file.name.endsWith('.json')) {
                    reader.readAsText(file, 'UTF-8');
                    reader.onload = (e) => {
                        try {
                            const backup = JSON.parse(e.target.result);
                            if (backup.data) {
                                setHistoricalData(prev => ({ ...prev, ...backup.data }));
                                if (backup.summary) setHistoricalSummary(prev => ({ ...prev, ...backup.summary }));
                            } else {
                                setHistoricalData(prev => ({ ...prev, ...backup }));
                            }
                            alert("é‚„åŸæˆåŠŸï¼(è«‹ç¢ºèªå‚™ä»½æª”æ˜¯å¦ç‚º v4 å¼µæ•¸å–®ä½)");
                        } catch (err) { setError("é‚„åŸå¤±æ•—"); }
                        finally { setLoading(false); }
                    };
                } else {
                    reader.readAsText(file, 'Big5');
                    reader.onload = (e) => {
                        try {
                            const csvText = e.target.result;
                            const lines = csvText.split(/\r\n|\n/);
                            const isT86 = lines.some(l => l.includes('è­‰åˆ¸ä»£è™Ÿ'));
                            const isBFI82U = lines.some(l => l.includes('å–®ä½åç¨±') && l.includes('è²·é€²é‡‘é¡'));

                            let fileDate = formatDateToTWSE(currentDate);
                            const titleLine = lines.find(l => l.includes('å¹´') && l.includes('æœˆ'));
                            if (titleLine) {
                                const match = titleLine.match(/(\d{2,3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                                if (match) fileDate = `${parseInt(match[1]) + 1911}${match[2].padStart(2, '0')}${match[3].padStart(2, '0')}`;
                            }

                            if (isT86) {
                                const result = parseTWSET86CSV(csvText);
                                if (result.length === 0) throw new Error("ç„¡æ•ˆ T86 CSV");
                                setHistoricalData(prev => ({ ...prev, [fileDate]: result }));
                                alert(`æˆåŠŸåŒ¯å…¥ ${fileDate} å€‹è‚¡ç±Œç¢¼ (T86)ï¼å·²è‡ªå‹•è½‰ç‚ºå¼µæ•¸ã€‚`);
                            } else if (isBFI82U) {
                                const summary = parseBFI82UCSV(csvText);
                                setHistoricalSummary(prev => ({ ...prev, [fileDate]: summary }));
                                alert(`æˆåŠŸåŒ¯å…¥ ${fileDate} é‡‘é¡çµ±è¨ˆ (BFI82U)ï¼`);
                            } else {
                                throw new Error("ç„¡æ³•è­˜åˆ¥çš„ CSV æ ¼å¼");
                            }
                            setCurrentDate(`${fileDate.substring(0, 4)}-${fileDate.substring(4, 6)}-${fileDate.substring(6, 8)}`);
                        } catch (err) { setError("CSV è®€å–å¤±æ•—: " + err.message); }
                        finally { setLoading(false); }
                    };
                }
            };

            // v4.0 Update: CSV è§£æè½‰å¼µæ•¸
            const parseTWSET86CSV = (text) => {
                const lines = text.split(/\r\n|\n/);
                const result = [];
                let headerIndex = lines.findIndex(l => l.includes('è­‰åˆ¸ä»£è™Ÿ'));
                if (headerIndex === -1) return [];

                // è¼”åŠ©: è½‰å¼µæ•¸
                const cleanToSheets = (v) => {
                    if (!v) return 0;
                    const raw = parseInt(v.replace(/^"|"$/g, '').replace(/,/g, '').trim()) || 0;
                    return Math.round(raw / 1000);
                };

                for (let i = headerIndex + 1; i < lines.length; i++) {
                    const line = lines[i].trim(); if (!line) continue;
                    const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if (!cols || cols.length < 5) continue;
                    const cleanId = (v) => v ? v.replace(/^"|"$/g, '').replace(/,/g, '').trim() : '0';
                    const cleanName = (v) => v ? v.replace(/^"|"$/g, '').replace(/,/g, '').trim() : '';

                    const id = cleanId(cols[0]);
                    if (id.length > 6 || isNaN(parseInt(id[0]))) continue;

                    const foreign = cleanToSheets(cols[4]);
                    const trust = cleanToSheets(cols[10]);
                    const total = cleanToSheets(cols[cols.length - 1]);
                    // è‡ªç‡Ÿå•†é€šå¸¸æ˜¯æœ€å¾Œä¸€å€‹æ¬„ä½(ä¸‰å¤§æ³•äººåˆè¨ˆ) - å¤–è³‡ - æŠ•ä¿¡
                    const dealer = total - foreign - trust;

                    result.push({
                        id, name: cleanName(cols[1]),
                        foreign, trust, dealer, total
                    });
                }
                return result;
            };

            const parseBFI82UCSV = (text) => {
                const lines = text.split(/\r\n|\n/);
                let foreign = 0, trust = 0, dealer = 0;
                lines.forEach(line => {
                    const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if (!matches || matches.length < 4) return;
                    const name = matches[0].replace(/"/g, '').trim();
                    const netStr = matches[3].replace(/"/g, '').replace(/,/g, '');
                    const net = parseInt(netStr) || 0;
                    if (name.includes('å¤–è³‡') || name.includes('é™¸è³‡')) foreign += net;
                    else if (name.includes('æŠ•ä¿¡')) trust += net;
                    else if (name.includes('è‡ªç‡Ÿå•†')) dealer += net;
                });
                return { foreign, trust, dealer };
            };

            // --- èšåˆ ---
            const aggregatedData = useMemo(() => {
                const targetDateStr = formatDateToTWSE(currentDate);
                const availableDates = Object.keys(historicalData).sort().reverse();
                const startIndex = availableDates.indexOf(targetDateStr);
                if (startIndex === -1) return { stocks: [], summary: null };

                const datesToAggregate = availableDates.slice(startIndex, startIndex + dateRange);
                const aggMap = {};
                const aggSummary = { foreign: 0, trust: 0, dealer: 0, count: 0 };

                datesToAggregate.forEach(dateKey => {
                    (historicalData[dateKey] || []).forEach(row => {
                        if (!aggMap[row.id]) aggMap[row.id] = { ...row, foreign: 0, trust: 0, dealer: 0, total: 0 };
                        aggMap[row.id].foreign += row.foreign;
                        aggMap[row.id].trust += row.trust;
                        aggMap[row.id].dealer += row.dealer;
                        aggMap[row.id].total += row.total;
                    });
                    if (historicalSummary[dateKey]) {
                        aggSummary.foreign += historicalSummary[dateKey].foreign;
                        aggSummary.trust += historicalSummary[dateKey].trust;
                        aggSummary.dealer += historicalSummary[dateKey].dealer;
                        aggSummary.count++;
                    }
                });

                return {
                    stocks: Object.values(aggMap).sort((a, b) => b.total - a.total),
                    summary: aggSummary.count > 0 ? aggSummary : null
                };
            }, [historicalData, historicalSummary, currentDate, dateRange]);

            const stats = useMemo(() => {
                if (aggregatedData.stocks.length === 0) return null;
                const d = aggregatedData.stocks;
                return {
                    totalBuy: [...d].sort((a, b) => b.total - a.total).slice(0, 15),
                    totalSell: [...d].sort((a, b) => a.total - b.total).slice(0, 15),
                    coBuy: d.filter(x => x.foreign > 0 && x.trust > 0 && x.dealer > 0).sort((a, b) => b.total - a.total),
                    coSell: d.filter(x => x.foreign < 0 && x.trust < 0 && x.dealer < 0).sort((a, b) => a.total - b.total),
                    foreignBuy: [...d].sort((a, b) => b.foreign - a.foreign).slice(0, 20),
                    foreignSell: [...d].sort((a, b) => a.foreign - b.foreign).slice(0, 20),
                    trustBuy: [...d].sort((a, b) => b.trust - a.trust).slice(0, 20),
                    trustSell: [...d].sort((a, b) => a.trust - b.trust).slice(0, 20),
                    dealerBuy: [...d].sort((a, b) => b.dealer - a.dealer).slice(0, 20),
                    dealerSell: [...d].sort((a, b) => a.dealer - b.dealer).slice(0, 20),
                    summary: aggregatedData.summary
                };
            }, [aggregatedData]);

            // --- Components ---
            const CustomTooltip = ({ active, payload }) => {
                if (active && payload && payload.length) {
                    const d = payload[0].payload;
                    return (
                        <div className={`p-3 border shadow-xl rounded-lg text-sm z-50`} style={{ backgroundColor: theme.tooltipBg, borderColor: theme.border, color: theme.tooltipText }}>
                            <p className="font-bold mb-1">{d.id} {d.name}</p>
                            <div className={`text-xs mb-2 border-b pb-1 opacity-70`} style={{ borderColor: theme.border }}>
                                çµ±è¨ˆå€é–“: {dateRange} æ—¥ç´¯è¨ˆ
                            </div>
                            <div className="space-y-1">
                                <div className="flex justify-between gap-4"><span className="text-blue-500">å¤–è³‡:</span> <span>{d.foreign.toLocaleString()} å¼µ</span></div>
                                <div className="flex justify-between gap-4"><span className="text-emerald-500">æŠ•ä¿¡:</span> <span>{d.trust.toLocaleString()} å¼µ</span></div>
                                <div className="flex justify-between gap-4"><span className="text-amber-500">è‡ªç‡Ÿ:</span> <span>{d.dealer.toLocaleString()} å¼µ</span></div>
                                <div className="border-t pt-1 mt-1 font-bold flex justify-between gap-4" style={{ borderColor: theme.border }}>
                                    <span>åˆè¨ˆ:</span> <span>{d.total.toLocaleString()} å¼µ</span>
                                </div>
                            </div>
                        </div>
                    );
                }
                return null;
            };

            const ChartSection = ({ title, icon: Icon, data, dataKey, color, colorName, currentDate, chartMode, setChartMode }) => {
                const [isMaximized, setIsMaximized] = useState(false);

                // è™•ç†è³‡æ–™ï¼šå°‡æ­£è² å€¼æ‹†åˆ†ä»¥æ­£ç¢ºå †ç–Š
                const processedData = useMemo(() => {
                    if (dataKey !== 'total' || chartMode !== 'stacked') return data;
                    return data.map(item => ({
                        ...item,
                        foreignPos: item.foreign > 0 ? item.foreign : 0,
                        foreignNeg: item.foreign < 0 ? item.foreign : 0,
                        trustPos: item.trust > 0 ? item.trust : 0,
                        trustNeg: item.trust < 0 ? item.trust : 0,
                        dealerPos: item.dealer > 0 ? item.dealer : 0,
                        dealerNeg: item.dealer < 0 ? item.dealer : 0,
                    }));
                }, [data, dataKey, chartMode]);

                const containerClasses = isMaximized
                    ? `fixed inset-4 z-50 p-6 rounded-xl shadow-2xl border flex flex-col theme-transition ${theme.card} ${theme.border}`
                    : `p-6 rounded-xl shadow-sm border h-[400px] flex flex-col theme-transition relative ${theme.card} ${theme.border}`;

                // v4.0 Update: Yè»¸æ ¼å¼åŒ–ï¼Œé¡¯ç¤ºå¼µæ•¸ï¼Œè¶…éåƒå¼µé¡¯ç¤º k
                const yAxisFormatter = (val) => {
                    const absVal = Math.abs(val);
                    if (absVal >= 1000) return `${(val / 1000).toFixed(1)}k`;
                    return val;
                };

                return (
                    <>
                        {isMaximized && <div className="fixed inset-0 bg-black/50 z-40 backdrop-blur-sm" onClick={() => setIsMaximized(false)} />}
                        <div className={containerClasses}>
                            <div className="flex items-center justify-between mb-4 shrink-0">
                                <div className="flex items-center gap-2">
                                    <div className={`p-2 rounded-lg bg-opacity-10`} style={{ backgroundColor: colorName ? 'transparent' : 'rgba(99, 102, 241, 0.1)' }}>{Icon && <Icon className={`w-5 h-5 ${color}`} />}</div>
                                    <h3 className={`text-lg font-bold ${theme.text}`}>{title} <span className={`text-xs font-normal ml-2 ${theme.textMuted}`}>({dateRange}æ—¥ç´¯è¨ˆ)</span></h3>
                                </div>
                                <div className="flex gap-2">
                                    {/* åƒ…åœ¨ç¸½è¦½æ¨¡å¼ä¸‹é¡¯ç¤ºåˆ‡æ›æŒ‰éˆ• */}
                                    {dataKey === 'total' && (
                                        <div className={`flex rounded-lg border text-xs p-0.5 ${theme.border}`}>
                                            <button onClick={() => setChartMode('net')} className={`px-2 py-1 rounded transition-colors ${chartMode === 'net' ? 'bg-indigo-500 text-white' : theme.textMuted}`}>æ·¨å€¼</button>
                                            <button onClick={() => setChartMode('stacked')} className={`px-2 py-1 rounded transition-colors ${chartMode === 'stacked' ? 'bg-indigo-500 text-white' : theme.textMuted}`}>å †ç–Š</button>
                                        </div>
                                    )}
                                    <button onClick={() => setIsMaximized(!isMaximized)} className={`p-2 rounded-lg hover:bg-black/5 ${theme.textMuted}`}>{isMaximized ? <Minimize2 className="w-5 h-5" /> : <Maximize2 className="w-5 h-5" />}</button>
                                </div>
                            </div>
                            {isMaximized && <div className={`text-center mb-4 pb-2 border-b ${theme.border}`}><h2 className={`text-2xl font-bold ${theme.text} flex items-center justify-center gap-2`}><Calendar className="w-6 h-6" /> {formatDateToDisplay(formatDateToTWSE(currentDate))}</h2></div>}
                            <div className="flex-1 min-h-0">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={processedData} margin={{ top: 20, right: 30, left: 10, bottom: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={theme.grid} />
                                        <XAxis dataKey="name" tick={{ fontSize: isMaximized ? 14 : 12, fill: theme.chartText }} interval={0} angle={-45} textAnchor="end" height={100} stroke={theme.grid} />
                                        <YAxis tickFormatter={yAxisFormatter} width={65} tick={{ fill: theme.chartText }} stroke={theme.grid} />
                                        <Tooltip content={<CustomTooltip />} cursor={{ fill: theme.text === 'text-slate-200' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' }} />
                                        <ReferenceLine y={0} stroke={theme.zeroLine} strokeWidth={2} />

                                        {/* æ ¹æ“š chartMode æ±ºå®šé¡¯ç¤ºæ–¹å¼ */}
                                        {dataKey === 'total' ? (
                                            chartMode === 'net' ? (
                                                <Bar dataKey="total" fill={color} isAnimationActive={false}>
                                                    {
                                                        data.map((entry, index) => (
                                                            <Cell key={`cell-${index}`} fill={entry.total > 0 ? '#ef4444' : '#22c55e'} />
                                                        ))
                                                    }
                                                </Bar>
                                            ) : (
                                                <>
                                                    {/* æ­£å€¼å †ç–Š (å‘ä¸Š) */}
                                                    <Bar dataKey="foreignPos" stackId="up" fill="#3b82f6" isAnimationActive={false} />
                                                    <Bar dataKey="trustPos" stackId="up" fill="#10b981" isAnimationActive={false} />
                                                    <Bar dataKey="dealerPos" stackId="up" fill="#f59e0b" isAnimationActive={false} />

                                                    {/* è² å€¼å †ç–Š (å‘ä¸‹) */}
                                                    <Bar dataKey="foreignNeg" stackId="down" fill="#3b82f6" isAnimationActive={false} />
                                                    <Bar dataKey="trustNeg" stackId="down" fill="#10b981" isAnimationActive={false} />
                                                    <Bar dataKey="dealerNeg" stackId="down" fill="#f59e0b" isAnimationActive={false} />
                                                </>
                                            )
                                        ) : (
                                            <Bar dataKey={dataKey} fill={dataKey === 'foreign' ? '#3b82f6' : dataKey === 'trust' ? '#10b981' : '#f59e0b'} isAnimationActive={false} />
                                        )}
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </>
                );
            };

            const MoneyCard = ({ title, amount, color }) => (
                <div className={`p-4 rounded-xl border flex-1 ${theme.card} ${theme.border}`}>
                    <div className={`text-xs ${theme.textMuted} mb-1`}>{title}</div>
                    <div className={`text-lg font-bold ${amount > 0 ? 'text-red-500' : amount < 0 ? 'text-green-500' : theme.textMuted}`}>
                        {amount > 0 ? '+' : ''}{formatMoney(amount)}
                    </div>
                </div>
            );

            return (
                <div className={`min-h-screen font-sans theme-transition ${theme.bg} ${theme.text}`}>
                    {showManual && <ManualModal onClose={() => setShowManual(false)} theme={theme} />}

                    <header className={`p-4 shadow-md sticky top-0 z-20 theme-transition ${theme.header} text-white`}>
                        <div className="max-w-7xl mx-auto flex flex-col xl:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4 w-full xl:w-auto">
                                <h1 className="text-xl font-bold flex items-center gap-2"><TrendingUp className="w-6 h-6 text-emerald-400" /> å°è‚¡ä¸‰å¤§æ³•äººç±Œç¢¼åˆ†æ <span className="text-xs bg-indigo-500 px-2 py-0.5 rounded text-white">v4.0 (å¼µ)</span></h1>
                                <button onClick={() => setShowManual(true)} className="flex items-center gap-1 text-xs bg-white/10 hover:bg-white/20 px-2 py-1.5 rounded transition-colors"><BookOpen className="w-4 h-4" /> æ‰‹å†Š</button>
                                <div className="flex bg-opacity-20 bg-white rounded-lg p-1">
                                    {['light', 'warm', 'dark'].map(t => <button key={t} onClick={() => setCurrentTheme(t)} className={`p-1.5 rounded ${currentTheme === t ? 'bg-white text-black shadow' : 'text-slate-400 hover:text-white'}`}>{t === 'light' ? <Sun className="w-4 h-4" /> : t === 'warm' ? <Coffee className="w-4 h-4" /> : <Moon className="w-4 h-4" />}</button>)}
                                </div>
                                <button onClick={() => setShowSettings(!showSettings)} className="ml-auto p-2 hover:bg-white/10 rounded-full xl:hidden"><Settings className="w-5 h-5" /></button>
                            </div>
                            <div className="flex flex-wrap items-center gap-2 bg-white/10 p-2 rounded-lg border border-white/10 w-full xl:w-auto justify-center">
                                <div className="flex items-center bg-black/20 rounded px-3 py-1.5 border border-white/10"><Calendar className="w-4 h-4 text-slate-300 mr-2" /><input type="date" value={currentDate} onChange={(e) => setCurrentDate(e.target.value)} className="bg-transparent text-white text-sm outline-none w-[130px]" style={{ colorScheme: 'dark' }} /></div>
                                <button onClick={fetchRealData} disabled={loading} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium min-w-[100px]"><RefreshCw className={`w-3.5 h-3.5 ${loading && 'animate-spin'}`} /> {loading ? `é‡è©¦(${retryCount})...` : 'æŠ“å– T86'}</button>
                                <div className="w-px h-6 bg-white/20 mx-1 hidden sm:block"></div>
                                <div className="flex items-center gap-1">
                                    <label className="flex items-center gap-2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 rounded cursor-pointer text-sm font-medium whitespace-nowrap" title="æ”¯æ´ T86(å€‹è‚¡) èˆ‡ BFI82U(é‡‘é¡) å…©ç¨® CSV">
                                        <Upload className="w-3.5 h-3.5" /> åŒ¯å…¥
                                        <input type="file" accept=".csv,.json" className="hidden" onChange={handleFileUpload} />
                                    </label>
                                    <div className="flex flex-col gap-0.5">
                                        <a href="https://www.twse.com.tw/zh/trading/foreign/t86.html" target="_blank" className="flex items-center justify-center w-5 h-4 bg-white/10 hover:bg-white/20 rounded text-[10px] text-emerald-400" title="ä¸‹è¼‰å¼µæ•¸(T86)">è‚¡</a>
                                        <a href="https://www.twse.com.tw/zh/trading/foreign/bfi82u.html" target="_blank" className="flex items-center justify-center w-5 h-4 bg-white/10 hover:bg-white/20 rounded text-[10px] text-emerald-400" title="ä¸‹è¼‰é‡‘é¡(BFI82U)">é‡‘</a>
                                    </div>
                                </div>
                                <div className="w-px h-6 bg-white/20 mx-1 hidden sm:block"></div>
                                <div className="flex items-center gap-2 bg-black/20 rounded px-3 py-1.5 border border-white/10"><span className="text-xs text-slate-300 whitespace-nowrap w-12">çµ±è¨ˆ {dateRange} æ—¥</span><input type="range" min="1" max={maxDateRange} value={dateRange} onChange={(e) => setDateRange(Number(e.target.value))} className="w-24 h-1.5 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-indigo-500" disabled={maxDateRange <= 1} /><span className="text-[10px] text-slate-500 w-6 text-right">/{maxDateRange}</span></div>
                                <button onClick={() => setShowSettings(!showSettings)} className="ml-2 p-1.5 hover:bg-white/10 rounded hidden xl:block"><Settings className="w-5 h-5 text-slate-300" /></button>
                            </div>
                        </div>
                        {showSettings && (
                            <div className={`max-w-7xl mx-auto mt-4 p-4 rounded-lg border theme-transition animate-in slide-in-from-top-2 ${theme.card} ${theme.border} text-slate-800`}>
                                <div className="flex justify-between items-start mb-4 border-b pb-2" style={{ borderColor: theme.border }}><h3 className={`text-sm font-bold flex items-center gap-2 ${theme.text}`}><Settings className="w-4 h-4" /> è¨­å®š</h3><button onClick={() => setShowSettings(false)}><X className={`w-4 h-4 ${theme.text}`} /></button></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="space-y-4">
                                        <div><h4 className={`text-xs font-bold mb-2 ${theme.textMuted}`}>è³‡æ–™å‚™ä»½</h4><div className="flex gap-2"><button onClick={downloadBackup} className="flex-1 flex justify-center items-center gap-2 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs"><FileJson className="w-4 h-4" /> ä¸‹è¼‰å‚™ä»½ (JSON)</button></div></div>
                                        <div className="pt-2 border-t" style={{ borderColor: theme.border }}><h4 className={`text-xs font-bold mb-2 ${theme.textMuted}`}>Proxy</h4><div className="flex gap-2"><input type="text" value={proxyUrl} onChange={(e) => setProxyUrl(e.target.value)} className={`w-full border rounded px-3 py-2 text-xs ${currentTheme === 'dark' ? 'bg-slate-900 text-white border-slate-600' : ''}`} /><button onClick={() => setProxyUrl(PROXY_CANDIDATES[0])} className="px-3 py-1 text-xs rounded bg-slate-200">é‡ç½®</button></div></div>
                                        <div className="pt-2 border-t" style={{ borderColor: theme.border }}><h4 className={`text-xs font-bold mb-2 ${theme.textMuted}`}>è³‡æ–™åº«ç®¡ç†</h4><button onClick={clearAllData} className="w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-xs flex items-center justify-center gap-2"><Trash2 className="w-4 h-4" /> æ¸…é™¤æ‰€æœ‰è³‡æ–™ (å»ºè­°å‡ç´šå¾ŒåŸ·è¡Œ)</button></div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between items-center mb-2"><h4 className={`text-xs font-bold ${theme.textMuted}`}>è³‡æ–™åº« ({storedDatesList.length} å¤©)</h4><div className="flex gap-2"><button onClick={toggleAllDates} className="text-xs px-2 py-1 bg-slate-100 rounded">å…¨é¸</button>{selectedDates.size > 0 && <button onClick={deleteSelectedData} className="text-xs px-2 py-1 bg-red-600 text-white rounded">åˆªé™¤ ({selectedDates.size})</button>}</div></div>
                                        <div className={`border rounded-lg overflow-hidden max-h-[200px] overflow-y-auto custom-scrollbar ${theme.border} ${currentTheme === 'dark' ? 'bg-slate-900' : ''}`}>{storedDatesList.map(d => <div key={d} className="flex justify-between p-2 border-b text-xs items-center"><input type="checkbox" checked={selectedDates.has(d)} onChange={() => toggleDateSelection(d)} className="mr-2" /><span className={theme.text}>{formatDateToDisplay(d)}</span><button onClick={() => deleteSingleDate(d)} className="text-slate-400 hover:text-red-500"><Trash2 className="w-3 h-3" /></button></div>)}</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        {error && <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded text-red-700 text-sm flex justify-between items-center"><div className="flex items-center gap-2"><AlertCircle className="w-5 h-5" /> {error}</div>{error.includes("ä¸è¶³") && <button onClick={clearAllData} className="px-3 py-1 bg-red-600 text-white rounded text-xs">æ¸…é™¤è³‡æ–™</button>}</div>}

                        {stats ? (
                            <>
                                <div className={`px-4 py-3 rounded-lg shadow-sm border flex flex-col gap-4 ${theme.card} ${theme.border}`}>
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2"><Database className="w-4 h-4 text-indigo-500" /><span className={`font-bold ${theme.text}`}>{formatDateToDisplay(formatDateToTWSE(currentDate))}</span><span className={`px-2 py-0.5 text-xs font-bold rounded border ${theme.textMuted}`}>{dateRange}æ—¥ç´¯è¨ˆ</span></div>
                                        {dateRange > 1 && <div className={`text-xs ${theme.textMuted}`}>æœ‰æ•ˆäº¤æ˜“æ—¥: <span className="font-bold text-indigo-600">{aggregatedData.summary ? aggregatedData.summary.count : 0}</span> å¤©</div>}
                                    </div>

                                    {/* è³‡é‡‘æµå‘çœ‹æ¿ */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4" style={{ borderColor: theme.border }}>
                                        {stats.summary ? (
                                            <>
                                                <div className="flex items-center gap-2 md:col-span-3 mb-1"><DollarSign className={`w-4 h-4 ${theme.textMuted}`} /><h4 className={`text-sm font-bold ${theme.text}`}>ä¸‰å¤§æ³•äººè²·è³£è¶…é‡‘é¡ ({dateRange}æ—¥åˆè¨ˆ)</h4></div>
                                                <MoneyCard title="å¤–è³‡åŠé™¸è³‡" amount={stats.summary.foreign} />
                                                <MoneyCard title="æŠ•ä¿¡" amount={stats.summary.trust} />
                                                <MoneyCard title="è‡ªç‡Ÿå•† (è‡ªè¡Œ+é¿éšª)" amount={stats.summary.dealer} />
                                            </>
                                        ) : (
                                            <div className={`md:col-span-3 text-center py-2 text-xs ${theme.infoText} rounded ${theme.infoBg}`}>
                                                å°šç„¡é‡‘é¡è³‡æ–™ (è‹¥ä½¿ç”¨ CSV åŒ¯å…¥ï¼Œè«‹è¨˜å¾—é¡å¤–åŒ¯å…¥ BFI82U å ±è¡¨)
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className={`flex overflow-x-auto gap-2 pb-2 border-b scrollbar-hide ${theme.border}`}>
                                    {[{ id: 'overview', label: 'ç¸½è¦½æˆ°æƒ…', icon: Layers }, { id: 'comovement', label: 'åœŸæ´‹åˆä½œ', icon: Users }, { id: 'foreign', label: 'å¤–è³‡æ’è¡Œ', icon: Globe }, { id: 'trust', label: 'æŠ•ä¿¡æ’è¡Œ', icon: Landmark }, { id: 'dealer', label: 'è‡ªç‡Ÿå•†æ’è¡Œ', icon: Briefcase }].map(tab => (
                                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-5 py-3 rounded-t-lg font-bold text-sm whitespace-nowrap border-t border-x border-b-0 ${activeTab === tab.id ? `${theme.card} ${theme.text} ${theme.border} translate-y-[1px]` : `bg-transparent border-transparent ${theme.textMuted} hover:${theme.text} hover:bg-black/5`}`}>{React.createElement(tab.icon, { className: `w-4 h-4 ${activeTab === tab.id ? 'text-indigo-500' : ''}` })}{tab.label}</button>
                                    ))}
                                </div>

                                <div className="space-y-6">
                                    {activeTab === 'overview' && (
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-in fade-in zoom-in duration-300">
                                            <ChartSection
                                                title="åˆè¨ˆè²·è¶… Top 15ï¼šå¼µæ•¸" icon={ArrowUp}
                                                data={stats.totalBuy} dataKey="total" color="text-red-600"
                                                currentDate={currentDate} chartMode={chartMode} setChartMode={setChartMode}
                                            />
                                            <ChartSection
                                                title="åˆè¨ˆè³£è¶… Top 15ï¼šå¼µæ•¸" icon={ArrowDown}
                                                data={stats.totalSell} dataKey="total" color="text-green-600"
                                                currentDate={currentDate} chartMode={chartMode} setChartMode={setChartMode}
                                            />
                                            <div className={`lg:col-span-2 rounded-xl shadow-sm border overflow-hidden theme-transition ${theme.card} ${theme.border}`}>
                                                <div className={`px-6 py-4 border-b ${theme.border}`}><h3 className={`font-bold ${theme.text}`}>è©³ç´°æ•¸æ“šåˆ—è¡¨ (å‰ 50 ç­†)ï¼šå¼µæ•¸</h3></div>
                                                <div className="overflow-x-auto max-h-[500px]">
                                                    <table className={`w-full text-sm text-left ${theme.text}`}>
                                                        <thead className={`font-medium sticky top-0 z-10 shadow-sm ${currentTheme === 'dark' ? 'bg-slate-800 text-slate-400' : 'bg-slate-50 text-slate-500'}`}><tr><th className="px-6 py-3">ä»£è™Ÿ</th><th className="px-6 py-3">åç¨±</th><th className="px-6 py-3 text-right">å¤–è³‡(å¼µ)</th><th className="px-6 py-3 text-right">æŠ•ä¿¡(å¼µ)</th><th className="px-6 py-3 text-right">è‡ªç‡Ÿå•†(å¼µ)</th><th className="px-6 py-3 text-right">åˆè¨ˆ(å¼µ)</th></tr></thead>
                                                        <tbody className={`divide-y ${currentTheme === 'dark' ? 'divide-slate-700' : 'divide-slate-100'}`}>{stats.totalBuy.concat(stats.totalSell).slice(0, 50).map(r => <tr key={r.id} className={`transition-colors ${currentTheme === 'dark' ? 'hover:bg-slate-800' : 'hover:bg-slate-50'}`}><td className={`px-6 py-3 font-mono ${theme.textMuted}`}>{r.id}</td><td className="px-6 py-3 font-medium">{r.name}</td><td className={`px-6 py-3 text-right ${r.foreign > 0 ? 'text-red-600' : r.foreign < 0 ? 'text-green-600' : theme.textMuted}`}>{r.foreign.toLocaleString()}</td><td className={`px-6 py-3 text-right ${r.trust > 0 ? 'text-red-600' : r.trust < 0 ? 'text-green-600' : theme.textMuted}`}>{r.trust.toLocaleString()}</td><td className={`px-6 py-3 text-right ${r.dealer > 0 ? 'text-red-600' : r.dealer < 0 ? 'text-green-600' : theme.textMuted}`}>{r.dealer.toLocaleString()}</td><td className={`px-6 py-3 text-right font-bold ${r.total > 0 ? 'text-red-600' : r.total < 0 ? 'text-green-600' : theme.textMuted}`}>{r.total.toLocaleString()}</td></tr>)}</tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {activeTab === 'comovement' && (
                                        <div className="grid grid-cols-1 gap-6 animate-in fade-in duration-300">
                                            <div className={`rounded-xl shadow-sm border overflow-hidden theme-transition ${theme.card} ${theme.border}`}>
                                                <div className={`px-6 py-4 border-b flex items-center gap-2 ${theme.border} ${currentTheme === 'dark' ? 'bg-red-900/20' : 'bg-red-50'}`}><TrendingUp className="w-5 h-5 text-red-600" /><h3 className={`font-bold ${currentTheme === 'dark' ? 'text-red-400' : 'text-red-800'}`}>ä¸‰æ³•åŒæ­¥è²·è¶…(å¼µæ•¸)</h3></div>
                                                {stats.coBuy.length > 0 ? <div className="overflow-x-auto"><table className={`w-full text-sm text-left ${theme.text}`}><thead className={theme.textMuted}><tr><th className="px-6 py-3">ä»£è™Ÿ</th><th className="px-6 py-3">åç¨±</th><th className="px-6 py-3 text-right">å¤–è³‡</th><th className="px-6 py-3 text-right">æŠ•ä¿¡</th><th className="px-6 py-3 text-right">è‡ªç‡Ÿ</th><th className="px-6 py-3 text-right">åˆè¨ˆ</th></tr></thead><tbody className={`divide-y ${currentTheme === 'dark' ? 'divide-slate-700' : 'divide-slate-100'}`}>{stats.coBuy.map(r => <tr key={r.id} className={`transition-colors ${currentTheme === 'dark' ? 'hover:bg-red-900/10' : 'hover:bg-red-50/50'}`}><td className={`px-6 py-3 font-mono ${theme.textMuted}`}>{r.id}</td><td className="px-6 py-3 font-bold">{r.name}</td><td className="px-6 py-3 text-right text-red-600">{r.foreign.toLocaleString()}</td><td className="px-6 py-3 text-right text-red-600">{r.trust.toLocaleString()}</td><td className="px-6 py-3 text-right text-red-600">{r.dealer.toLocaleString()}</td><td className="px-6 py-3 text-right font-bold text-red-600">{r.total.toLocaleString()}</td></tr>)}</tbody></table></div> : <div className={`p-8 text-center ${theme.textMuted}`}>ç„¡è³‡æ–™</div>}
                                            </div>
                                            <div className={`rounded-xl shadow-sm border overflow-hidden theme-transition ${theme.card} ${theme.border}`}>
                                                <div className={`px-6 py-4 border-b flex items-center gap-2 ${theme.border} ${currentTheme === 'dark' ? 'bg-green-900/20' : 'bg-green-50'}`}><TrendingDown className="w-5 h-5 text-green-600" /><h3 className={`font-bold ${currentTheme === 'dark' ? 'text-green-400' : 'text-green-800'}`}>ä¸‰æ³•åŒæ­¥è³£è¶…(å¼µæ•¸)</h3></div>
                                                {stats.coSell.length > 0 ? <div className="overflow-x-auto"><table className={`w-full text-sm text-left ${theme.text}`}><thead className={theme.textMuted}><tr><th className="px-6 py-3">ä»£è™Ÿ</th><th className="px-6 py-3">åç¨±</th><th className="px-6 py-3 text-right">å¤–è³‡</th><th className="px-6 py-3 text-right">æŠ•ä¿¡</th><th className="px-6 py-3 text-right">è‡ªç‡Ÿ</th><th className="px-6 py-3 text-right">åˆè¨ˆ</th></tr></thead><tbody className={`divide-y ${currentTheme === 'dark' ? 'divide-slate-700' : 'divide-slate-100'}`}>{stats.coSell.map(r => <tr key={r.id} className={`transition-colors ${currentTheme === 'dark' ? 'hover:bg-green-900/10' : 'hover:bg-green-50/50'}`}><td className={`px-6 py-3 font-mono ${theme.textMuted}`}>{r.id}</td><td className="px-6 py-3 font-bold">{r.name}</td><td className="px-6 py-3 text-right text-green-600">{r.foreign.toLocaleString()}</td><td className="px-6 py-3 text-right text-green-600">{r.trust.toLocaleString()}</td><td className="px-6 py-3 text-right text-green-600">{r.dealer.toLocaleString()}</td><td className="px-6 py-3 text-right font-bold text-green-600">{r.total.toLocaleString()}</td></tr>)}</tbody></table></div> : <div className={`p-8 text-center ${theme.textMuted}`}>ç„¡è³‡æ–™</div>}
                                            </div>
                                        </div>
                                    )}
                                    {activeTab === 'foreign' && <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-in fade-in duration-300"><ChartSection title="å¤–è³‡ è²·è¶… Top 20(å¼µæ•¸)" icon={Globe} data={stats.foreignBuy} dataKey="foreign" color="text-blue-600" colorName="å¤–è³‡" currentDate={currentDate} /><ChartSection title="å¤–è³‡ è³£è¶… Top 20(å¼µæ•¸)" icon={Globe} data={stats.foreignSell} dataKey="foreign" color="text-blue-600" colorName="å¤–è³‡" currentDate={currentDate} /></div>}
                                    {activeTab === 'trust' && <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-in fade-in duration-300"><ChartSection title="æŠ•ä¿¡ è²·è¶… Top 20(å¼µæ•¸)" icon={Landmark} data={stats.trustBuy} dataKey="trust" color="text-emerald-600" colorName="æŠ•ä¿¡" currentDate={currentDate} /><ChartSection title="æŠ•ä¿¡ è³£è¶… Top 20(å¼µæ•¸)" icon={Landmark} data={stats.trustSell} dataKey="trust" color="text-emerald-600" colorName="æŠ•ä¿¡" currentDate={currentDate} /></div>}
                                    {activeTab === 'dealer' && <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-in fade-in duration-300"><ChartSection title="è‡ªç‡Ÿå•† è²·è¶… Top 20(å¼µæ•¸)" icon={Briefcase} data={stats.dealerBuy} dataKey="dealer" color="text-amber-600" colorName="è‡ªç‡Ÿå•†" currentDate={currentDate} /><ChartSection title="è‡ªç‡Ÿå•† è³£è¶… Top 20(å¼µæ•¸)" icon={Briefcase} data={stats.dealerSell} dataKey="dealer" color="text-amber-600" colorName="è‡ªç‡Ÿå•†" currentDate={currentDate} /></div>}
                                </div>
                            </>
                        ) : (
                            <div className={`text-center py-20 border-2 border-dashed rounded-xl ${theme.border} bg-opacity-50`}><FileText className={`w-16 h-16 mx-auto mb-4 ${theme.textMuted}`} /><h3 className={`text-lg font-medium ${theme.text}`}>å°šç„¡ {currentDate} çš„æ•¸æ“š</h3><p className={`${theme.textMuted} text-sm mt-2 max-w-md mx-auto`}>è«‹é»æ“Šä¸Šæ–¹ <span className="text-indigo-500 font-bold">ã€ŒæŠ“å– T86ã€</span> æˆ– <span className="text-emerald-500 font-bold">ã€ŒåŒ¯å…¥ CSVã€</span> ä¾†å»ºç«‹è³‡æ–™åº«ã€‚</p></div>
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>