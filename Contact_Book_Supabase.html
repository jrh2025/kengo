<!DOCTYPE html>
<html lang="zh-TW" class="theme-light"> <!-- 預設主題 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生家庭聯絡簿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f9fafb; --bg-accent: #f3f4f6;
            --text-primary: #1f2937; --text-secondary: #4b5563; --text-accent: #111827;
            --border-color: #e5e7eb; --brand-color: #3b82f6; --brand-text: #ffffff;
            --brand-hover: #2563eb;
        }
        html.theme-dark {
            --bg-primary: #1f2937; --bg-secondary: #374151; --bg-accent: #4b5563;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-accent: #ffffff;
            --border-color: #4b5563; --brand-color: #60a5fa; --brand-text: #1f2937;
            --brand-hover: #3b82f6;
        }
        html.theme-warm {
            --bg-primary: #fffaf0; --bg-secondary: #fef3c7; --bg-accent: #fde68a;
            --text-primary: #78350f; --text-secondary: #92400e; --text-accent: #000000;
            --border-color: #fcd34d; --brand-color: #f97316; --brand-text: #ffffff;
            --brand-hover: #ea580c;
        }
        html.theme-cool {
            --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-accent: #bae6fd;
            --text-primary: #075985; --text-secondary: #0369a1; --text-accent: #0c4a6e;
            --border-color: #7dd3fc; --brand-color: #0ea5e9; --brand-text: #ffffff;
            --brand-hover: #0284c7;
        }
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-accent);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .main-container { background-color: var(--bg-primary); }
        .calendar-container { background-color: var(--bg-secondary); border-color: var(--border-color); }
        .calendar-day.today { background-color: var(--bg-accent); color: var(--text-accent); }
        .calendar-day.selected { background-color: var(--brand-color); color: var(--brand-text); }
        .calendar-day:disabled { background-color: transparent; color: #d1d5db; cursor: not-allowed; }
        html.theme-dark .calendar-day:disabled { color: #4b5563; }
        .content-area { background-color: var(--bg-secondary); }
        .btn-brand { background-color: var(--brand-color); color: var(--brand-text); }
        .btn-brand:hover { background-color: var(--brand-hover); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: var(--bg-primary); }
        .form-input { background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        .theme-button.active { box-shadow: 0 0 0 2px var(--brand-color); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto rounded-2xl shadow-lg flex flex-col md:flex-row overflow-hidden main-container" style="height: 85vh;">
        
        <!-- Left Panel -->
        <div class="w-full md:w-1/3 p-6 border-b md:border-b-0 md:border-r flex flex-col calendar-container">
            <h2 id="app-title" class="text-xl font-bold mb-4">學生家庭聯絡簿</h2>
            <!-- Calendar -->
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200/50"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <h3 id="month-year" class="font-bold text-lg"></h3>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-200/50"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
            </div>
            <div class="grid grid-cols-7 text-center text-sm text-gray-500 mb-2">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div id="calendar-body" class="grid grid-cols-7 gap-1 flex-grow"></div>
            <!-- Admin Buttons -->
            <div class="mt-auto pt-4 space-y-2">
                <button id="settings-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 hidden">應用程式設定</button>
                <button id="admin-login-btn" class="w-full py-2 px-4 rounded-lg transition-colors duration-300 btn-brand">管理員登入</button>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="w-full md:w-2/3 p-6 md:p-8 flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <button id="prev-day" class="flex items-center hover:text-blue-500 transition-colors"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>前一天</button>
                <h1 id="current-date" class="text-2xl font-bold text-center"></h1>
                <button id="next-day" class="flex items-center hover:text-blue-500 transition-colors">後一天<svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
            </div>
            <div id="content-area" class="flex-grow p-4 rounded-lg overflow-y-auto prose max-w-none content-area"></div>
            
            <!-- Bottom Controls Area -->
            <div class="mt-auto pt-4 flex items-end justify-between">
                <!-- Theme Switcher -->
                <div>
                    <p class="text-sm mb-2">選擇主題</p>
                    <div class="flex justify-center space-x-2">
                        <button class="theme-button w-8 h-8 rounded-full bg-white border-2 border-gray-300" data-theme="light"></button>
                        <button class="theme-button w-8 h-8 rounded-full bg-gray-800 border-2 border-gray-600" data-theme="dark"></button>
                        <button class="theme-button w-8 h-8 rounded-full bg-amber-400 border-2 border-amber-500" data-theme="warm"></button>
                        <button class="theme-button w-8 h-8 rounded-full bg-sky-400 border-2 border-sky-500" data-theme="cool"></button>
                    </div>
                </div>
                <!-- Admin Controls -->
                <div id="admin-controls" class="text-right hidden">
                    <span id="mode-indicator" class="text-sm text-green-600 mr-4 font-medium"></span>
                    <button id="save-button" class="bg-green-500 text-white py-2 px-6 rounded-lg hover:bg-green-600">儲存變更</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-overlay">
        <div class="p-8 rounded-lg shadow-xl w-full max-w-sm modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center">管理員登入</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block mb-2 text-sm font-medium">Email</label>
                    <input type="email" id="email" class="form-input w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block mb-2 text-sm font-medium">密碼</label>
                    <input type="password" id="password" class="form-input w-full p-2 border rounded-md" required>
                </div>
                <button type="submit" class="w-full py-2 px-4 rounded-lg btn-brand">登入</button>
            </form>
            <button id="close-login-modal" class="absolute top-4 right-4 text-2xl">&times;</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-overlay">
        <div class="p-8 rounded-lg shadow-xl w-full max-w-md modal-content">
            <h2 class="text-2xl font-bold mb-6">應用程式設定</h2>
            <div class="space-y-6">
                <div>
                    <label for="title-input" class="block mb-2 text-sm font-medium">聯絡簿標題</label>
                    <input type="text" id="title-input" class="form-input w-full p-2 border rounded-md">
                </div>
                <div class="flex items-center justify-between">
                    <label for="future-toggle" class="text-sm font-medium">允許學生瀏覽未來日期</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="future-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-4">
                <button id="cancel-settings" class="py-2 px-4 rounded-lg bg-gray-200 hover:bg-gray-300">取消</button>
                <button id="save-settings" class="py-2 px-6 rounded-lg btn-brand">儲存設定</button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-lg z-[100] opacity-0 transition-opacity duration-300"></div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- Supabase Configuration ---
        const supabaseUrl = 'https://aceshglkffvdrpsdazwg.supabase.co'; // 貼上您的 Project URL
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZXNoZ2xrZmZ2ZHJwc2RhendnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNTA4NjksImV4cCI6MjA3MTkyNjg2OX0.5NnmnkJDMDSxnlMkICgrhTnj8VnDnYNvnkw7l20DC6Y'; // 貼上您的 anon public 金鑰
        
        if (supabaseUrl === 'YOUR_SUPABASE_URL' || supabaseKey === 'YOUR_SUPABASE_ANON_KEY') {
            document.body.innerHTML = `<div class="p-8 bg-red-100 border-l-4 border-red-500 text-red-700 w-full max-w-2xl mx-auto"><h2 class="font-bold text-xl mb-2">設定錯誤</h2><p>您尚未設定 Supabase 連線資訊。</p><p class="mt-2">請編輯 HTML 檔案，在 &lt;script&gt; 區塊中找到並填寫您自己的 <strong>Supabase Project URL</strong> 和 <strong>anon Key</strong>。</p></div>`;
            throw new Error("Supabase configuration is missing.");
        }
        
        const { createClient } = window.supabase;
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- DOM Elements ---
        const dom = {
            appTitle: document.getElementById('app-title'),
            currentDate: document.getElementById('current-date'),
            contentArea: document.getElementById('content-area'),
            adminLoginBtn: document.getElementById('admin-login-btn'),
            adminControls: document.getElementById('admin-controls'),
            saveButton: document.getElementById('save-button'),
            modeIndicator: document.getElementById('mode-indicator'),
            monthYear: document.getElementById('month-year'),
            calendarBody: document.getElementById('calendar-body'),
            prevDayBtn: document.getElementById('prev-day'),
            nextDayBtn: document.getElementById('next-day'),
            prevMonthBtn: document.getElementById('prev-month'),
            nextMonthBtn: document.getElementById('next-month'),
            toast: document.getElementById('toast-notification'),
            loginModal: {
                el: document.getElementById('login-modal'),
                form: document.getElementById('login-form'),
                closeBtn: document.getElementById('close-login-modal'),
                emailInput: document.getElementById('email'),
                passwordInput: document.getElementById('password')
            },
            settings: {
                btn: document.getElementById('settings-btn'),
                modal: document.getElementById('settings-modal'),
                titleInput: document.getElementById('title-input'),
                futureToggle: document.getElementById('future-toggle'),
                saveBtn: document.getElementById('save-settings'),
                cancelBtn: document.getElementById('cancel-settings')
            }
        };

        // --- State ---
        let state = {
            currentDate: new Date(),
            calendarDate: new Date(),
            isAdmin: false,
            realtimeChannel: null,
            settings: {
                title: '學生家庭聯絡簿',
                allow_future_browsing: false
            }
        };

        // --- Utility Functions ---
        const formatDate = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const displayDate = (date) => date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        const showToast = (message) => {
            dom.toast.textContent = message;
            dom.toast.style.opacity = 1;
            setTimeout(() => { dom.toast.style.opacity = 0; }, 3000);
        };

        // --- Theming ---
        const applyTheme = (theme) => {
            document.documentElement.className = `theme-${theme}`;
            localStorage.setItem('contact-book-theme', theme);
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
        };
        document.querySelectorAll('.theme-button').forEach(btn => {
            btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
        });

        // --- Modals ---
        const showModal = (modal) => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };
        const hideModal = (modal) => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        // --- Data Handling ---
        const loadSettings = async () => {
            const { data, error } = await supabase.from('settings').select('*').eq('id', 1).single();
            if (data) {
                state.settings = data;
                dom.appTitle.textContent = data.title;
                document.title = data.title;
            } else {
                console.warn("Could not load settings, using defaults.", error);
            }
        };

        const listenToContentChanges = async () => {
            const dateKey = formatDate(state.currentDate);
            const { data, error } = await supabase.from('contact_book').select('content').eq('date', dateKey).single();
            if (error && error.code !== 'PGRST116') console.error("Error fetching data:", error);
            dom.contentArea.innerHTML = data?.content || (state.isAdmin ? "<h1>點此開始編輯今天的新內容...</h1>" : "<p>今天沒有內容喔！</p>");
            
            if (state.realtimeChannel) supabase.removeChannel(state.realtimeChannel);
            state.realtimeChannel = supabase.channel(`public:contact_book:date=eq.${dateKey}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'contact_book', filter: `date=eq.${dateKey}` }, payload => {
                    dom.contentArea.innerHTML = payload.new.content || (state.isAdmin ? "<h1>點此開始編輯今天的新內容...</h1>" : "<p>今天沒有內容喔！</p>");
                }).subscribe();
        };

        // --- View Updates ---
        const updateView = () => {
            dom.currentDate.textContent = displayDate(state.currentDate);
            updateNextDayButtonState();
            renderCalendar();
            listenToContentChanges();
        };

        const updateNextDayButtonState = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isFuture = state.currentDate >= today; // Use >= to include today
            const isDisabled = isFuture && !state.isAdmin && !state.settings.allow_future_browsing;
            dom.nextDayBtn.disabled = isDisabled;
            dom.nextDayBtn.classList.toggle('text-gray-400', isDisabled);
            dom.nextDayBtn.classList.toggle('cursor-not-allowed', isDisabled);
        };
        
        const renderCalendar = () => {
            state.calendarDate.setDate(1);
            const month = state.calendarDate.getMonth(), year = state.calendarDate.getFullYear();
            dom.monthYear.textContent = `${year}年 ${month + 1}月`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            dom.calendarBody.innerHTML = '';
            for (let i = 0; i < firstDay; i++) dom.calendarBody.innerHTML += `<div></div>`;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayFmt = formatDate(today), currentFmt = formatDate(state.currentDate);

            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('button');
                const loopDate = new Date(year, month, i);
                dayEl.textContent = i;
                dayEl.className = 'calendar-day p-2 rounded-full hover:bg-gray-200/50 focus:outline-none';
                const loopFmt = formatDate(loopDate);
                if (loopFmt === todayFmt) dayEl.classList.add('today');
                if (loopFmt === currentFmt) dayEl.classList.add('selected');
                
                // --- BUG FIX STARTS HERE ---
                // 檢查是否為未來日期，並根據設定決定是否禁用
                const isFuture = loopDate > today;
                const isDisabled = isFuture && !state.isAdmin && !state.settings.allow_future_browsing;
                dayEl.disabled = isDisabled;
                // --- BUG FIX ENDS HERE ---

                if (!isDisabled) {
                    dayEl.onclick = () => { state.currentDate = new Date(year, month, i); updateView(); };
                }
                dom.calendarBody.appendChild(dayEl);
            }
        };

        // --- Auth & Admin ---
        supabase.auth.onAuthStateChange((event, session) => {
            state.isAdmin = !!session?.user;
            dom.contentArea.contentEditable = state.isAdmin;
            dom.adminControls.classList.toggle('hidden', !state.isAdmin);
            dom.settings.btn.classList.toggle('hidden', !state.isAdmin);
            if (state.isAdmin) {
                dom.adminLoginBtn.textContent = '登出管理員';
                dom.adminLoginBtn.classList.replace('bg-blue-500', 'bg-red-500');
                dom.modeIndicator.textContent = '管理員模式';
            } else {
                dom.adminLoginBtn.textContent = '管理員登入';
                dom.adminLoginBtn.classList.replace('bg-red-500', 'bg-blue-500');
            }
            updateView();
        });

        // --- Event Listeners ---
        const setupEventListeners = () => {
            // Day/Month Navigation
            dom.prevDayBtn.onclick = () => { state.currentDate.setDate(state.currentDate.getDate() - 1); updateView(); };
            dom.nextDayBtn.onclick = () => { state.currentDate.setDate(state.currentDate.getDate() + 1); updateView(); };
            dom.prevMonthBtn.onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); renderCalendar(); };
            dom.nextMonthBtn.onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); renderCalendar(); };
            
            // Login
            dom.adminLoginBtn.onclick = () => state.isAdmin ? supabase.auth.signOut() : showModal(dom.loginModal.el);
            dom.loginModal.closeBtn.onclick = () => hideModal(dom.loginModal.el);
            dom.loginModal.form.onsubmit = async (e) => {
                e.preventDefault();
                const { error } = await supabase.auth.signInWithPassword({ email: dom.loginModal.emailInput.value, password: dom.loginModal.passwordInput.value });
                if (error) alert("登入失敗，請檢查您的帳號密碼。");
                else { showToast("登入成功！"); hideModal(dom.loginModal.el); dom.loginModal.form.reset(); }
            };

            // Save Content
            dom.saveButton.onclick = async () => {
                const dateKey = formatDate(state.currentDate);
                const { error } = await supabase.from('contact_book').upsert({ date: dateKey, content: dom.contentArea.innerHTML }, { onConflict: 'date' });
                showToast(error ? "儲存失敗" : "資料已成功儲存至雲端！");
            };
            
            // Settings Modal
            dom.settings.btn.onclick = () => {
                dom.settings.titleInput.value = state.settings.title;
                dom.settings.futureToggle.checked = state.settings.allow_future_browsing;
                showModal(dom.settings.modal);
            };
            dom.settings.cancelBtn.onclick = () => hideModal(dom.settings.modal);
            dom.settings.saveBtn.onclick = async () => {
                const newSettings = {
                    title: dom.settings.titleInput.value,
                    allow_future_browsing: dom.settings.futureToggle.checked
                };
                const { error } = await supabase.from('settings').update(newSettings).eq('id', 1);
                if (!error) {
                    await loadSettings(); // Reload settings from DB
                    updateView(); // Update entire view to apply new settings to calendar
                    showToast("設定已儲存！");
                } else {
                    showToast("儲存設定失敗！請確認已建立 settings 資料表。");
                }
                hideModal(dom.settings.modal);
            };
        };

        // --- Initial Load ---
        const init = async () => {
            state.currentDate.setHours(0, 0, 0, 0);
            state.calendarDate = new Date(state.currentDate);
            const savedTheme = localStorage.getItem('contact-book-theme') || 'light';
            applyTheme(savedTheme);
            await loadSettings();
            setupEventListeners();
            // onAuthStateChange will trigger the first updateView()
        };

        init();
    </script>
</body>
</html>
