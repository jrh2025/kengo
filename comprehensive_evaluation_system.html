<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ä¸­å°å­¸ç”Ÿå…¨æ–¹ä½å°å¸«ç¶œåˆè©•èªç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* è¦–è¦ºé¢¨æ ¼å®šç¾© */
        .theme-day {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --item-inactive-bg: #f1f5f9;
        }

        .theme-night {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --item-inactive-bg: #1a2235;
        }

        .theme-comfort {
            --bg-color: #fdf6e3;
            --card-bg: #f5edda;
            --text-main: #5c4b37;
            --text-muted: #8d7a64;
            --border-color: #e6dec5;
            --item-inactive-bg: #efe7d1;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
        }

        .custom-card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            border-width: 1px;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .item-row {
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
            border-width: 1px;
        }

        .item-inactive {
            opacity: 0.5;
            background-color: var(--item-inactive-bg);
            filter: grayscale(0.5);
            border-color: transparent;
        }

        .item-active {
            opacity: 1;
            background-color: var(--card-bg);
            border-left: 4px solid #3b82f6;
            border-color: var(--border-color);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .score-btn {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.15s;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-muted);
        }

        .item-active .score-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .score-btn.selected {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }

        .grade-btn,
        .style-btn {
            transition: all 0.2s;
            border-width: 1px;
            background-color: var(--card-bg);
            color: var(--text-main);
        }

        .grade-btn.selected,
        .style-btn.selected {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .mini-score-btn {
            width: 20px;
            height: 20px;
            font-size: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-muted);
        }

        .mini-score-btn.selected {
            background: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="p-2 md:p-6 theme-day">

    <div class="max-w-7xl mx-auto">
        <!-- Header å€å¡Š -->
        <div class="custom-card rounded-2xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <h1 class="text-2xl md:text-3xl font-extrabold text-blue-600">åœ‹ä¸­å°å­¸ç”Ÿå…¨æ–¹ä½å°å¸«ç¶œåˆè©•èªç³»çµ±</h1>
                <div class="flex flex-wrap justify-center gap-2">
                    <!-- API Key Setting Button -->
                    <button onclick="toggleApiKeyInput()"
                        class="px-4 py-2 bg-slate-100 text-slate-600 border border-slate-200 rounded-xl text-xs font-bold hover:bg-slate-200 transition-all flex items-center gap-2">
                        <i class="fa-solid fa-key"></i> è¨­å®š API Key
                    </button>
                    <button onclick="confirmReset()"
                        class="px-4 py-2 bg-red-50 text-red-600 border border-red-100 rounded-xl text-xs font-bold hover:bg-red-600 hover:text-white transition-all flex items-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> é‡ç½®è©•é‡
                    </button>
                </div>
            </div>

            <!-- Enhanced API Key Input Panel -->
            <div id="api-key-panel"
                class="hidden mb-6 p-5 bg-blue-50 border border-blue-100 rounded-2xl flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs font-bold text-blue-700">Google Gemini API Key ç®¡ç†</span>
                        <span id="api-status-label"
                            class="text-[10px] font-medium px-2 py-0.5 rounded bg-slate-200 text-slate-600 w-fit">æª¢æ¸¬ä¸­...</span>
                    </div>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank"
                        class="text-[10px] text-blue-500 underline flex items-center gap-1">
                        <i class="fa-solid fa-external-link text-[8px]"></i> ç²å–å…è²»é‡‘é‘°
                    </a>
                </div>
                <div class="flex flex-col md:flex-row gap-2">
                    <div class="relative flex-1">
                        <input type="password" id="user-api-key" placeholder="è²¼ä¸Šé‡‘é‘°å¾Œç³»çµ±å°‡è‡ªå‹•è¨˜æ†¶æ–¼æœ¬åœ°..."
                            class="w-full pl-4 pr-10 py-2 rounded-xl border border-blue-200 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white text-slate-700">
                        <button onclick="togglePasswordVisibility()"
                            class="absolute right-3 top-2.5 text-slate-400 hover:text-blue-500 transition-colors">
                            <i id="password-toggle-icon" class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveApiKey()"
                            class="flex-1 md:flex-none px-6 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-md hover:bg-blue-700 transition">å„²å­˜</button>
                        <button onclick="deleteApiKey()"
                            class="flex-1 md:flex-none px-6 py-2 bg-red-50 text-red-600 border border-red-200 rounded-xl text-xs font-bold hover:bg-red-600 hover:text-white transition">åˆªé™¤é‡‘é‘°</button>
                    </div>
                </div>
                <p class="text-[9px] text-blue-400 italic">* é‡‘é‘°å°‡åŠ å¯†å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ localStorage ä¸­ï¼Œæˆ‘å€‘ä¸æœƒå°‡å…¶å‚³é€åˆ°ä»»ä½•ç¬¬ä¸‰æ–¹ä¼ºæœå™¨ï¼ˆGemini API
                    é™¤å¤–ï¼‰ã€‚</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 border-y border-slate-100 py-6 mb-4">
                <!-- é©ç”¨å°è±¡é¸æ“‡ (å«è‡ªå‹•è¨˜æ†¶) -->
                <div class="flex flex-col items-center lg:items-start gap-3">
                    <span class="text-xs font-bold text-muted flex items-center gap-2">
                        <i class="fa-solid fa-child-reaching text-blue-500"></i> é©ç”¨å°è±¡ï¼ˆè‡ªå‹•è¨˜æ†¶ï¼‰ï¼š
                    </span>
                    <div class="flex flex-wrap gap-2" id="grade-selector">
                        <button onclick="selectGrade('åœ‹å°ä½å¹´ç´š')"
                            class="grade-btn px-4 py-1.5 text-xs border rounded-full font-bold">åœ‹å°ä½å¹´ç´š</button>
                        <button onclick="selectGrade('åœ‹å°ä¸­å¹´ç´š')"
                            class="grade-btn px-4 py-1.5 text-xs border rounded-full font-bold">åœ‹å°ä¸­å¹´ç´š</button>
                        <button onclick="selectGrade('åœ‹å°é«˜å¹´ç´š')"
                            class="grade-btn px-4 py-1.5 text-xs border rounded-full font-bold">åœ‹å°é«˜å¹´ç´š</button>
                        <button onclick="selectGrade('åœ‹ä¸­')"
                            class="grade-btn px-4 py-1.5 text-xs border rounded-full font-bold">åœ‹ä¸­</button>
                    </div>
                </div>

                <!-- è¦–è¦ºé¢¨æ ¼é¸æ“‡ (å«è‡ªå‹•è¨˜æ†¶) -->
                <div class="flex flex-col items-center lg:items-end gap-3">
                    <span class="text-xs font-bold text-muted flex items-center gap-2">
                        <i class="fa-solid fa-palette text-blue-500"></i> è¦–è¦ºé¢¨æ ¼ï¼ˆè‡ªå‹•è¨˜æ†¶ï¼‰ï¼š
                    </span>
                    <div class="flex gap-2">
                        <button onclick="changeTheme('day')" id="btn-theme-day"
                            class="style-btn px-4 py-1.5 text-xs border rounded-full font-bold flex items-center gap-2">
                            <i class="fa-solid fa-sun"></i> ç™½å¤©
                        </button>
                        <button onclick="changeTheme('night')" id="btn-theme-night"
                            class="style-btn px-4 py-1.5 text-xs border rounded-full font-bold flex items-center gap-2">
                            <i class="fa-solid fa-moon"></i> é»‘å¤œ
                        </button>
                        <button onclick="changeTheme('comfort')" id="btn-theme-comfort"
                            class="style-btn px-4 py-1.5 text-xs border rounded-full font-bold flex items-center gap-2">
                            <i class="fa-solid fa-eye text-amber-600"></i> èˆ’é©
                        </button>
                    </div>
                </div>
            </div>

            <p class="text-center text-[11px] text-muted mb-2">
                ğŸ’¡ <span class="text-blue-600 font-bold">é€£é»å…©ä¸‹é …ç›®</span> ä»¥é–‹å•Ÿè©•é‡ã€‚é»æ“Šè—è‰² <span
                    class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-blue-100 text-blue-600 text-[10px] font-bold">?</span>
                æŸ¥çœ‹è©³ç´°æè¿°ã€‚
            </p>
            <div id="top-hint" class="text-center text-xs font-bold transition-colors"></div>
        </div>

        <!-- ä¸»è¦è©•é‡å€ -->
        <div id="assessment-container" class="space-y-6"></div>

        <!-- å·²è©•é‡æ¸…å–®åŒ¯ç¸½ -->
        <div id="summary-list-container" class="mt-12 custom-card rounded-2xl shadow-sm overflow-hidden hidden">
            <div class="bg-blue-600/5 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2 text-sm md:text-base">
                    <i class="fa-solid fa-list-check text-blue-500"></i> å·²è©•é‡é …ç›®æ¸…å–®
                </h3>
                <div class="flex items-center gap-3">
                    <button onclick="confirmReset()"
                        class="text-xs text-red-500 font-bold hover:underline">æ¸…ç©ºå…¨éƒ¨</button>
                    <span id="total-count-badge"
                        class="bg-blue-600 text-white text-xs px-3 py-1 rounded-full font-bold">0 é …ç›®</span>
                </div>
            </div>
            <div id="summary-content" class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4"></div>
        </div>

        <!-- åº•éƒ¨ç”ŸæˆæŒ‰éˆ• -->
        <div class="mt-8 mb-20 p-10 custom-card rounded-2xl border-dashed text-center">
            <div id="bottom-hint" class="mb-6 text-sm font-bold transition-colors"></div>
            <button onclick="generateAIComments()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-12 py-4 rounded-2xl font-bold shadow-xl shadow-blue-200 transition-all flex items-center gap-3 mx-auto">
                <i class="fa-solid fa-wand-magic-sparkles"></i> ç”Ÿæˆ AI ç¶œåˆåˆ†æå ±å‘Š
            </button>
        </div>
    </div>

    <!-- é …ç›®èªªæ˜å½ˆçª— -->
    <div id="help-modal"
        class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="custom-card rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center">
                <h4 id="help-title" class="font-bold text-sm">é …ç›®èªªæ˜</h4>
                <button onclick="closeHelp()" class="text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <p id="help-desc" class="text-sm leading-relaxed italic opacity-90"></p>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeHelp()"
                        class="bg-blue-600 text-white px-6 py-2 rounded-xl text-xs font-bold shadow-md">æˆ‘äº†è§£äº†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡ç½®ç¢ºèªå½ˆçª— -->
    <div id="reset-modal"
        class="fixed inset-0 bg-slate-900/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="custom-card rounded-2xl max-w-xs w-full shadow-2xl p-6 text-center">
            <div
                class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h4 class="font-bold text-lg mb-2">ç¢ºå®šè¦é‡ç½®å—ï¼Ÿ</h4>
            <p class="text-sm text-muted mb-6">é€™å°‡æœƒæ¸…ç©ºç›®å‰æ‰€æœ‰å·²é»é¸çš„æŒ‡æ¨™èˆ‡åˆ†æ•¸ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex gap-3">
                <button onclick="closeResetModal()"
                    class="flex-1 py-2 rounded-xl border border-slate-200 font-bold text-xs bg-slate-50">å–æ¶ˆ</button>
                <button onclick="resetAllAssessments()"
                    class="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold text-xs">ç¢ºå®šé‡ç½®</button>
            </div>
        </div>
    </div>

    <!-- AI åˆ†æçµæœå ±å‘Šå½ˆçª— -->
    <div id="ai-modal"
        class="fixed inset-0 bg-slate-900/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="custom-card rounded-3xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-robot text-blue-500"></i> AI å­¸ç”Ÿç¶œåˆåˆ†æå ±å‘Š
                </h2>
                <button onclick="closeModal()" class="text-muted hover:text-blue-600 text-2xl">&times;</button>
            </div>
            <div id="ai-loading" class="p-20 flex flex-col items-center justify-center hidden">
                <div class="loading-spinner mb-4"></div>
                <p id="loading-status-text" class="text-muted font-medium text-sm">æ­£åœ¨åˆ†ææ•¸æ“šä¸¦æ’°å¯«äº”ç¨®é¢¨æ ¼è©•èª...</p>
            </div>
            <div id="ai-content-wrapper" class="p-6 overflow-y-auto space-y-6 custom-scroll">
                <div class="bg-slate-50/50 rounded-2xl p-6 border border-slate-200">
                    <h3 class="text-center font-bold text-muted mb-4 text-sm md:text-base">äº”å¤§å‘åº¦ç™¼å±•æŒ‡æ¨™é›·é”åœ–</h3>
                    <div class="w-full max-w-sm mx-auto aspect-square">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                <div id="ai-comments-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-10"></div>
            </div>
            <div class="p-4 border-t border-slate-100 flex justify-end">
                <button onclick="closeModal()"
                    class="bg-slate-200 text-slate-700 px-8 py-2 rounded-xl font-bold text-sm">é—œé–‰å ±å‘Š</button>
            </div>
        </div>
    </div>

    <script>
        const categories = {
            self_management: {
                title: "èº«å¿ƒç´ é¤Šèˆ‡è‡ªæˆ‘ç®¡ç†", color: "blue", items: [
                    { name: "ç”Ÿæ´»èµ·å±…è‡ªç†", desc: "èƒ½ç¨ç«‹ç®¡ç†å€‹äººäº‹å‹™ï¼Œå¦‚æº–æ™‚èµ·åºŠã€æ•´ç†æœå„€ã€æ”¶ç´æ›¸åŒ…åŠå€‹äººç‰©å“ã€‚" },
                    { name: "å¥åº·ä½œæ¯ç¡çœ ", desc: "å…·å‚™ç©©å®šçš„ä½œæ¯è¦å¾‹ï¼Œèƒ½ç¢ºä¿å……è¶³ç¡çœ ï¼Œå‡æ—¥ä¸ç†¬å¤œï¼Œç¶­æŒç”Ÿç†æ™‚é˜ç©©å®šã€‚" },
                    { name: "é£²é£Ÿç‡Ÿé¤Šå‡è¡¡", desc: "æœ‰è‰¯å¥½çš„é€²é£Ÿç¿’æ…£ï¼Œç†è§£ä¸¦å¯¦è¸å¥åº·é£²é£Ÿï¼Œä¸ä¾è³´é›¶é£Ÿæˆ–å«ç³–é£²æ–™ã€‚" },
                    { name: "é«”èƒ½æ´»å‹•ç¿’æ…£", desc: "æœ‰è¦å¾‹é‹å‹•çš„æ„è­˜èˆ‡è¡Œç‚ºï¼Œç†è§£é«”åŠ›æ˜¯å­¸ç¿’çš„åŸºç¤ï¼Œèƒ½è‡ªä¸»åƒèˆ‡èº«é«”æ´»å‹•ã€‚" },
                    { name: "æƒ…ç·’è¦ºå¯Ÿèª¿ç¯€", desc: "èƒ½è­˜åˆ¥è‡ªèº«æƒ…ç·’ï¼Œä¸¦èƒ½é‹ç”¨é©ç•¶æ–¹æ³•ç´“è§£å£“åŠ›æˆ–æŒ«æŠ˜æ„Ÿï¼Œä¸é·æ€’ç’°å¢ƒã€‚" },
                    { name: "æŒ«æŠ˜æ¢å¾©éŸŒæ€§", desc: "é¢å°å¤±æ•—æˆ–æ‰¹è©•æ™‚å±•ç¾æ­£å‘å¿ƒæ…‹ï¼Œèƒ½å¿«é€Ÿèª¿é©ä¸¦å¾ä¸­å­¸ç¿’æ”¹å–„æ–¹æ¡ˆã€‚" },
                    { name: "å„€å®¹è¡›ç”Ÿç¶­è­·", desc: "ç¶­æŒå€‹äººæ¸…æ½”èˆ‡å¾—é«”å¤–è²Œï¼Œåœ¨ä¸åŒå ´åˆå±•ç¾åˆå®œçš„ç”Ÿç†è¡›ç”Ÿç¿’æ…£ã€‚" },
                    { name: "æ•¸ä½æ™‚é–“æŒæ§", desc: "èƒ½è‡ªå¾‹åœ°ç®¡ç† 3C ç”¢å“ä½¿ç”¨æ™‚é–“ï¼Œä¸å› ç¶²è·¯æ²‰è¿·å½±éŸ¿èª²æ¥­ã€ç¤¾äº¤æˆ–ç¡çœ ã€‚" },
                    { name: "éš±ç§é‚Šç•Œå°Šé‡", desc: "æ‡‚å¾—ä¿è­·å€‹äººéš±ç§è³‡è¨Šï¼ŒåŒæ™‚ä¹Ÿå°Šé‡ä»–äººçš„ç©ºé–“èˆ‡å€‹äººè²¡ç‰©ç•Œç·šã€‚" },
                    { name: "è‡ªä¿¡è‡ªå°Šç™¼å±•", desc: "ç›¸ä¿¡è‡ªå·±çš„åƒ¹å€¼ï¼Œèƒ½æ­£å‘è©•åƒ¹è‡ªæˆ‘èƒ½åŠ›ï¼Œä¸¦ç¶­æŒå¥åº·çš„è‡ªä¿¡å¿ƒã€‚" },
                    { name: "è‡ªä¸»å›°é›£è§£æ±º", desc: "é‡åˆ°æŒ‘æˆ°å…ˆå˜—è©¦å‹•è…¦è§£æ±ºè€Œéç«‹å³æ±‚æ•‘ï¼Œå±•ç¾åˆæ­¥çš„ç¨ç«‹æ’é›£èƒ½åŠ›ã€‚" },
                    { name: "å®‰å…¨é¢¨éšªæ„è­˜", desc: "èƒ½è¾¨è­˜ç”Ÿæ´»ä¸­çš„æ½›åœ¨é¢¨éšªï¼Œå…·å‚™è‡ªæˆ‘ä¿è­·å¸¸è­˜ä¸¦é é›¢å±éšªæƒ…å¢ƒã€‚" }
                ]
            },
            learning: {
                title: "å­¸ç¿’ç‰¹è³ªèˆ‡å­¸ç§‘èƒ½åŠ›", color: "emerald", items: [
                    { name: "èª²å ‚å°ˆæ³¨æŠ•å…¥", desc: "ä¸Šèª²æœŸé–“èƒ½ç¶­æŒé«˜æ•ˆå°ˆæ³¨ï¼Œç›®å…‰éš¨å¸«é•·å¼•å°ï¼Œç©æ¥µåƒèˆ‡èª²å®¤äº’å‹•ã€‚" },
                    { name: "å­¸ç¿’ä»»å‹™ç®¡ç†", desc: "èƒ½æº–æ™‚å®Œæˆå„é …ä½œæ¥­èˆ‡äº¤è¾¦ä»»å‹™ï¼Œä¸¦å°å…¶ç”¢å‡ºå“è³ªè² è²¬ä»»ã€‚" },
                    { name: "é–±è®€ç†è§£æ·±åº¦", desc: "èƒ½åˆ†ææ–‡ç« è„ˆçµ¡ï¼ŒæŠ“å–é—œéµè³‡è¨Šä¸¦æ¨è«–ä½œè€…æ„åœ–ï¼Œè€Œéåƒ…æ˜¯è¡¨å±¤é–±è®€ã€‚" },
                    { name: "æ•¸ç†é‚è¼¯æ‡‰ç”¨", desc: "å…·å‚™é‡åŒ–æ€è€ƒèˆ‡ç©ºé–“æ¨ç†èƒ½åŠ›ï¼Œèƒ½é‹ç”¨é‚è¼¯å·¥å…·è§£æ±ºå¯¦éš›å•é¡Œã€‚" },
                    { name: "èªæ–‡è¡¨é”æºé€š", desc: "èƒ½æœ‰æ¢ç†åœ°é‹ç”¨å£èªæˆ–æ–‡å­—å‚³é”æƒ³æ³•ï¼Œçµæ§‹æ¸…æ™°ä¸”èªæ„æ˜ç¢ºã€‚" },
                    { name: "è³‡è¨Šæª¢ç´¢åˆ†æ", desc: "èƒ½é‹ç”¨æ•¸ä½å·¥å…·æŸ¥æ‰¾è³‡æ–™ï¼Œä¸¦å…·å‚™éæ¿¾è™›å‡æˆ–ç„¡æ•ˆè³‡è¨Šçš„åŸºæœ¬ç´ é¤Šã€‚" },
                    { name: "å­¸ç¿’ç›£æ§ä¿®æ­£", desc: "äº†è§£è‡ªå·±çš„å­¸ç¿’ç‹€æ…‹ï¼Œè€ƒå¾ŒæœƒèªçœŸè¨‚æ­£éŒ¯èª¤ä¸¦é‡å°å¼±é»èª¿æ•´æ–¹æ³•ã€‚" },
                    { name: "ç³»çµ±é€£çµæ•´åˆ", desc: "èƒ½å°‡ä¸åŒå­¸ç§‘çš„çŸ¥è­˜é»é€²è¡Œè¯æƒ³èˆ‡æ•´åˆï¼Œå±•ç¾è·¨é ˜åŸŸå­¸ç¿’çš„æ½›åŠ›ã€‚" },
                    { name: "è¨ˆç•«åˆ¶å®šåŸ·è¡Œ", desc: "å…·å‚™æ™‚é–“è¦åŠƒèƒ½åŠ›ï¼Œèƒ½ç‚ºå¤§è€ƒæˆ–å°ˆé¡Œåˆ¶å®šè¤‡ç¿’é€²åº¦ä¸¦æŒ‰éƒ¨å°±ç­åŸ·è¡Œã€‚" },
                    { name: "ç§‘å­¸æ¢ç©¶ç²¾ç¥", desc: "å°æœªçŸ¥ç¾è±¡æœ‰å¥½å¥‡å¿ƒï¼Œå–œæ­¡é€éè§€å¯Ÿã€å‡è¨­èˆ‡å¯¦é©—ä¾†é©—è­‰æƒ³æ³•ã€‚" },
                    { name: "è¨˜æ†¶æå–æ•ˆèƒ½", desc: "èƒ½é‹ç”¨æŠ€å·§å°‡çŸ¥è­˜å…§åŒ–ï¼Œä¸¦åœ¨éœ€è¦æ™‚ï¼ˆå¦‚è€ƒè©¦æˆ–å ±å‘Šï¼‰ç²¾æº–æå–ã€‚" },
                    { name: "ç¾æ„Ÿæ‡‰ç”¨è¡¨é”", desc: "åœ¨ä½œå“æ’ç‰ˆã€è¦–è¦ºå‘ˆç¾ä¸Šå…·å‚™ç¾å­¸ç´ é¤Šï¼Œè®“å­¸ç¿’æˆæœæ›´å…·å¸å¼•åŠ›ã€‚" }
                ]
            },
            social: {
                title: "äººéš›äº’å‹•èˆ‡åœ˜éšŠåˆä½œ", color: "amber", items: [
                    { name: "åŒç†å¿ƒèˆ‡æ„Ÿå—", desc: "èƒ½æ•éŠ³è¦ºå¯Ÿä»–äººçš„éœ€æ±‚èˆ‡æ„Ÿå—ï¼Œå±•ç¾é«”è²¼ä¸¦é¡˜æ„æä¾›å¿ƒç†æ”¯æŒã€‚" },
                    { name: "æºé€šå‚¾è½æŠ€å·§", desc: "æºé€šæ™‚èƒ½è€å¿ƒè†è½ï¼Œä¸¦ä»¥å°Šé‡å°æ–¹çš„å£æ°£è¡¨é”å€‹äººæ„è¦‹ï¼Œä¸å¼·åŠ æ–¼äººã€‚" },
                    { name: "åœ˜éšŠå”ä½œè²¢ç»", desc: "åœ¨ç¾¤é«”ä¸­èƒ½ç™¼æ®æ‰€é•·ï¼Œç©æ¥µåˆ†æ“”ä»»å‹™ä¸¦ä¸»å‹•å”åŠ©å¤¥ä¼´ï¼Œå…±å‰µæˆæœã€‚" },
                    { name: "è¡çªå”å•†è™•ç†", desc: "ç™¼ç”Ÿæ‘©æ“¦æ™‚èƒ½å†·éœå°è©±ï¼Œå°‹æ±‚é›™è´çš„æ›¿ä»£æ–¹æ¡ˆï¼Œè€Œéæ¡å–æƒ…ç·’å°æŠ—ã€‚" },
                    { name: "å¸«ç”Ÿä¿¡ä»»äº’å‹•", desc: "èˆ‡é•·è¼©ç¶­æŒè‰¯æ€§ä¸”ä¿¡ä»»çš„é—œä¿‚ï¼Œé¡˜æ„æ¥ç´å°å¼•ä¸¦é©æ™‚å°‹æ±‚è«®è©¢ã€‚" },
                    { name: "å‹èª¼å»ºç«‹ç¶­æŒ", desc: "å…·å‚™ç©©å®šçš„ç¤¾äº¤åœˆèˆ‡æ·±åº¦å‹èª¼ï¼Œèƒ½èˆ‡åŒå„•å…±äº«ç§˜å¯†èˆ‡äº’ç›¸æ”¯æŒã€‚" },
                    { name: "ç•°æ€§ç¤¾äº¤å°Šé‡", desc: "èˆ‡ä¸åŒæ€§åˆ¥ç›¸è™•æ…‹åº¦å¤§æ–¹ã€è‡ªç„¶ï¼Œç¶­æŒé©ç•¶ç•Œç·šä¸¦è½å¯¦å¹³æ¬Šç²¾ç¥ã€‚" },
                    { name: "ç¤¾äº¤éŸŒæ€§æŠ—å£“", desc: "é¢å°å°åœ˜é«”æ’æ“ æˆ–æ‘©æ“¦æ™‚èƒ½ä¿æŒç†æ™ºï¼Œä¸å› äººéš›å£“åŠ›è€Œè¿·å¤±è‡ªæˆ‘ã€‚" },
                    { name: "æ›ä½æ€è€ƒèƒ½åŠ›", desc: "åµæ¶æ™‚èƒ½å˜—è©¦ç«™åœ¨å°æ–¹ç«‹å ´æ€è€ƒï¼Œç†è§£ä¸åŒçš„è¦–è§’èˆ‡éœ€æ±‚ã€‚" },
                    { name: "åŠ©äººåˆä½œç†±å¿±", desc: "åœ¨ä»–äººéœ€è¦æ™‚ä¸»å‹•çµ¦äºˆå¹«åŠ©ï¼Œäº«å—åœ˜éšŠåˆä½œå¸¶ä¾†çš„æˆå°±æ„Ÿã€‚" },
                    { name: "æ­¸å±¬æ„Ÿèˆ‡è²¬ä»»", desc: "è¦ºå¾—è‡ªå·±æ˜¯ç­ç´šçš„ä¸€ä»½å­ï¼Œé¡˜æ„ç‚ºç­ç´šæ¦®è­½ä»˜å‡ºä¸¦ç¶­è­·åœ˜é«”æ°›åœã€‚" },
                    { name: "ç¤¾äº¤åª’é«”å½¢è±¡", desc: "åœ¨ç¤¾ç¾¤ç¶²è·¯ä¸Šå±•ç¾æ­£å‘è¨€è¡Œï¼Œä¸éåº¦æ²‰æººæ–¼è™›æ“¬èªå¯ã€‚" }
                ]
            },
            citizenship: {
                title: "é“å¾·å¯¦è¸èˆ‡å…¬æ°‘æ„è­˜", color: "purple", items: [
                    { name: "èª å¯¦èª ä¿¡å“æ ¼", desc: "è¨€è¡Œä¸€è‡´ï¼Œå‹‡æ–¼æ‰¿èªéŒ¯èª¤ä¸¦æ‰¿æ“”çµæœï¼Œä¸å› æ€•å—ç½°è€Œèªªè¬Šã€‚" },
                    { name: "æ­£ç¾©å…¬å¹³å®ˆè­·", desc: "åœ¨æ„ç¾¤é«”ä¸­çš„å…¬å¹³ï¼Œé¢å°ä¸æ­£ç•¶è¡Œç‚ºæœ‰å‹‡æ°£ç™¼è²æˆ–å‘é•·è¼©åæ‡‰ã€‚" },
                    { name: "å®ˆæ³•è¦ç¯„éµå¾ª", desc: "ç†è§£ä¸¦èªåŒæ ¡è¦èˆ‡ç¤¾æœƒè¦ç¯„çš„åƒ¹å€¼ï¼Œéç›²ç›®æœå¾è€Œæ˜¯å…§åŒ–è‡ªå¾‹ã€‚" },
                    { name: "å…¬å…±æœå‹™åƒèˆ‡", desc: "ä¸»å‹•æ‰¿æ“”å…¬å…±å‹å‹™ï¼Œå°æ–¼ç¶­è­·å…¬å…±ç’°å¢ƒæˆ–äº‹å‹™æœ‰é«˜åº¦ä½¿å‘½æ„Ÿã€‚" },
                    { name: "å¤šå…ƒæ–‡åŒ–åŒ…å®¹", desc: "å°Šé‡ä¸åŒèƒŒæ™¯ã€èº«åˆ†æˆ–ç¿’æ…£çš„äººå£«ï¼Œä¸å­˜åè¦‹ä¸”æ¨‚æ–¼äº¤æµã€‚" },
                    { name: "åª’é«”è³‡è¨Šç´ é¤Š", desc: "èƒ½è¾¨è­˜å‡è¨Šæ¯èˆ‡ç¶²è·¯æ¨™é¡Œé»¨ï¼Œä¸éš¨æ„æ•£æ’­æœªç¶“è­‰å¯¦çš„è¨€è«–ã€‚" },
                    { name: "ç¶²è·¯å…¬æ°‘ç¦®å„€", desc: "åœ¨ç¶²è·¯äº’å‹•ä¸­ç¶­æŒç¦®è²Œï¼Œç†è§£æ•¸ä½è¶³è·¡çš„é‡è¦æ€§ï¼Œé é›¢ç¶²è·¯éœ¸å‡Œã€‚" },
                    { name: "æ„Ÿæ©èˆ‡è¬™è™›å¿ƒ", desc: "èƒ½çœ‹è¦‹ä»–äººçš„ä»˜å‡ºä¸¦è¡¨é”è¬æ„ï¼Œå°æˆå°±ä¿æŒè¬™å’Œï¼Œä¸é©•å‚²è‡ªæ»¿ã€‚" },
                    { name: "æ˜¯éè¾¨åˆ¥åˆ†æ", desc: "é¢å°èª˜æƒ‘æˆ–åŒå„•å£“åŠ›èƒ½å†·éœåˆ¤æ–·å°éŒ¯ï¼Œæœ‰å …å®šçš„é“å¾·åº•ç·šã€‚" },
                    { name: "æ¬Šå¨ç†æ€§å°è©±", desc: "å°é•·è¼©æˆ–åˆ¶åº¦æœ‰ç–‘å•æ™‚ï¼Œèƒ½æ¡å–ç†æ€§æœ‰ç¦®çš„æ–¹å¼æºé€šèˆ‡çˆ­å–æ¬Šç›Šã€‚" },
                    { name: "ç’°å¢ƒæ°¸çºŒå®ˆè­·", desc: "å…·å‚™ç’°ä¿æ„è­˜ï¼Œèƒ½ç¢ºå¯¦ç¢ºå¯¦è½å¯¦åƒåœ¾åˆ†é¡ã€ç¯€ç´„èƒ½æºç­‰ç¶ è‰²è¡Œç‚ºã€‚" },
                    { name: "å…¬æ°‘åƒ¹å€¼è½å¯¦", desc: "ç†è§£ä¸¦å¯¦è¸æ°‘ä¸»ã€å¹³ç­‰èˆ‡è‡ªç”±çš„åƒ¹å€¼ï¼Œä¸¦åœ¨ç­ç´šç”Ÿæ´»ä¸­é«”ç¾ã€‚" }
                ]
            },
            potential: {
                title: "å¤šå…ƒæ½›èƒ½èˆ‡å‰µæ–°ç´ é¤Š", color: "pink", items: [
                    { name: "å¥½å¥‡å¿ƒèˆ‡æ¢ç´¢", desc: "å°æ–°äº‹ç‰©ä¿æœ‰é«˜åº¦èˆˆè¶£ï¼Œä¸è¨­é™è‡ªå·±çš„ç™¼å±•ï¼Œå‹‡æ–¼è·¨å‡ºèˆ’é©åœˆã€‚" },
                    { name: "å‰µæ–°æ€ç¶­å±•ç¾", desc: "é¢å°è€å•é¡Œæ™‚èƒ½å˜—è©¦æå‡ºä¸åŒæƒ³æ³•ï¼Œåœ¨å‹ä½œæˆ–å°ˆé¡Œä¸­å±•ç¾å‰µæ„ã€‚" },
                    { name: "è—è¡“é‘‘è³åŠ›", desc: "èƒ½æ¬£è³ç”Ÿæ´»ä¸­çš„å„ç¨®è—è¡“å½¢å¼ï¼Œä¸¦èƒ½è¡¨é”å€‹äººå°ç¾æ„Ÿçš„è¦‹è§£ã€‚" },
                    { name: "ç¾æ„Ÿå¯¦è¸ä½œå“", desc: "åœ¨ä½œæ¥­ã€ç­†è¨˜æˆ–æ´»å‹•ä½ˆç½®ä¸­ï¼Œèƒ½é‹ç”¨è‰²å½©èˆ‡æ’ç‰ˆå±•ç¾ç¾å­¸å“å‘³ã€‚" },
                    { name: "å‹•æ‰‹å¯¦ä½œèˆˆè¶£", desc: "å–œæ­¡è¦ªè‡ªå‹•æ‰‹æ“ä½œæˆ–çµ„è£ç‰©å“ï¼Œäº«å—å¾ç„¡åˆ°æœ‰çš„å‰µé€ éç¨‹ã€‚" },
                    { name: "æ•¸ä½å·¥å…·é©æ‡‰", desc: "èƒ½å¿«é€Ÿä¸Šæ‰‹æ–°å‹æ•¸ä½è»Ÿé«”ï¼Œä¸¦å°‡å…¶è½‰åŒ–ç‚ºè¼”åŠ©å­¸ç¿’çš„é«˜æ•ˆå·¥å…·ã€‚" },
                    { name: "è·¨åŸŸæ•´åˆèƒ½åŠ›", desc: "èƒ½è¯çµä¸åŒå­¸ç§‘çš„æŠ€å·§è§£æ±ºå•é¡Œï¼Œå¦‚ç”¨æ•¸å­¸èˆ‡ç¾æ„Ÿå®Œæˆæ¨¡å‹ã€‚" },
                    { name: "èˆå°è¡¨é”å±•æ¼”", desc: "åœ¨äººç¾¤é¢å‰è¡¨ç¾è‡ªæˆ‘æ™‚å¤§æ–¹å¾—é«”ï¼Œèƒ½å°‡æƒ³æ³•é€éå±•æ¼”æ¸…æ™°å‘ˆç¾ã€‚" },
                    { name: "æœªä¾†è·æ¶¯é¡˜æ™¯", desc: "å°æœªä¾†è·æ¶¯æˆ–å­¸æ¥­ç™¼å±•æœ‰åˆæ­¥è—åœ–ï¼Œä¸¦é¡˜æ„ç‚ºæ­¤é€²è¡Œè‡ªä¸»å­¸ç¿’ã€‚" },
                    { name: "æ‰¹åˆ¤æ€è€ƒåˆ†æ", desc: "ä¸ç›²å¾ä¸»æµæˆ–æ¬Šå¨ï¼Œèƒ½å°æ—¢æœ‰ç¾è±¡æå‡ºæœ‰å»ºè¨­æ€§çš„åæ€ã€‚" },
                    { name: "ç”Ÿæ´»å“å‘³ç‡Ÿé€ ", desc: "æ³¨æ„ç”Ÿæ´»ç´°ç¯€ï¼Œå°æ–¼æ‰“é€ å…·ç¾æ„Ÿçš„å€‹äººç”Ÿæ´»èˆ‡å­¸ç¿’ç©ºé–“æœ‰èˆˆè¶£ã€‚" },
                    { name: "è·¨å­¸ç§‘æ´å¯ŸåŠ›", desc: "èƒ½çœ‹è¦‹äº‹ç‰©èƒŒå¾Œçš„é‚è¼¯é—œè¯ï¼Œå…·å‚™å¤šè§’åº¦çœ‹å•é¡Œçš„èƒ½åŠ›ã€‚" }
                ]
            }
        };

        let selectedGrade = localStorage.getItem('teacher_pref_grade') || "åœ‹å°ä½å¹´ç´š";
        let currentTheme = localStorage.getItem('teacher_pref_theme') || "day";
        let storedApiKey = localStorage.getItem('teacher_api_key') || "";
        const scoreState = {};
        let radarChartInstance = null;

        function init() {
            const container = document.getElementById('assessment-container');
            Object.keys(categories).forEach(catKey => {
                const cat = categories[catKey];
                scoreState[catKey] = cat.items.map(() => ({ active: false, value: 3 }));
                const section = document.createElement('div');
                section.innerHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        <div class="h-5 w-1.5 bg-${cat.color}-500 rounded-full"></div>
                        <h2 class="text-lg font-bold">${cat.title}</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2" id="grid-${catKey}"></div>
                `;
                container.appendChild(section);
                const grid = document.getElementById(`grid-${catKey}`);
                cat.items.forEach((itemObj, index) => {
                    const card = document.createElement('div');
                    card.id = `card-${catKey}-${index}`;
                    card.className = "item-row item-inactive p-2.5 rounded-xl border flex flex-col gap-2 relative group";
                    let buttonsHtml = '';
                    for (let i = 1; i <= 5; i++) {
                        buttonsHtml += `<button class="score-btn" onclick="updateValue(event, '${catKey}', ${index}, ${i})">${i}</button>`;
                    }
                    card.innerHTML = `
                        <div class="flex items-center gap-2 overflow-hidden pr-8 text-slate-700">
                            <span class="text-[10px] font-bold text-muted flex-shrink-0">${index + 1}</span>
                            <span class="text-xs font-medium truncate">${itemObj.name}</span>
                        </div>
                        <button onclick="showHelp(event, '${catKey}', ${index})" 
                            class="absolute top-2 right-2 w-5 h-5 rounded-full bg-blue-500/10 text-blue-500 border border-blue-500/20 text-[11px] font-bold flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all shadow-sm z-10">?</button>
                        <div class="flex items-center justify-between mt-auto">
                            <div class="flex gap-1" id="btns-${catKey}-${index}">${buttonsHtml}</div>
                            <span id="val-badge-${catKey}-${index}" class="text-[10px] font-bold text-muted">--</span>
                        </div>
                    `;
                    card.addEventListener('dblclick', () => toggleItem(catKey, index));
                    grid.appendChild(card);
                });
            });

            // åŠ è¼‰åå¥½
            selectGrade(selectedGrade);
            changeTheme(currentTheme);
            document.getElementById('user-api-key').value = storedApiKey;
            checkApiKeyStatus();
            renderSummaryList();
        }

        // --- API Key ç®¡ç†å¼·åŒ– ---

        function toggleApiKeyInput() {
            const panel = document.getElementById('api-key-panel');
            panel.classList.toggle('hidden');
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('user-api-key');
            const icon = document.getElementById('password-toggle-icon');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function saveApiKey() {
            const key = document.getElementById('user-api-key').value.trim();
            if (!key) {
                alert("è«‹è¼¸å…¥é‡‘é‘°å…§å®¹å†å„²å­˜ã€‚");
                return;
            }
            storedApiKey = key;
            localStorage.setItem('teacher_api_key', key);
            checkApiKeyStatus();
            alert("API é‡‘é‘°å·²å„²å­˜ä¸¦è¨˜æ†¶æ–¼æœ¬åœ°ã€‚");
        }

        function deleteApiKey() {
            if (confirm("ç¢ºå®šè¦åˆªé™¤å·²å„²å­˜çš„ API é‡‘é‘°å—ï¼Ÿé€™å°‡å°è‡´ç„¡æ³•ç”Ÿæˆè©•èªã€‚")) {
                storedApiKey = "";
                localStorage.removeItem('teacher_api_key');
                document.getElementById('user-api-key').value = "";
                checkApiKeyStatus();
                alert("é‡‘é‘°å·²åˆªé™¤ã€‚");
            }
        }

        function checkApiKeyStatus() {
            const label = document.getElementById('api-status-label');
            if (storedApiKey) {
                label.innerText = "â— é‡‘é‘°å·²è¨­å®š";
                label.classList.replace('bg-slate-200', 'bg-green-100');
                label.classList.replace('text-slate-600', 'text-green-600');
            } else {
                label.innerText = "â—‹ å°šæœªè¨­å®šé‡‘é‘°";
                label.classList.replace('bg-green-100', 'bg-red-50');
                label.classList.replace('text-green-600', 'text-red-500');
            }
        }

        // --- å…¶ä»–ä»‹é¢é‚è¼¯ ---

        function changeTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('teacher_pref_theme', theme);
            document.body.className = `p-2 md:p-6 theme-${theme}`;
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`btn-theme-${theme}`).classList.add('selected');
        }

        function selectGrade(grade) {
            selectedGrade = grade;
            localStorage.setItem('teacher_pref_grade', grade);
            const btns = document.querySelectorAll('.grade-btn');
            btns.forEach(btn => {
                if (btn.innerText === grade) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        }

        function confirmReset() { document.getElementById('reset-modal').classList.remove('hidden'); }
        function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }
        function resetAllAssessments() {
            Object.keys(scoreState).forEach(catKey => {
                scoreState[catKey].forEach((item, index) => {
                    item.active = false; item.value = 3;
                    const card = document.getElementById(`card-${catKey}-${index}`);
                    card.className = "item-row item-inactive p-2.5 rounded-xl border flex flex-col gap-2 relative group";
                    const badge = document.getElementById(`val-badge-${catKey}-${index}`);
                    badge.innerText = '--'; badge.className = "text-[10px] font-bold text-muted";
                    const btns = document.getElementById(`btns-${catKey}-${index}`).querySelectorAll('.score-btn');
                    btns.forEach(b => b.classList.remove('selected'));
                });
            });
            renderSummaryList(); closeResetModal();
        }

        function showHelp(event, catKey, index) {
            event.stopPropagation();
            const item = categories[catKey].items[index];
            document.getElementById('help-title').innerText = item.name;
            document.getElementById('help-desc').innerText = item.desc;
            document.getElementById('help-modal').classList.remove('hidden');
        }
        function closeHelp() { document.getElementById('help-modal').classList.add('hidden'); }

        function toggleItem(catKey, index) {
            const card = document.getElementById(`card-${catKey}-${index}`);
            const isActive = !scoreState[catKey][index].active;
            scoreState[catKey][index].active = isActive;
            const badge = document.getElementById(`val-badge-${catKey}-${index}`);
            if (isActive) {
                card.classList.remove('item-inactive'); card.classList.add('item-active');
                badge.innerText = scoreState[catKey][index].value; badge.className = "text-[10px] font-bold text-blue-600";
                refreshButtonStyles(catKey, index);
            } else {
                card.classList.add('item-inactive'); card.classList.remove('item-active');
                badge.innerText = '--'; badge.className = "text-[10px] font-bold text-muted";
                const btns = document.getElementById(`btns-${catKey}-${index}`).querySelectorAll('.score-btn');
                btns.forEach(b => b.classList.remove('selected'));
            }
            renderSummaryList();
        }

        function updateValue(event, catKey, index, val) {
            if (event) event.stopPropagation();
            if (!scoreState[catKey][index].active) return;
            scoreState[catKey][index].value = val;
            document.getElementById(`val-badge-${catKey}-${index}`).innerText = val;
            refreshButtonStyles(catKey, index); renderSummaryList();
        }

        function refreshButtonStyles(catKey, index) {
            const btns = document.getElementById(`btns-${catKey}-${index}`).querySelectorAll('.score-btn');
            btns.forEach((btn, i) => (i + 1 === scoreState[catKey][index].value) ? btn.classList.add('selected') : btn.classList.remove('selected'));
        }

        function renderSummaryList() {
            const container = document.getElementById('summary-list-container');
            const content = document.getElementById('summary-content');
            const badgeLabel = document.getElementById('total-count-badge');
            const topHint = document.getElementById('top-hint');
            const bottomHint = document.getElementById('bottom-hint');
            content.innerHTML = '';
            let totalActive = 0;
            Object.keys(categories).forEach(catKey => {
                const activeItems = scoreState[catKey].map((s, i) => ({ ...s, index: i, name: categories[catKey].items[i].name })).filter(s => s.active);
                if (activeItems.length > 0) {
                    totalActive += activeItems.length;
                    const group = document.createElement('div'); group.className = "flex flex-col space-y-2";
                    let itemsHtml = activeItems.map(item => {
                        let miniBtns = '';
                        for (let i = 1; i <= 5; i++) miniBtns += `<button onclick="updateValue(null, '${catKey}', ${item.index}, ${i})" class="mini-score-btn ${item.value === i ? 'selected' : ''}">${i}</button>`;
                        return `<div class="flex flex-col gap-1 bg-blue-600/5 p-2 rounded-lg border border-blue-600/10"><div class="flex justify-between items-center text-[10px]"><div class="flex items-center gap-1 min-w-0"><button onclick="toggleItem('${catKey}', ${item.index})" class="text-red-400 hover:text-red-600 transition"><i class="fa-solid fa-trash-can"></i></button><span class="truncate" title="${item.name}">${item.name}</span></div><span class="font-bold text-blue-600">${item.value}</span></div><div class="flex gap-0.5 justify-end">${miniBtns}</div></div>`;
                    }).join('');
                    group.innerHTML = `<h4 class="text-xs font-bold text-blue-600 border-b border-blue-100 pb-1 mb-2">${categories[catKey].title}</h4><div class="space-y-1.5">${itemsHtml}</div>`;
                    content.appendChild(group);
                }
            });
            let hintHtml = totalActive === 0 ? "å°šæœªé¸æ“‡ä»»ä½•è©•é‡æŒ‡æ¨™" : (totalActive < 3 ? `âš ï¸ å·²è©•é‡ ${totalActive} é …ï¼Œå°šéœ€ ${3 - totalActive} é …` : `âœ… å·²è©•é‡ ${totalActive} é …ï¼Œç¬¦åˆ AI è©•èªæ¢ä»¶`);
            let hintClass = totalActive === 0 ? "text-muted" : (totalActive < 3 ? "text-red-500" : "text-emerald-600");
            topHint.innerHTML = hintHtml; topHint.className = `text-center text-xs font-bold transition-colors ${hintClass}`;
            bottomHint.innerHTML = hintHtml; bottomHint.className = `mb-6 text-sm font-bold transition-colors ${hintClass}`;
            badgeLabel.innerText = `${totalActive} é …ç›®`;
            totalActive > 0 ? container.classList.remove('hidden') : container.classList.add('hidden');
        }

        async function generateAIComments() {
            if (!storedApiKey) {
                alert("è«‹å…ˆé»æ“Šä¸Šæ–¹ã€è¨­å®š API Keyã€æŒ‰éˆ•ä¸¦è¼¸å…¥æ‚¨çš„ Google Gemini API é‡‘é‘°ã€‚");
                toggleApiKeyInput();
                return;
            }

            const activeData = []; const averages = {};
            Object.keys(categories).forEach(catKey => {
                const catScores = scoreState[catKey].filter(s => s.active);
                if (catScores.length > 0) {
                    const avg = catScores.reduce((a, b) => a + b.value, 0) / catScores.length;
                    averages[categories[catKey].title] = avg.toFixed(1);
                    scoreState[catKey].forEach((s, idx) => { if (s.active) activeData.push({ category: categories[catKey].title, item: categories[catKey].items[idx].name, score: s.value }); });
                } else averages[categories[catKey].title] = 0;
            });

            if (activeData.length < 3) { alert("â— è©•é‡é …ç›®ä¸è¶³ï¼šè«‹è‡³å°‘é€£é»å…©ä¸‹é–‹å•Ÿ 3 å€‹æŒ‡æ¨™ã€‚"); return; }
            document.getElementById('ai-modal').classList.remove('hidden');
            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('ai-content-wrapper').classList.add('hidden');

            const ctx = document.getElementById('radarChart').getContext('2d');
            if (radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.values(categories).map(c => c.title),
                    datasets: [{ label: 'å‘åº¦å¾—åˆ†', data: Object.values(categories).map(c => averages[c.title]), fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgb(59, 130, 246)', pointBackgroundColor: 'rgb(59, 130, 246)' }]
                },
                options: { scales: { r: { min: 0, max: 5, ticks: { stepSize: 1, display: false }, grid: { color: currentTheme === 'night' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }, pointLabels: { color: currentTheme === 'night' ? '#94a3b8' : '#64748b', font: { size: 10 } } } }, plugins: { legend: { display: false } } }
            });

            const systemPrompt = `ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åœ‹ä¸­å°å°å¸«ã€‚å­¸ç”Ÿè™•æ–¼ï¼š${selectedGrade}ã€‚è«‹æ ¹æ“šæä¾›çš„è©•é‡æ•¸æ“šæ’°å¯«äº”ç¨®é¢¨æ ¼è©•èªï¼ˆwarm, objective, future, short_positive, short_neutralï¼‰ã€‚æ¯ä¸€é …é¢¨æ ¼éƒ½å¿…é ˆç”¢å‡ºå…§å®¹ã€‚åš´ç¦å‡ºç¾å…·é«”çš„åˆ†æ•¸æ•¸å­—ã€‚å‹™å¿…ä»¥ç¹é«”ä¸­æ–‡æ’°å¯«æµæš¢æ®µè½ã€‚æ¨¡å‹ï¼šgemini-2.5-flash-preview-09-2025`;

            const callAPIWithRetry = async (retryCount = 0) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${storedApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: JSON.stringify(activeData) }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        warm: { type: "STRING" }, objective: { type: "STRING" }, future: { type: "STRING" }, short_positive: { type: "STRING" }, short_neutral: { type: "STRING" }
                                    },
                                    required: ["warm", "objective", "future", "short_positive", "short_neutral"]
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || "ç¶²è·¯éŒ¯èª¤");
                    }

                    const data = await response.json();
                    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!resultText) throw new Error("AI å›å‚³å…§å®¹ç‚ºç©º");
                    renderAIComments(JSON.parse(resultText));
                } catch (error) {
                    if (retryCount < 5) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        document.getElementById('loading-status-text').innerText = `é€£ç·šç¨æ…¢ï¼Œæ­£åœ¨å˜—è©¦é‡æ–°ç™¼é€ (${retryCount + 1}/5)...`;
                        await new Promise(res => setTimeout(res, delay));
                        return callAPIWithRetry(retryCount + 1);
                    }
                    document.getElementById('ai-comments-grid').innerHTML = `<p class="text-red-500 text-center col-span-2 p-10 bg-red-50 rounded-xl">AI åˆ†æå¤±æ•—ã€‚åŸå› ï¼š${error.message}ã€‚è«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºä¸”è©•é‡é …ç›®å……è¶³ã€‚</p>`;
                    document.getElementById('ai-loading').classList.add('hidden');
                    document.getElementById('ai-content-wrapper').classList.remove('hidden');
                }
            };
            await callAPIWithRetry();
        }

        function renderAIComments(c) {
            const grid = document.getElementById('ai-comments-grid');
            const styles = [
                { id: 'warm', label: 'â˜€ï¸ æº«æš–æ¿€å‹µå‹', text: c.warm, bg: 'bg-pink-500/5', border: 'border-pink-500/20', textCol: 'text-pink-600' },
                { id: 'objective', label: 'ğŸ“Š å®¢è§€åˆ†æå‹', text: c.objective, bg: 'bg-blue-500/5', border: 'border-blue-500/20', textCol: 'text-blue-600' },
                { id: 'future', label: 'ğŸš€ æœªä¾†å¼•å°å‹', text: c.future, bg: 'bg-emerald-500/5', border: 'border-emerald-500/20', textCol: 'text-emerald-600', span: true },
                { id: 'sp', label: 'âœ¨ ç²¾ç°¡é¼“å‹µ', text: c.short_positive, bg: 'bg-orange-500/5', border: 'border-orange-500/20', textCol: 'text-orange-600' },
                { id: 'sn', label: 'ğŸ“ ç²¾ç°¡å‹™å¯¦', text: c.short_neutral, bg: 'bg-slate-500/5', border: 'border-slate-500/20', textCol: 'text-slate-600' }
            ];
            grid.innerHTML = styles.map(s => `<div class="p-5 ${s.bg} border ${s.border} rounded-2xl relative ${s.span ? 'md:col-span-2' : ''}"><div class="flex justify-between items-center mb-3"><h4 class="font-bold ${s.textCol} text-sm">${s.label}</h4><button onclick="copyText('txt-${s.id}', this)" class="text-[10px] bg-white text-slate-800 border border-slate-200 px-3 py-1 rounded-lg shadow-sm hover:bg-slate-50 transition font-bold">ä¸€éµè¤‡è£½</button></div><p id="txt-${s.id}" class="text-[11px] leading-relaxed">${s.text}</p></div>`).join('');
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-content-wrapper').classList.remove('hidden');
        }

        function copyText(id, btn) {
            const text = document.getElementById(id).innerText;
            const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select();
            try {
                document.execCommand('copy'); const original = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²è¤‡è£½'; btn.className = "text-[10px] bg-green-600 text-white px-3 py-1 rounded-lg shadow-sm font-bold";
                setTimeout(() => { btn.innerHTML = original; btn.className = "text-[10px] bg-white text-slate-800 border border-slate-200 px-3 py-1 rounded-lg shadow-sm hover:bg-slate-50 transition font-bold"; }, 2000);
            } catch (err) { } document.body.removeChild(textArea);
        }

        function closeModal() { document.getElementById('ai-modal').classList.add('hidden'); }
        window.onload = init;
    </script>
</body>

</html>