<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧網頁索引系統 (Pro)</title>
    <!-- 引入 Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome 圖示 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#0f172a',
                        accent: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 拖放區域的高亮效果 */
        .drag-active {
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }

        .drag-overlay {
            pointer-events: none;
        }

        /* Manual Styles (Merged) */
        .manual-scroll {
            scroll-behavior: smooth;
        }

        .prose h3 {
            color: #0f172a;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .prose p {
            color: #475569;
            line-height: 1.75;
            margin-bottom: 1rem;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            color: #475569;
            margin-bottom: 1rem;
        }

        .prose li {
            margin-bottom: 0.5rem;
        }

        .sidebar-link {
            display: block;
            padding: 0.5rem 1rem;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            border-left-color: #3b82f6;
            color: #3b82f6;
            background-color: #f8fafc;
        }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen flex flex-col transition-colors duration-200" id="dropZone">

    <!-- ==================================================================================== -->
    <!--  UI PART 1: MAIN APPLICATION                                                         -->
    <!-- ==================================================================================== -->

    <!-- Drag Overlay (Hidden by default) -->
    <div id="dragOverlay"
        class="fixed inset-0 z-[100] hidden flex-col items-center justify-center bg-blue-50/90 backdrop-blur-sm drag-overlay">
        <i class="fa-solid fa-folder-open text-6xl text-accent mb-4 animate-bounce"></i>
        <h2 class="text-2xl font-bold text-slate-700">釋放以讀取資料夾</h2>
        <p class="text-slate-500 mt-2">放開滑鼠即可開始掃描</p>
    </div>

    <!-- Navbar -->
    <nav class="bg-brand text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-network-wired text-accent text-xl"></i>
                <h1 class="text-lg font-bold tracking-wide">HTML Directory Viewer <span
                        class="text-xs opacity-50 font-normal border border-slate-600 px-1 rounded ml-1">Pure
                        Frontend</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleManual()"
                    class="text-sm text-slate-300 hover:text-white transition-colors flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-lg hover:bg-white/20">
                    <i class="fa-solid fa-book"></i> 使用說明
                </button>
                <button onclick="saveViewer()"
                    class="text-sm text-slate-300 hover:text-white transition-colors flex items-center gap-1"
                    title="將目前的列表另存為獨立的網頁檔">
                    <i class="fa-solid fa-floppy-disk"></i> 另存索引
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 flex-grow max-w-7xl">

        <!-- Controls -->
        <div class="glass-panel rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button id="btnSmartScan" onclick="handleSmartScan()"
                        class="bg-accent hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow transition-all flex items-center gap-2 font-medium">
                        <i class="fa-solid fa-folder-tree"></i> <span id="btnSmartText">掃描目錄</span>
                    </button>
                    <button id="btnLocal" onclick="selectLocalDirectory()"
                        class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 px-4 py-2 rounded-lg shadow-sm transition-all flex items-center gap-2">
                        <i class="fa-regular fa-folder-open"></i> 選擇其他資料夾
                    </button>
                </div>

                <!-- Search & Status -->
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                    <div class="relative w-full sm:w-64">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="過濾標題或檔名..."
                            class="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-accent focus:border-transparent outline-none text-sm">
                    </div>
                    <div id="statusTag"
                        class="hidden px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-check-circle"></i> <span id="statusText">Ready</span>
                    </div>
                </div>
            </div>

            <!-- Hint Text -->
            <div class="mt-4 flex flex-col gap-1">
                <p class="text-xs text-slate-500 leading-relaxed flex items-center gap-2">
                    <i class="fa-solid fa-circle-info text-accent"></i>
                    <span>
                        <strong>狀態說明：</strong> <span id="envStatus">正在偵測執行環境...</span>
                    </span>
                </p>
                <p id="localHint" class="text-xs text-orange-500 pl-6 hidden">
                    <i class="fa-solid fa-lightbulb mr-1"></i>
                    <strong>專家提示：</strong> 因瀏覽器安全限制無法自動選取目前目錄，建議直接將<strong>資料夾拖入此視窗</strong>即可快速讀取。
                </p>
                <p id="pathHint" class="text-xs text-slate-400 pl-6 font-mono hidden"></p>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden min-h-[400px] relative">

            <!-- Loading Overlay -->
            <div id="loadingOverlay"
                class="hidden absolute inset-0 bg-white/80 z-10 flex flex-col items-center justify-center">
                <div class="w-10 h-10 border-4 border-slate-200 border-t-accent rounded-full loading-spinner mb-3">
                </div>
                <p class="text-slate-500 font-medium" id="loadingText">正在分析檔案...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300">
                <i class="fa-solid fa-folder-open text-6xl mb-4 opacity-50"></i>
                <p class="text-lg font-medium">尚未載入任何檔案</p>
                <p class="text-sm mt-2" id="emptyHintText">點擊左上角按鈕開始掃描</p>
            </div>

            <div class="overflow-x-auto h-full">
                <table class="w-full text-left border-collapse hidden" id="mainTable">
                    <thead class="bg-slate-50 sticky top-0 z-0">
                        <tr
                            class="text-xs font-semibold tracking-wide text-slate-500 uppercase border-b border-slate-200">
                            <th class="p-4 cursor-pointer hover:bg-slate-100 group w-4/12" onclick="sortTable('title')">
                                網頁標題 (Title) <i
                                    class="fa-solid fa-sort ml-1 text-slate-300 group-hover:text-slate-500"></i>
                            </th>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 group w-3/12"
                                onclick="sortTable('filename')">
                                檔名 <i class="fa-solid fa-sort ml-1 text-slate-300 group-hover:text-slate-500"></i>
                            </th>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 group w-2/12" onclick="sortTable('mtime')">
                                修改日期 <i class="fa-solid fa-sort ml-1 text-slate-300 group-hover:text-slate-500"></i>
                            </th>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 group w-1/12" onclick="sortTable('size')">
                                大小 <i class="fa-solid fa-sort ml-1 text-slate-300 group-hover:text-slate-500"></i>
                            </th>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 group w-2/12 text-center">
                                動作
                            </th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody" class="divide-y divide-slate-100 text-sm text-slate-700">
                        <!-- JS renders rows here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 flex justify-between items-center text-xs text-slate-400">
            <span id="fileCount">0 檔案</span>
            <span>Pure Frontend Scanner v2.1</span>
        </div>
    </main>

    <!-- ==================================================================================== -->
    <!--  UI PART 2: EMBEDDED MANUAL OVERLAY                                                  -->
    <!-- ==================================================================================== -->

    <div id="manualOverlay" class="fixed inset-0 z-[200] bg-slate-50 overflow-y-auto hidden manual-scroll">

        <!-- Manual Header -->
        <header class="bg-brand text-white shadow-lg sticky top-0 z-[210]">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-book-open text-accent text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold tracking-wide">智慧網頁索引系統</h1>
                        <p class="text-xs text-slate-400">Technical Documentation & User Manual</p>
                    </div>
                </div>
                <!-- Close Button -->
                <button onclick="toggleManual()"
                    class="inline-flex items-center gap-2 bg-red-500/20 hover:bg-red-500/40 border border-red-500/30 px-4 py-2 rounded-lg transition text-sm font-medium text-white">
                    <i class="fa-solid fa-xmark"></i> 關閉說明
                </button>
            </div>
        </header>

        <div class="container mx-auto px-6 py-8 flex flex-col md:flex-row gap-8">

            <!-- Sidebar Navigation -->
            <aside class="md:w-64 flex-shrink-0">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sticky top-24">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-4">目錄索引</h2>
                    <nav class="space-y-1 text-sm">
                        <a href="#philosophy" class="sidebar-link">設計理念 (Philosophy)</a>
                        <a href="#architecture" class="sidebar-link">核心架構 (Architecture)</a>
                        <a href="#usage" class="sidebar-link">詳細使用說明 (Usage)</a>
                        <a href="#export" class="sidebar-link">靜態匯出功能 (Export)</a>
                        <a href="#limitations" class="sidebar-link">技術限制與排除 (Limits)</a>
                    </nav>
                </div>
            </aside>

            <!-- Manual Content -->
            <div class="flex-grow max-w-4xl">

                <!-- Section 1: Design Philosophy -->
                <section id="philosophy"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-8 scroll-mt-24">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i
                                class="fa-solid fa-lightbulb text-xl"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800">設計理念</h2>
                    </div>
                    <div class="prose">
                        <p>
                            在現代 Web 開發環境中，快速預覽與管理靜態 HTML 資產往往依賴繁重的後端服務（如 Python Flask,
                            Node.js）。本系統採取<strong>「去中心化」</strong>與<strong>「無伺服器
                                (Serverless)」</strong>的前瞻性觀點，重新定義了檔案索引工具的輕量化標準。
                        </p>
                        <div class="grid md:grid-cols-2 gap-6 mt-6">
                            <div class="bg-slate-50 p-5 rounded-lg border border-slate-100">
                                <h4 class="font-bold text-slate-700 mb-2"><i
                                        class="fa-solid fa-cube text-accent mr-2"></i>單檔交付 (Single-File Delivery)</h4>
                                <p class="text-sm">零依賴、零安裝。整個系統封裝於單一 HTML 檔案中，無需設定 Python 環境或 Node
                                    modules，即拷即用，極大化了部署的靈活性。</p>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-lg border border-slate-100">
                                <h4 class="font-bold text-slate-700 mb-2"><i
                                        class="fa-solid fa-microchip text-accent mr-2"></i>客戶端運算 (Client-Side Computing)
                                </h4>
                                <p class="text-sm">利用現代瀏覽器的算力，所有的解析、排序、過濾皆在前端完成。這確保了操作的即時性，並消除了伺服器的運算負擔。</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Architecture -->
                <section id="architecture"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-8 scroll-mt-24">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i
                                class="fa-solid fa-network-wired text-xl"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800">核心架構：雙模引擎</h2>
                    </div>
                    <div class="prose">
                        <p>本系統搭載了獨創的環境感知引擎，能夠自動偵測執行環境並切換底層邏輯：</p>

                        <div class="relative pl-8 border-l-2 border-slate-200 space-y-8 my-6">
                            <div class="relative">
                                <span
                                    class="absolute -left-[41px] bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs"><i
                                        class="fa-solid fa-globe"></i></span>
                                <h3 class="!mt-0">Web Server 模式 (HTTP/HTTPS)</h3>
                                <p>當偵測到透過網頁伺服器存取時，系統會自動發送 <code>fetch</code> 請求讀取目錄列表 (Directory Listing)，並並發解析所有 HTML
                                    檔案的 <code>&lt;title&gt;</code> 與 HTTP Headers。</p>
                            </div>
                            <div class="relative">
                                <span
                                    class="absolute -left-[41px] bg-orange-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs"><i
                                        class="fa-solid fa-folder"></i></span>
                                <h3 class="!mt-0">Local File 模式 (file://)</h3>
                                <p>當偵測到本機執行時，系統會啟用 <strong>File System Access API</strong>。透過拖放 (Drag & Drop)
                                    或授權按鈕，直接讀取硬碟內容，並生成 Blob URL 以突破瀏覽器沙箱限制，實現本機預覽。</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 3: Usage -->
                <section id="usage" class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-8 scroll-mt-24">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i
                                class="fa-solid fa-toggle-on text-xl"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800">詳細使用說明</h2>
                    </div>

                    <div class="space-y-6">
                        <!-- Step 1 -->
                        <div class="border-b border-slate-100 pb-6">
                            <h3 class="text-lg font-bold text-brand mb-3">1. 快速部署</h3>
                            <p class="text-slate-600 text-sm">將 <code>viewer.html</code> 複製到您存放多個 HTML 檔案的資料夾中即可。</p>
                        </div>

                        <!-- Step 2 -->
                        <div class="border-b border-slate-100 pb-6">
                            <h3 class="text-lg font-bold text-brand mb-3">2. 啟動與掃描</h3>
                            <ul class="list-disc pl-5 text-sm text-slate-600 space-y-2">
                                <li><strong>在本機使用：</strong> 直接雙擊開啟
                                    <code>viewer.html</code>。瀏覽器開啟後，將目前的資料夾<strong>拖曳進網頁視窗</strong>，即可瞬間載入列表。</li>
                                <li><strong>在伺服器使用：</strong> 透過瀏覽器訪問網址 (例如
                                    <code>http://localhost:8000/viewer.html</code>)，系統將會自動執行掃描。</li>
                            </ul>
                        </div>

                        <!-- Step 3 -->
                        <div class="border-b border-slate-100 pb-6">
                            <h3 class="text-lg font-bold text-brand mb-3">3. 列表操作</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                                <div class="flex items-start gap-2">
                                    <i class="fa-solid fa-sort text-slate-400 mt-1"></i>
                                    <div><strong>排序：</strong>點擊表頭 (標題、檔名、日期、大小) 可切換升冪/降冪排序。</div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <i class="fa-solid fa-filter text-slate-400 mt-1"></i>
                                    <div><strong>過濾：</strong>在右上角搜尋框輸入關鍵字，即時篩選符合的檔案。</div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <i class="fa-solid fa-external-link-alt text-slate-400 mt-1"></i>
                                    <div><strong>開啟：</strong>點擊標題或「開啟」按鈕，會以新分頁開啟該網頁。</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 4: Export -->
                <section id="export"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-8 scroll-mt-24">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-green-100 text-green-600 rounded-lg"><i
                                class="fa-solid fa-file-export text-xl"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800">靜態匯出功能</h2>
                    </div>
                    <div class="prose bg-green-50/50 p-6 rounded-lg border border-green-100">
                        <p class="mb-4">
                            此功能是為了解決「分享」痛點而設計。當您整理完一份文件列表後，可以使用<strong>「另存網頁索引檔」</strong>功能。
                        </p>
                        <ul class="text-sm">
                            <li><strong>純淨化輸出：</strong> 匯出的 HTML 檔案會移除所有的掃描邏輯、授權按鈕與拖放功能，只保留純粹的檔案列表與搜尋功能。</li>
                            <li><strong>相對路徑轉換：</strong> 系統會自動將本機的 Blob URL 轉換為相對路徑 (Relative Path)。這意味著您可以將匯出的 HTML
                                檔與其他文件一起打包 (Zip) 傳送給他人，對方解壓縮後連結依然有效。</li>
                            <li><strong>自訂標題：</strong> 匯出時可輸入自訂標題 (例如「2025 年度專案報告索引」)，提升專業度。</li>
                        </ul>
                    </div>
                </section>

                <!-- Section 5: Limitations -->
                <section id="limitations"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 mb-8 scroll-mt-24">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-red-100 text-red-600 rounded-lg"><i
                                class="fa-solid fa-triangle-exclamation text-xl"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800">技術限制與注意事項</h2>
                    </div>

                    <div class="space-y-4">
                        <div class="flex gap-4 items-start">
                            <div class="w-8 flex-shrink-0 text-center text-slate-400 font-bold">01</div>
                            <div>
                                <h4 class="font-bold text-slate-700">瀏覽器安全性沙箱 (Security Sandbox)</h4>
                                <p class="text-sm text-slate-600">
                                    現代瀏覽器嚴格禁止網頁在未經授權的情況下讀取本機檔案路徑。因此，在本機模式下，<strong>無法做到「全自動靜默掃描」</strong>。必須透過「拖放資料夾」或「點擊按鈕選取」這類使用者主動行為
                                    (User Gesture) 來取得權限。
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                            <div class="w-8 flex-shrink-0 text-center text-slate-400 font-bold">02</div>
                            <div>
                                <h4 class="font-bold text-slate-700">瀏覽器相容性</h4>
                                <p class="text-sm text-slate-600">
                                    本系統的「本機掃描」依賴 <strong>File System Access API</strong>，此技術主要支援基於 Chromium 核心的瀏覽器
                                    (<strong>Google Chrome, Microsoft Edge, Opera</strong>)。Firefox 與 Safari
                                    目前僅支援部分的傳統模式，建議使用 Chrome/Edge 以獲得最佳體驗。
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                            <div class="w-8 flex-shrink-0 text-center text-slate-400 font-bold">03</div>
                            <div>
                                <h4 class="font-bold text-slate-700">伺服器目錄列表設定</h4>
                                <p class="text-sm text-slate-600">
                                    在 Web Server 模式下，自動掃描依賴伺服器回傳的預設目錄頁面 (Directory Listing)。若您的伺服器 (Apache/Nginx/IIS)
                                    關閉了此功能，或目錄下存在 <code>index.html</code> (會覆蓋目錄列表)，則自動掃描將會失敗。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </div>

        <footer class="bg-white border-t border-slate-200 mt-12 py-8">
            <div class="container mx-auto px-6 text-center">
                <p class="text-slate-500 text-sm">Smart Directory Viewer System • Designed for Efficiency</p>
                <p class="text-slate-400 text-xs mt-2">© 2025 Machine Learning & Frontend Engineering Lab</p>
            </div>
        </footer>
    </div>

    <!-- ==================================================================================== -->
    <!--  JS LOGIC                                                                            -->
    <!-- ==================================================================================== -->

    <script>
        // --- UI Interactions ---
        function toggleManual() {
            const overlay = document.getElementById('manualOverlay');
            overlay.classList.toggle('hidden');
            if (!overlay.classList.contains('hidden')) {
                // When opening manual, scroll sidebar spy logic works
                window.dispatchEvent(new Event('scroll'));
            }
        }

        // --- Manual Scroll Spy ---
        const manualOverlay = document.getElementById('manualOverlay');
        manualOverlay.addEventListener('scroll', () => {
            const sections = manualOverlay.querySelectorAll('section');
            const navLinks = manualOverlay.querySelectorAll('.sidebar-link');

            let current = '';
            // Use scroll position relative to the overlay
            const overlayTop = manualOverlay.scrollTop;

            sections.forEach(section => {
                // Simple offset calculation
                if (overlayTop >= section.offsetTop - 150) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').includes(current)) {
                    link.classList.add('active');
                }
            });
        });

        // --- Main Application Logic ---
        // 全域檔案列表資料
        let globalFiles = [];
        let sortDirection = 1; // 1: asc, -1: desc
        let isSnapshotMode = false; // 標記是否為快照模式

        // 核心功能: 智慧掃描入口
        async function handleSmartScan() {
            if (window.location.protocol.startsWith('http')) {
                await scanServerIndex();
            } else {
                await selectLocalDirectory();
            }
        }

        // 功能 1: 檔案系統存取 API (本機/授權模式)
        async function selectLocalDirectory(draggedHandle = null) {
            if (!('showDirectoryPicker' in window) && !draggedHandle) {
                alert("您的瀏覽器不支援 File System Access API (請使用 Chrome, Edge 或 Opera)。");
                return;
            }

            try {
                let dirHandle;

                if (draggedHandle) {
                    dirHandle = draggedHandle;
                } else {
                    dirHandle = await window.showDirectoryPicker({
                        id: 'html-viewer-cwd',
                        mode: 'read'
                    });
                }

                setLoading(true, "正在讀取並分析本機檔案...");
                globalFiles = [];

                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file' && (entry.name.endsWith('.html') || entry.name.endsWith('.htm'))) {

                        const currentFilename = window.location.pathname.split('/').pop();
                        if (entry.name === currentFilename || entry.name === 'index.html') continue;

                        const file = await entry.getFile();
                        const chunk = file.slice(0, 4096);
                        const text = await chunk.text();
                        const title = extractTitle(text);

                        const blobUrl = URL.createObjectURL(file);

                        globalFiles.push({
                            filename: entry.name,
                            title: title || entry.name,
                            hasTitle: !!title,
                            size: file.size,
                            mtime: file.lastModified, // Timestamp
                            mtimeStr: new Date(file.lastModified).toLocaleString(),
                            url: blobUrl, // 使用 Blob URL
                            isLocal: true,
                            handle: entry
                        });
                    }
                }
                isSnapshotMode = false;
                renderTable();
                setLoading(false);
                updateStatus(`已授權並讀取 ${globalFiles.length} 個檔案`);
            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log("使用者取消了目錄選取");
                    return;
                }
                console.error(err);
                setLoading(false);
                alert("讀取資料夾失敗: " + err.message);
            }
        }

        // 新增功能: 拖放支援 (Drag & Drop)
        const dropZone = document.getElementById('dropZone');
        const dragOverlay = document.getElementById('dragOverlay');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('dragenter', () => {
            dropZone.classList.add('drag-active');
            dragOverlay.classList.remove('hidden');
            dragOverlay.classList.add('flex');
        }, false);

        dropZone.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null) {
                dropZone.classList.remove('drag-active');
                dragOverlay.classList.add('hidden');
                dragOverlay.classList.remove('flex');
            }
        }, false);

        dragOverlay.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null) {
                dropZone.classList.remove('drag-active');
                dragOverlay.classList.add('hidden');
                dragOverlay.classList.remove('flex');
            }
        });

        dropZone.addEventListener('drop', async (e) => {
            dropZone.classList.remove('drag-active');
            dragOverlay.classList.add('hidden');
            dragOverlay.classList.remove('flex');

            const items = [...e.dataTransfer.items];
            const item = items[0];

            if (item && item.kind === 'file') {
                if (item.getAsFileSystemHandle) {
                    const handle = await item.getAsFileSystemHandle();
                    if (handle.kind === 'directory') {
                        await selectLocalDirectory(handle);
                    } else {
                        alert("請拖入一個「資料夾」，而不是單一檔案。");
                    }
                } else {
                    alert("您的瀏覽器不支援拖放目錄讀取 (需要 Chrome 86+ 或 Edge)。");
                }
            }
        }, false);


        // 功能 2: 伺服器索引解析 (Server Mode)
        async function scanServerIndex() {
            setLoading(true, "正在掃描伺服器目錄...");
            globalFiles = [];

            try {
                const response = await fetch('./');
                if (!response.ok) throw new Error("無法讀取目錄 (Server responded " + response.status + ")");

                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'));

                const currentFilename = window.location.pathname.split('/').pop() || 'viewer.html';

                const htmlLinks = links
                    .map(a => a.getAttribute('href'))
                    .filter(href => {
                        if (!href) return false;
                        const lower = href.toLowerCase();
                        if (!lower.endsWith('.html') && !lower.endsWith('.htm')) return false;
                        if (href.includes(currentFilename)) return false;
                        if (href.includes('viewer.html')) return false;
                        if (lower === 'index.html') return false;
                        return true;
                    });

                let processedCount = 0;
                setLoading(true, `正在分析 0/${htmlLinks.length} 個檔案...`);

                const filePromises = htmlLinks.map(async (filename) => {
                    try {
                        const fRes = await fetch(filename);
                        const fText = await fRes.text();
                        const title = extractTitle(fText);

                        const lastModifiedHeader = fRes.headers.get('Last-Modified');
                        const mtime = lastModifiedHeader ? new Date(lastModifiedHeader).getTime() : 0;
                        const mtimeStr = lastModifiedHeader ? new Date(lastModifiedHeader).toLocaleString() : 'N/A';

                        processedCount++;
                        updateLoadingText(`正在分析 ${processedCount}/${htmlLinks.length} 個檔案...`);

                        return {
                            filename: decodeURIComponent(filename),
                            title: title || decodeURIComponent(filename),
                            hasTitle: !!title,
                            size: 0,
                            mtime: mtime,
                            mtimeStr: mtimeStr,
                            url: filename,
                            isLocal: false
                        };
                    } catch (e) {
                        console.warn(`Failed to parse ${filename}`, e);
                        return null;
                    }
                });

                const results = await Promise.all(filePromises);
                globalFiles = results.filter(f => f !== null);

                if (globalFiles.length === 0) {
                    alert("掃描完成，但未找到任何 HTML 檔案。\n\n可能原因：\n1. 伺服器未開啟「目錄列表 (Directory Listing)」功能。\n2. 目錄下存在 index.html 檔案蓋過了列表。\n3. 您所在的目錄確實沒有其他 .html 檔。");
                }

                isSnapshotMode = false;
                renderTable();
                setLoading(false);
                updateStatus(`已索引 ${globalFiles.length} 個伺服器檔案`);

            } catch (err) {
                setLoading(false);
                console.log("Server scan failed:", err);
                alert("伺服器掃描失敗。\n\n請確認：\n1. 您是透過 HTTP/HTTPS 存取。\n2. 伺服器已開啟目錄列表功能 (Directory Listing)。");
            }
        }

        // 共用工具函式
        function extractTitle(htmlContent) {
            const match = htmlContent.match(/<title[^>]*>([^<]+)<\/title>/i);
            return match ? match[1].trim() : null;
        }

        function formatSize(bytes) {
            if (bytes === 0) return 'N/A';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        function saveViewer() {
            if (globalFiles.length === 0) {
                alert("目前沒有任何檔案資料，無法匯出。");
                return;
            }

            const userTitle = prompt("請輸入匯出網頁的標題：", "網頁索引檔");
            if (userTitle === null) return;

            const safeFiles = globalFiles.map(f => {
                const { handle, ...rest } = f;
                if (rest.isLocal) {
                    rest.url = rest.filename;
                }
                return rest;
            });

            const exportDate = new Date().toLocaleString();

            const staticHTML = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${userTitle}</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { colors: { brand: '#0f172a', accent: '#3b82f6' } } }
        }
    <\/script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-list-ul text-accent mr-2"></i>${userTitle}</h1>
                <p class="text-slate-500 text-sm mt-1">產生時間：${exportDate} • 共 ${safeFiles.length} 個檔案</p>
            </div>
            <div class="relative w-full md:w-64">
                <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="搜尋標題或檔名..." 
                    class="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-accent outline-none text-sm">
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-xs font-semibold uppercase text-slate-500 border-b border-slate-200">
                        <tr>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 w-4/12" onclick="sortTable('title')">標題 <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 w-3/12" onclick="sortTable('filename')">檔名 <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 w-2/12" onclick="sortTable('mtime')">修改日期 <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="p-4 cursor-pointer hover:bg-slate-100 w-1/12" onclick="sortTable('size')">大小 <i class="fa-solid fa-sort ml-1"></i></th>
                            <th class="p-4 text-center w-2/12">動作</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody" class="divide-y divide-slate-100 text-sm text-slate-700">
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="hidden p-12 text-center text-slate-400">
                <p>沒有符合搜尋條件的檔案</p>
            </div>
        </div>
        
        <footer class="mt-8 text-center text-xs text-slate-400">
            Generated by Pure Frontend Scanner
        </footer>
    </div>

    <script>
        const files = ${JSON.stringify(safeFiles)};
        let sortDirection = 1;

        function formatSize(bytes) {
            if (bytes === 0) return 'N/A';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        function renderTable(data = files) {
            const tbody = document.getElementById('fileListBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            data.forEach(file => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = \`
                    <td class="p-4 font-medium text-slate-800">
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full \${file.hasTitle ? 'bg-green-500' : 'bg-slate-300'} mr-3 flex-shrink-0"></span>
                            <a href="\${file.url}" target="_blank" class="hover:text-accent hover:underline block truncate" title="\${file.title}">
                                \${file.title}
                            </a>
                        </div>
                    </td>
                    <td class="p-4 font-mono text-slate-500 text-xs">\${file.filename}</td>
                    <td class="p-4 text-slate-500 text-xs whitespace-nowrap">\${file.mtimeStr}</td>
                    <td class="p-4 text-slate-500 text-xs whitespace-nowrap">\${formatSize(file.size)}</td>
                    <td class="p-4 text-center">
                        <a href="\${file.url}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 bg-accent text-white text-xs font-medium rounded hover:bg-blue-600 transition shadow-sm whitespace-nowrap">
                            <i class="fa-solid fa-external-link-alt"></i> 開啟
                        </a>
                    </td>
                \`;
                tbody.appendChild(tr);
            });
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = files.filter(f => 
                f.title.toLowerCase().includes(term) || 
                f.filename.toLowerCase().includes(term)
            );
            renderTable(filtered);
        }

        function sortTable(key) {
            sortDirection *= -1;
            const sorted = [...files].sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return -1 * sortDirection;
                if (valA > valB) return 1 * sortDirection;
                return 0;
            });
            renderTable(sorted);
        }

        // Init
        renderTable();
    <\/script>
</body>
</html>`;

            const blob = new Blob([staticHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `directory_index_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();

            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function setLoading(isLoading, text = "") {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');

            if (isLoading) {
                overlay.classList.remove('hidden');
                loadingText.innerText = text;
            } else {
                overlay.classList.add('hidden');
            }
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').innerText = text;
        }

        function updateStatus(msg) {
            const tag = document.getElementById('statusTag');
            const text = document.getElementById('statusText');
            tag.classList.remove('hidden');
            tag.classList.add('flex');
            text.innerText = msg;
            document.getElementById('fileCount').innerText = `${globalFiles.length} 檔案`;
        }

        // UI 渲染與互動
        function renderTable() {
            const tbody = document.getElementById('fileListBody');
            const table = document.getElementById('mainTable');
            const empty = document.getElementById('emptyState');

            tbody.innerHTML = '';

            if (globalFiles.length === 0) {
                table.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            table.classList.remove('hidden');
            empty.classList.add('hidden');

            globalFiles.forEach(file => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";

                // Title Column
                const tdTitle = document.createElement('td');
                tdTitle.className = "p-4 font-medium text-slate-800";
                tdTitle.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-2 h-2 rounded-full ${file.hasTitle ? 'bg-green-500' : 'bg-slate-300'} mr-3 flex-shrink-0"></span>
                        <a href="${file.url}" target="_blank" class="hover:text-accent hover:underline transition-colors block truncate" title="${file.title}">
                            ${file.title}
                        </a>
                    </div>
                `;

                // Filename Column
                const tdName = document.createElement('td');
                tdName.className = "p-4 font-mono text-slate-500 text-xs";
                tdName.innerText = file.filename;

                // Date Column
                const tdDate = document.createElement('td');
                tdDate.className = "p-4 text-slate-500 text-xs whitespace-nowrap";
                tdDate.innerText = file.mtimeStr;

                // Size Column
                const tdSize = document.createElement('td');
                tdSize.className = "p-4 text-slate-500 text-xs whitespace-nowrap";
                tdSize.innerText = formatSize(file.size);

                // Action Column
                const tdAction = document.createElement('td');
                tdAction.className = "p-4 text-center";

                tdAction.innerHTML = `
                    <a href="${file.url}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 bg-accent text-white text-xs font-medium rounded hover:bg-blue-600 transition shadow-sm whitespace-nowrap">
                        <i class="fa-solid fa-external-link-alt"></i> 開啟
                    </a>
                `;

                tr.appendChild(tdTitle);
                tr.appendChild(tdName);
                tr.appendChild(tdDate);
                tr.appendChild(tdSize);
                tr.appendChild(tdAction);
                tbody.appendChild(tr);
            });
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#fileListBody tr');

            rows.forEach(row => {
                const title = row.children[0].innerText.toLowerCase();
                const name = row.children[1].innerText.toLowerCase();
                if (title.includes(term) || name.includes(term)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        function sortTable(key) {
            sortDirection *= -1; // Toggle direction

            globalFiles.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return -1 * sortDirection;
                if (valA > valB) return 1 * sortDirection;
                return 0;
            });
            renderTable();
        }

        // 初始化：環境偵測與自動啟動
        window.addEventListener('DOMContentLoaded', () => {
            const envStatus = document.getElementById('envStatus');
            const btnSmartText = document.getElementById('btnSmartText');
            const emptyHint = document.getElementById('emptyHintText');
            const pathHint = document.getElementById('pathHint');
            const localHint = document.getElementById('localHint');

            // 0. 優先檢查是否為「快照還原模式」
            const snapshotScript = document.getElementById('snapshot-data');
            if (snapshotScript) {
                try {
                    globalFiles = JSON.parse(snapshotScript.textContent);
                    isSnapshotMode = true; // 標記為快照

                    envStatus.innerHTML = `<span class="text-purple-600 font-medium"><i class="fa-solid fa-floppy-disk"></i> 靜態索引檔模式</span>`;
                    btnSmartText.innerText = "重新掃描 (清除狀態)";
                    emptyHint.innerText = "已載入靜態索引資料";

                    renderTable();
                    updateStatus(`已還原 ${globalFiles.length} 筆資料`);
                    return; // 成功還原後，直接結束初始化，跳過自動掃描
                } catch (e) {
                    console.error("快照還原失敗", e);
                }
            }

            // 顯示目前路徑 (輔助資訊)
            try {
                const path = window.location.pathname;
                if (path && path !== '/') {
                    pathHint.innerText = `目前位置: ${decodeURIComponent(path)}`;
                    pathHint.classList.remove('hidden');
                }
            } catch (e) { }

            if (window.location.protocol.startsWith('http')) {
                // HTTP 環境：自動執行
                envStatus.innerHTML = `<span class="text-green-600 font-medium">Web Server 環境</span> (支援自動掃描)`;
                btnSmartText.innerText = "重新掃描目錄";
                scanServerIndex();
            } else {
                // File 環境：等待手動授權 (無法自動)
                envStatus.innerHTML = `<span class="text-orange-500 font-medium">本地檔案 (File) 環境</span>`;
                btnSmartText.innerText = "授權並掃描目錄";
                emptyHint.innerText = "請點擊「授權並掃描」選擇目前資料夾，或直接將資料夾拖入此處";

                localHint.classList.remove('hidden');
            }
        });

    </script>
</body>

</html>